<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>Ehsan&#39;s Blog</title>
<link>https://ehsanmkermani.com/posts.html</link>
<atom:link href="https://ehsanmkermani.com/posts.xml" rel="self" type="application/rss+xml"/>
<description></description>
<generator>quarto-1.8.26</generator>
<lastBuildDate>Fri, 08 Dec 2023 00:00:00 GMT</lastBuildDate>
<item>
  <title>Modal Labs Deep Dive</title>
  <dc:creator>Ehsan M. Kermani</dc:creator>
  <link>https://ehsanmkermani.com/posts/2023-12-08-modal-labs-deep-dive/</link>
  <description><![CDATA[ 





<section id="prelude" class="level2">
<h2 class="anchored" data-anchor-id="prelude">Prelude</h2>
<p>In this post, we‚Äôre going to deep dive into one of my favourite tools that are revolutionizing how Python code is run in cloud and it‚Äôs especially aimed at the computing stack for Machine Learning / Deep Learning applications, called <a href="https://modal.com/">Modal</a> which has recently gone GA!</p>
<p>There are almost no resources besides the official documents and examples. I have been using Modal for almost a year and this post sums up crucial points on using Modal and does a series of deep dives into its inner working. Finally, we end with a few best practices.</p>
<p><a href="https://ehsanmkermani.com/wp-content/uploads/2023/12/modal-ga-tweet.png"><img src="https://ehsanmkermani.com/posts/2023-12-08-modal-labs-deep-dive/images/modal-ga-tweet.png" class="img-fluid"></a></p>
<section id="infrastructure-from-code" class="level3">
<h3 class="anchored" data-anchor-id="infrastructure-from-code">Infrastructure from Code</h3>
<p>In the last couple of years, there has been a new trend aimed at simplifying code deployment in cloud. If you‚Äôve likely seen drawbacks with<strong>Infrastructure-as-Code (IaC)</strong>tools such as Terraform, Pulumi, AWS CloudFormation, etc., you‚Äôre not alone.<em>Each tool has its own terminology, often in the form of a DSL, library/package, or YAML extension ü§ï</em>Decoupled from the application code, meaning that using resources in code requires separately creating the necessary cloud resources</p>
<p>For certain applications and larger companies, these requirements might be manageable. However, for smaller companies and individual developers, they can be overwhelming.</p>
<p>So, the main idea of<strong>Infrastructure-from-Code (IfC)</strong>is to simplify IaC by being as close to the application as possible. This means introducing little to no new syntax and providing a way to create and manage cloud resources needed for deploying the application as conveniently as possible, for example, with a CLI.</p>
<p>In fact,<strong>Modal is an IfC solution for the computing stack, especially for ML/DL apps</strong>.</p>
<p>If you want to know more about IfC, have a look at my <a href="https://github.com/ehsanmok/awesome-infrastructure-from-code">awesome-infrastructure-from-code</a> resources.</p>
</section>
<section id="modals-pitch" class="level3">
<h3 class="anchored" data-anchor-id="modals-pitch">Modal‚Äôs Pitch</h3>
<blockquote class="blockquote">
<p>Modal‚Äôs goal is to<strong>make running code in the cloud</strong>feel like<strong>you‚Äôre running code locally</strong>. You don‚Äôt need to run any commands to rebuild, push containers, or go to a web UI to download logs.</p>
</blockquote>
</section>
<section id="installation-and-official-guide" class="level3">
<h3 class="anchored" data-anchor-id="installation-and-official-guide">Installation and Official Guide</h3>
<p>First, make sure you‚Äôre signed in <a href="https://modal.com">modal.com</a>. Then the <a href="https://modal.com/">installation guide</a></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pip</span> install modal</span>
<span id="cb1-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">python3</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-m</span> modal setup</span></code></pre></div></div>
<p>installs the modal package which comes with its own CLI. Also configures the CLI and sets up the API token once. After that, let‚Äôs create a dev environment for our deep dive</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">modal</span> environment create dev</span>
<span id="cb2-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">modal</span> config set-environment dev</span></code></pre></div></div>
<p><strong>Note: All codes are available in <a href="https://github.com/ehsanmok/blog/tree/main/code/modal-deep-dive">my GitHub</a>.</strong></p>
</section>
<section id="runtime-spec-via-stub" class="level3">
<h3 class="anchored" data-anchor-id="runtime-spec-via-stub">Runtime Spec via stub</h3>
<p>Let‚Äôs see what that means. First,</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">git</span> clone https://github.com/ehsanmok/blog <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cd</span> blog/code/modal-deep-dive</span></code></pre></div></div>
<p>and have a look at <code>lib/empty.py</code></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> modal</span>
<span id="cb4-2">stub <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> modal.Stub(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"empty"</span>)</span></code></pre></div></div>
<p>Let‚Äôs deploy an empty stub via</p>
<p><code>modal deploy lib/empty.py</code></p>
<p>(since I‚Äôm using Poetry, I factor out the <code>poetry run</code> part).</p>
<p><a href="https://ehsanmkermani.com/wp-content/uploads/2023/12/empty-deploy-cli.png"><img src="https://ehsanmkermani.com/posts/2023-12-08-modal-labs-deep-dive/images/empty-deploy-cli.png" class="img-fluid"></a></p>
<p>and the Modal dashboard view</p>
<p><a href="https://ehsanmkermani.com/wp-content/uploads/2023/12/modal-empty-dashboard.png"><img src="https://ehsanmkermani.com/posts/2023-12-08-modal-labs-deep-dive/images/modal-empty-dashboard-1024x254.png" class="img-fluid"></a></p>
<p>Ok! so far so good. We just deployed an empty stub. You can think about it like a<em>container</em>(either in abstract sense or like docker container) and here the container is empty! We will expand on that later.</p>
<p>Let‚Äôs continue with <code>lib/hello.py</code></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> modal</span>
<span id="cb5-2"></span>
<span id="cb5-3">stub <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> modal.Stub(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hello"</span>)</span>
<span id="cb5-4"></span>
<span id="cb5-5"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@stub.function</span>()</span>
<span id="cb5-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> hello():</span>
<span id="cb5-7">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hello, world!"</span>)</span></code></pre></div></div>
<p>Let‚Äôs take a look at <code>Stub</code> description (emphasis is mine)</p>
<blockquote class="blockquote">
<p>A <code>Stub</code> is a<strong>description</strong>of how to create a Modal application. The stub object principally describes Modal objects (<code>Function</code>, <code>Image</code>, <code>Secret</code>, etc.) associated with the application. It has<em>three responsibilities:</em>&gt;</p>
<p><em><strong>Syncing of identities across processes (your local Python interpreter and every Modal worker active in your application).</strong>&gt;</em><strong>Making Objects stay alive and not be garbage collected for as long as the app lives (see App lifetime below).</strong>&gt;*<strong>Manage log collection for everything that happens inside your code.</strong>See what happens if we deploy our hello world via</p>
</blockquote>
<p><code>modal deploy lib/hello.py</code></p>
<p><a href="https://ehsanmkermani.com/wp-content/uploads/2023/12/deploy-hello-1.png"><img src="https://ehsanmkermani.com/posts/2023-12-08-modal-labs-deep-dive/images/deploy-hello-1.png" class="img-fluid"></a></p>
<p>and dashboard says it‚Äôs deployed but is ‚ÄúCurrently idle‚Äù, because it‚Äôs not receiving any input</p>
<p><a href="https://ehsanmkermani.com/wp-content/uploads/2023/12/deploy-hello-dashboard-1.png"><img src="https://ehsanmkermani.com/posts/2023-12-08-modal-labs-deep-dive/images/deploy-hello-dashboard-1-1024x286.png" class="img-fluid"></a></p>
<p>in fact in order to execute the stubbed hello function we should do <code>modal run lib/hello.py</code>.</p>
<p><a href="https://ehsanmkermani.com/wp-content/uploads/2023/12/run-hello-cli.png"><img src="https://ehsanmkermani.com/posts/2023-12-08-modal-labs-deep-dive/images/run-hello-cli.png" class="img-fluid"></a></p>
<p>From the output, we can see it</p>
<ol type="1">
<li>Created a mount of some sort (will expand on that later)</li>
<li>Created our application hello</li>
<li>Ran the app</li>
<li>Finally stopped the app</li>
</ol>
</section>
</section>
<section id="lets-dive-deep" class="level2">
<h2 class="anchored" data-anchor-id="lets-dive-deep">Let‚Äôs Dive Deep</h2>
<p>What happens when we do <code>modal run</code>?</p>
<p>The official Modal document describes it as</p>
<blockquote class="blockquote">
<h3 id="how-does-it-work" class="anchored">How does it work?</h3>
<p>Modal takes your code, puts it in a container, and executes it in the cloud.</p>
<p>Where does it run? Modal runs it in its own cloud environment. The benefit is that we solve all the hard infrastructure problems for you, so you don‚Äôt have to do anything. You don‚Äôt need to mess with Kubernetes, Docker or even an AWS account.</p>
<p>Official Modal doc</p>
</blockquote>
<p>In the outset, Modal intelligently<em>wraps our code and all of its dependencies (we will get to it later) with metadata</em>containerizes*and finally runs / deploys it</p>
<p>A few important points:<em>the containerization is<strong>NOT</strong>via docker. Modal has created its own</em>OCI compatible container service<em>suitable for ML apps including heavy duty ones. An issue with the default docker container is being slow when for example including large ML model. Modal has its own container runner (compatible with <a href="https://github.com/opencontainers/runc">runc</a> and <a href="https://github.com/google/gvisor">gvisor</a>) and image builder.</em><strong>Modal has created it‚Äôs own filesystem (in Rust ü¶Ä)</strong>that maps everything into a performant container via its FS. This innovating approach makes creating and deploying large containers fast and scalable.</p>
<blockquote class="blockquote">
<p>We decided to not build this on top of tools like Docker/Kubernetes because we want infrastructure to be<em>fast</em>‚Ä¶ Modal has no problem building a 100GB container, and then booting up 100 of those containers ‚Äî you can do the whole thing in a few seconds. This is what it‚Äôs built for.</p>
<p><a href="https://erikbern.com/2022/12/07/what-ive-been-working-on-modal">Eric Bernhardsson‚Äôs (Modal CEO) blog</a></p>
</blockquote>
<p>In fact, the <a href="https://earthly.dev/blog/chroot/">essence of docker is chroot and Unix FileSystem</a>. So with their performant custom FS, Modal has successfully created a very<em>performant runtime for cloud</em>.</p>
<p>To have a better idea of what is under-the-hood, we use <code>modal shell</code></p>
<pre class="text"><code>modal shell lib/hello.py
‚úì Initialized. View run at https://modal.com/apps/ap-t46rTYWQKvHzcvjJ2uvpGr
‚úì Created objects.
‚îú‚îÄ‚îÄ üî® Created mount /Users/ehsan/workspace/blog/modal-deep-dive/lib
‚îî‚îÄ‚îÄ üî® Created hello.
Spawning /bin/bash
root@modal:~#
root@modal:~# ls
intro
root@modal:~# cd lib/
root@modal:~/lib# ls
__init__.py  empty.py  hello.py</code></pre>
<p>Interesting! <code>modal shell</code> spawns bash and shows where our python code is placed. Let‚Äôs see what is at the root directory</p>
<pre class="text"><code>root@modal:~# cd /
root@modal:/# ls
bin  boot  dev  dummy_plug  etc  home  lib  lib64  media  mnt  modal_requirements.txt  opt  pkg  proc  root  run  sbin  srv  sys  tmp  usr  var
root@modal:/# cat modal_requirements.txt
# Pins Modal dependencies installed within the container runtime.
aiohttp==3.8.3
aiostream==0.4.4
asgiref==3.5.2
certifi&gt;=2022.12.07
cloudpickle==2.0.0;python_version&lt;'3.11'
cloudpickle==2.2.0;python_version&gt;='3.11'
ddtrace==1.5.2;python_version&lt;'3.11'
fastapi==0.88.0
fastprogress==1.0.0
grpclib==0.4.3
importlib_metadata==4.8.1
ipython&gt;=7.34.0
protobuf&gt;=3.19.0
python-multipart&gt;=0.0.5
rich==12.3.0
tblib==1.7.0
toml==0.10.2
typer==0.6.1
types-certifi==2021.10.8.3
types-toml==0.10.4
typeguard&gt;=3.0.0</code></pre>
<p>So it looks like a usual Unix FS with a few new addops like <code>modal_requirements.txt</code> where we can see its content.</p>
<section id="cloudpickle" class="level3">
<h3 class="anchored" data-anchor-id="cloudpickle">cloudpickle</h3>
<p>Modal uses <a href="https://github.com/cloudpipe/cloudpickle">cloudpickle</a> which extends Python pickle for sending data back and forth. This is a<strong>major requirement</strong>that data must be cloudpicklable. Note that<em>not everything is cloudpicklable</em>.</p>
<p>Here is an example which we can run directly in Modal python environment</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1">root<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>modal:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># python</span></span>
<span id="cb8-2">Python <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.10.8</span> (main, Dec  <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2022</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">24</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>) [GCC <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">10.2.1</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20210110</span>] on linux</span>
<span id="cb8-3">Type <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"help"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"copyright"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"credits"</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">or</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"license"</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> more information.</span>
<span id="cb8-4"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;&gt;</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> cloudpickle</span>
<span id="cb8-5"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;&gt;</span></span>
<span id="cb8-6"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;&gt;</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Unpickleable:</span>
<span id="cb8-7">...     <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> __reduce__(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb8-8">...         <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">raise</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">TypeError</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"This object cannot be pickled"</span>)</span>
<span id="cb8-9">...</span>
<span id="cb8-10"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;&gt;</span> obj <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Unpickleable()</span>
<span id="cb8-11"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;&gt;</span></span>
<span id="cb8-12"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;&gt;</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb8-13">...     serialized_obj <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cloudpickle.dumps(obj)</span>
<span id="cb8-14">... <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">Exception</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> e:</span>
<span id="cb8-15">...     <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Error: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>e<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb8-16">...</span>
<span id="cb8-17">Error: This <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">object</span> cannot be pickled</span></code></pre></div></div>
</section>
<section id="what-objects-are-not-cloudpicklable" class="level3">
<h3 class="anchored" data-anchor-id="what-objects-are-not-cloudpicklable">What objects are not cloudpicklable?</h3>
<p>Objects that cloudpickle<strong>cannot</strong>serialize include</p>
<p>1.<strong>Objects with unpickleable attributes</strong>: If an object has attributes that cannot be pickled (e.g., file handles, network connections), cloudpickle will fail to serialize it. 2.<strong>Objects with custom <code>__reduce__</code> methods that raise exceptions</strong>: If an object defines a custom <code>__reduce__</code> method that raises exceptions, cloudpickle will not be able to serialize it. 3.<strong>Objects from C extensions or third-party libraries</strong>: Cloudpickle may not be able to serialize objects from C extensions or third-party libraries that do not provide proper serialization support. 4.<strong>Some built-in types</strong>: While cloudpickle can serialize many built-in types, there may be limitations for certain objects like open file objects, network sockets, or database connections. 5.<strong>Functions or lambda functions with closures</strong>: Cloudpickle can serialize simple functions, but functions with complex closures (nested functions with captured variables) may not be serialized correctly.</p>
<p>The takeaway is cloudpickle almost always works and if there components that cannot be used there usually is a workaround!</p>
</section>
<section id="function-proto" class="level3">
<h3 class="anchored" data-anchor-id="function-proto">Function proto</h3>
<p>Now back to Modal. Among its dependencies, there are<strong>grpclib</strong>and<strong>protobuf</strong>. If we have look at <a href="https://github.com/modal-labs/modal-client/blob/main/modal_proto/api.proto">modal-client/blob/main/modal_proto/api.proto</a> we will see the protobuf definitions. Of particular interest is <a href="https://github.com/modal-labs/modal-client/blob/959b249e7bccff460cdf356e8609914568e4d868/modal_proto/api.proto#L619-L701">Function</a> and other related <code>message Function*</code> definitions</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode protobuf code-with-copy"><code class="sourceCode protobuf"><span id="cb9-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">message</span> Function {</span>
<span id="cb9-2">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">string</span> module_name = <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>;</span>
<span id="cb9-3">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">string</span> function_name = <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>;</span>
<span id="cb9-4">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">repeated</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">string</span> mount_ids = <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>;</span>
<span id="cb9-5">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">string</span> image_id = <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>;</span>
<span id="cb9-6">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bytes</span> function_serialized = <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>;</span>
<span id="cb9-7"></span>
<span id="cb9-8">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">enum</span> DefinitionType {</span>
<span id="cb9-9">    DEFINITION_TYPE_UNSPECIFIED = <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>;</span>
<span id="cb9-10">    DEFINITION_TYPE_SERIALIZED = <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>;</span>
<span id="cb9-11">    DEFINITION_TYPE_FILE = <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>;</span>
<span id="cb9-12">  }</span>
<span id="cb9-13">  DefinitionType definition_type = <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>;</span>
<span id="cb9-14"></span>
<span id="cb9-15">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">enum</span> FunctionType {</span>
<span id="cb9-16">    FUNCTION_TYPE_UNSPECIFIED = <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>;</span>
<span id="cb9-17">    FUNCTION_TYPE_GENERATOR = <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>;</span>
<span id="cb9-18">    FUNCTION_TYPE_FUNCTION = <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>;</span>
<span id="cb9-19">  }</span>
<span id="cb9-20">  FunctionType function_type = <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>;</span>
<span id="cb9-21"></span>
<span id="cb9-22">  Resources resources = <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>;</span>
<span id="cb9-23">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">repeated</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">string</span> secret_ids = <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>;</span>
<span id="cb9-24"></span>
<span id="cb9-25">  RateLimit rate_limit = <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>;</span>
<span id="cb9-26">  WebhookConfig webhook_config = <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>;</span>
<span id="cb9-27"></span>
<span id="cb9-28">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">repeated</span> SharedVolumeMount shared_volume_mounts = <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>;</span>
<span id="cb9-29"></span>
<span id="cb9-30">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">optional</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">string</span> proxy_id = <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">17</span>;</span>
<span id="cb9-31"></span>
<span id="cb9-32">  FunctionRetryPolicy retry_policy = <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">18</span>;</span>
<span id="cb9-33"></span>
<span id="cb9-34">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">uint32</span> concurrency_limit = <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">19</span>;</span>
<span id="cb9-35"></span>
<span id="cb9-36">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> keep_warm = <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>;</span>
<span id="cb9-37"></span>
<span id="cb9-38">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">uint32</span> timeout_secs = <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">21</span>;</span>
<span id="cb9-39"></span>
<span id="cb9-40">  PTYInfo pty_info = <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">22</span>;</span>
<span id="cb9-41">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bytes</span> class_serialized = <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">23</span>;</span>
<span id="cb9-42"></span>
<span id="cb9-43">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">uint32</span> task_idle_timeout_secs = <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span>;</span>
<span id="cb9-44"></span>
<span id="cb9-45">  CloudProvider cloud_provider = <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">26</span>;</span>
<span id="cb9-46"></span>
<span id="cb9-47">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">uint32</span> warm_pool_size = <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">27</span>;</span>
<span id="cb9-48"></span>
<span id="cb9-49">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">string</span> web_url = <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28</span>;</span>
<span id="cb9-50">  WebUrlInfo web_url_info = <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">29</span>;</span>
<span id="cb9-51"></span>
<span id="cb9-52">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// If set, overrides the runtime used by the function, either "runc" or "gvisor".</span></span>
<span id="cb9-53">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">string</span> runtime = <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>;</span>
<span id="cb9-54"></span>
<span id="cb9-55">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">string</span> stub_name = <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">31</span>;</span>
<span id="cb9-56"></span>
<span id="cb9-57">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">repeated</span> VolumeMount volume_mounts = <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">33</span>;</span>
<span id="cb9-58"></span>
<span id="cb9-59">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">uint32</span> allow_concurrent_inputs = <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">34</span>;</span>
<span id="cb9-60"></span>
<span id="cb9-61">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">repeated</span> CustomDomainInfo custom_domain_info = <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">35</span>;</span>
<span id="cb9-62"></span>
<span id="cb9-63">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">string</span> worker_id = <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">36</span>; <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// For internal debugging use only.</span></span>
<span id="cb9-64"></span>
<span id="cb9-65">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> runtime_debug = <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">37</span>; <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// For internal debugging use only.</span></span>
<span id="cb9-66"></span>
<span id="cb9-67">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// </span><span class="al" style="color: #AD0000;
background-color: null;
font-style: inherit;">TODO</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">: combine into enum?</span></span>
<span id="cb9-68">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> is_builder_function = <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>;</span>
<span id="cb9-69">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> is_auto_snapshot = <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">38</span>;</span>
<span id="cb9-70">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> is_method = <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">39</span>;</span>
<span id="cb9-71">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> is_checkpointing_function = <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>;</span>
<span id="cb9-72"></span>
<span id="cb9-73">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Checkpoint and restore</span></span>
<span id="cb9-74"></span>
<span id="cb9-75">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> checkpointing_enabled = <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">41</span>;</span>
<span id="cb9-76"></span>
<span id="cb9-77">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">message</span> CheckpointInfo {</span>
<span id="cb9-78">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">string</span> checksum = <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>;</span>
<span id="cb9-79">    CheckpointStatus status = <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>;</span>
<span id="cb9-80">  }</span>
<span id="cb9-81">  CheckpointInfo checkpoint = <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>;</span>
<span id="cb9-82">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">repeated</span> ObjectDependency object_dependencies = <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">43</span>;</span>
<span id="cb9-83">}</span></code></pre></div></div>
<p>There is a lot going on. We can summarize it as</p>
<p>1.<strong>Basic Function Information:</strong><em><code>module_name</code>, <code>function_name</code>: Identifiers for the module and function.</em><code>mount_ids</code>, <code>image_id</code>: Refer to identifiers for file systems or images that the function can access or is associated with. 2.<strong>Function and Definition Types:</strong><em><code>DefinitionType</code> and <code>FunctionType</code> enums: These provide information about how the function is defined (serialized, file) and its type (generator, regular function). 3.<strong>Execution Resources and Configuration:</strong></em><code>Resources</code>, <code>RateLimit</code>, <code>WebhookConfig</code>, <code>SharedVolumeMounts</code>: Configuration for computational resources, rate limiting, webhooks for external triggers, and shared file system mounts.<em><code>proxy_id</code>, <code>retry_policy</code>, <code>concurrency_limit</code>, <code>keep_warm</code>, <code>timeout_secs</code>: Deal with network proxy settings, how to handle retries, concurrency limits, whether to keep the function active in memory, execution timeouts, and more. 4.<strong>Advanced Function Settings:</strong></em><code>PTYInfo</code>, <code>class_serialized</code>, <code>CloudProvider</code>, <code>runtime</code>, <code>stub_name</code>: Related to Python perhaps? (PTY), class definitions, the cloud provider specifics, the runtime environment, and some stub or placeholder name.<em><code>volume_mounts</code>, <code>custom_domain_info</code>, <code>worker_id</code>: Volume mounts for additional storage, custom domain configurations for web access, and an identifier for internal debugging. 5.<strong>Concurrency and Security:</strong></em><code>allow_concurrent_inputs</code>, <code>secret_ids</code>: Settings for handling concurrent inputs and identifiers for any secrets needed by the function. 6.<strong>Debugging and Special Function Types:</strong><em><code>runtime_debug</code>, <code>is_builder_function</code>, <code>is_auto_snapshot</code>, <code>is_method</code>, <code>is_checkpointing_function</code>: These flags seem to enable debugging, specify different roles or behaviors of the function (like being a builder, supporting auto-snapshots, etc.), and indicate if the function supports checkpointing for state persistence. 7.<strong>Checkpointing and Dependencies:</strong></em><code>checkpointing_enabled</code>, <code>CheckpointInfo</code>, <code>object_dependencies</code>: Related to the ability to checkpoint (save the state) of the function, with details about the checkpoint and dependencies on other objects.</p>
</section>
</section>
<section id="lets-come-back-up-breathe-and-dive-deep-again" class="level2">
<h2 class="anchored" data-anchor-id="lets-come-back-up-breathe-and-dive-deep-again">Let‚Äôs Come back up, Breathe and Dive Deep Again</h2>
<p>Following up on the hello world, what if there are multiple modal <code>@stub.functions</code> under one stub?</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> modal</span>
<span id="cb10-2"></span>
<span id="cb10-3">stub <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> modal.Stub(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hello"</span>)</span>
<span id="cb10-4"></span>
<span id="cb10-5"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@stub.function</span>()</span>
<span id="cb10-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> hello():</span>
<span id="cb10-7">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hello, world!"</span>)</span>
<span id="cb10-8"></span>
<span id="cb10-9"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@stub.function</span>()</span>
<span id="cb10-10"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> hello2():</span>
<span id="cb10-11">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hello, world second time!"</span>)</span></code></pre></div></div>
<p>then <code>modal run lib/hello_local_entry.py</code> fails with</p>
<p><a href="https://ehsanmkermani.com/wp-content/uploads/2023/12/two-hello-run-error.png"><img src="https://ehsanmkermani.com/posts/2023-12-08-modal-labs-deep-dive/images/two-hello-run-error.png" class="img-fluid"></a></p>
<p>so we need to specify which one to run. We have two options<em>via CLI: <code>modal run lib/hello_local_entry.py::hello</code></em>Or specify it in code using <code>@stub.local_entrypoint</code> decorator and <code>modal run lib/hello_local_entry.py</code> (no need for <code>::hello</code>)</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@stub.function</span>()</span>
<span id="cb11-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> hello():</span>
<span id="cb11-3">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hello, world!"</span>)</span>
<span id="cb11-4"></span>
<span id="cb11-5"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@stub.function</span>()</span>
<span id="cb11-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> hello2():</span>
<span id="cb11-7">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hello, world second time!"</span>)</span>
<span id="cb11-8"></span>
<span id="cb11-9"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@stub.local_entrypoint</span>()</span>
<span id="cb11-10"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> main():</span>
<span id="cb11-11">    hello.local()  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># semantically is `hello()`</span></span></code></pre></div></div>
<p>Simply calling <code>hello()</code> doesn‚Äôt work (anymore) and Modal has its own calling semantics depending on the environment*<code>hello.local()</code> as above</p>
<p>which outputs</p>
<p><a href="https://ehsanmkermani.com/wp-content/uploads/2023/12/run-two-hello-localentrypoint.png"><img src="https://ehsanmkermani.com/posts/2023-12-08-modal-labs-deep-dive/images/run-two-hello-localentrypoint.png" class="img-fluid"></a>*Or via <code>hello.remote()</code></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@stub.local_entrypoint</span>()</span>
<span id="cb12-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> main():</span>
<span id="cb12-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># hello.local()</span></span>
<span id="cb12-4">    hello.remote()</span></code></pre></div></div>
<p><a href="https://ehsanmkermani.com/wp-content/uploads/2023/12/two-hello-remote.png"><img src="https://ehsanmkermani.com/posts/2023-12-08-modal-labs-deep-dive/images/two-hello-remote.png" class="img-fluid"></a></p>
<p>There is a subtle difference in their output. Did you notice it? there is an extra <code>None</code> after <code>hello, world!</code> in the <code>.remote()</code> case. Why?</p>
<section id="local-vs-.remote" class="level3">
<h3 class="anchored" data-anchor-id="local-vs-.remote"><code>.local()</code> vs <code>.remote()</code></h3>
<p>What happens with <code>hello.local()</code> tells Modal to run the code locally (your local environment such as laptop) whereas <code>hello.remote()</code> runs the code in the cloud and returns the result back locally.</p>
<p>One important aspect of Modal is it promises simulating cloud code execution to be as similar and local as possible. It also has<em>hot-reloading</em>(when code is run via <code>modal serve</code> which will get to that later) i.e.&nbsp;changing your code is automatically synced and rerun in the cloud (in an ephemeral environment).</p>
</section>
<section id="parallel-run-via-.map-and-starmap" class="level3">
<h3 class="anchored" data-anchor-id="parallel-run-via-.map-and-starmap"><code>Parallel run via .map() and starmap()</code></h3>
<p>Modal functions can be run in parallel using <code>.map(...)</code></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@stub.function</span>()</span>
<span id="cb13-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> my_func(a):</span>
<span id="cb13-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb13-4"></span>
<span id="cb13-5"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@stub.local_entrypoint</span>()</span>
<span id="cb13-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> main():</span>
<span id="cb13-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(my_func.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">map</span>([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>])) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>]</span></code></pre></div></div>
<p><code>.starmap(...)</code> is like&nbsp;<code>map</code>&nbsp;but spreads arguments over multiple function arguments</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@stub.function</span>()</span>
<span id="cb14-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> my_func(a, b):</span>
<span id="cb14-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b</span>
<span id="cb14-4"></span>
<span id="cb14-5"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@stub.local_entrypoint</span>()</span>
<span id="cb14-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> main():</span>
<span id="cb14-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(my_func.starmap([(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)])) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>]</span></code></pre></div></div>
</section>
<section id="lookup-and-spawn-functions-remotely" class="level3">
<h3 class="anchored" data-anchor-id="lookup-and-spawn-functions-remotely">Lookup and Spawn Functions Remotely</h3>
<p>So far, we have tested using one stub. It‚Äôs possible to have<em>multiple stubs</em>, too. In that case, it‚Äôs possible to lookup a function or spawn it remotely (via a handle). In order to do that, the function that we are looking up or spawning<strong>must be already deployed</strong>(<code>modal deploy</code>) whereas if it‚Äôs in the ephemeral phase it can get deleted on the fly we can look it up in different context via<em><code>modal.Function.lookup(STUB_NAME, FUNCTION_NAME)</code></em><code>modal.Function.from_name(STUB_NAME, FUNCTION_NAME)</code></p>
<p>For example, <code>lib/square.py</code> and <code>model deploy square.py</code> (note<strong>must</strong>be deployed to be found)</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> modal</span>
<span id="cb15-2"></span>
<span id="cb15-3">stub <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> modal.Stub(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"my-shared-app"</span>)</span>
<span id="cb15-4"></span>
<span id="cb15-5"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@stub.function</span>()</span>
<span id="cb15-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> square(x):</span>
<span id="cb15-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> x</span></code></pre></div></div>
<p>and <code>lib/cube.py</code> can look it up via either <code>Function.from_name</code> or <code>Function.lookup</code> and then <code>modal run cube.py</code></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> modal</span>
<span id="cb16-2"></span>
<span id="cb16-3">stub <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> modal.Stub(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"another-app"</span>)</span>
<span id="cb16-4">stub.square <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> modal.Function.from_name(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"my-shared-app"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"square"</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># &lt;-- </span><span class="al" style="color: #AD0000;
background-color: null;
font-style: inherit;">NOTE</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">: this must be deployed otherwise `modal run` won't find it</span></span>
<span id="cb16-5"></span>
<span id="cb16-6"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@stub.function</span>()</span>
<span id="cb16-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> cube(x):</span>
<span id="cb16-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> stub.square.remote(x)</span>
<span id="cb16-9"></span>
<span id="cb16-10"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@stub.local_entrypoint</span>()</span>
<span id="cb16-11"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> main():</span>
<span id="cb16-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> cube.remote(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">74088</span></span></code></pre></div></div>
<p>It‚Äôs also possible to remotely <code>modal.Function.spawn</code> a function which doesn‚Äôt wait for the result but returns <code>FunctionCall</code> object which can be<strong>polled</strong>. This is useful esp.&nbsp;given a job queue and (async) spawn / poll for long running jobs in the background.</p>
<p>To see it in action, run <code>modal run lib/cube_spawn.py</code></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> time</span>
<span id="cb17-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> modal</span>
<span id="cb17-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> modal.functions <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> FunctionCall</span>
<span id="cb17-4"></span>
<span id="cb17-5">stub <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> modal.Stub(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cube-spawn"</span>)</span>
<span id="cb17-6">stub.square <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> modal.Function.from_name(</span>
<span id="cb17-7">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"my-shared-app"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"square"</span></span>
<span id="cb17-8">)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># &lt;-- </span><span class="al" style="color: #AD0000;
background-color: null;
font-style: inherit;">NOTE</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">: this must be deployed otherwise `modal run` won't find it</span></span>
<span id="cb17-9"></span>
<span id="cb17-10"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@stub.function</span>()</span>
<span id="cb17-11"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> spawn_square(x):</span>
<span id="cb17-12">    call <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stub.square.spawn(x)</span>
<span id="cb17-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"call_id"</span>: call.object_id}</span>
<span id="cb17-14"></span>
<span id="cb17-15"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@stub.function</span>()</span>
<span id="cb17-16"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> poll(call_id):</span>
<span id="cb17-17">    fcall <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> FunctionCall.from_id(call_id)</span>
<span id="cb17-18">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb17-19">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 5 seconds timeout to simulate a long running job</span></span>
<span id="cb17-20">        ret <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fcall.get(timeout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb17-21">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">TimeoutError</span>:</span>
<span id="cb17-22">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"waiting for result"</span>)</span>
<span id="cb17-23">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span></span>
<span id="cb17-24"></span>
<span id="cb17-25">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> ret</span>
<span id="cb17-26"></span>
<span id="cb17-27"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@stub.local_entrypoint</span>()</span>
<span id="cb17-28"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> cube():</span>
<span id="cb17-29">    call <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> spawn_square.remote(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb17-30">    call_id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> call[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"call_id"</span>]</span>
<span id="cb17-31">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> call_id <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb17-32">    ret <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> poll.remote(call_id)</span>
<span id="cb17-33">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> ret <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">74088</span></span></code></pre></div></div>
<p>The important point is the caller that spawns square returns a <code>call_id</code> which can be retrieved and polled via <code>FunctionCall.from_id(call_id)</code>. A less contrived example is in <a href="https://github.com/modal-labs/modal-examples/blob/main/09_job_queues/doc_ocr_webapp.py">OCR webapp example</a> which is</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@web_app.post</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/parse"</span>)</span>
<span id="cb18-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> parse(request: fastapi.Request):</span>
<span id="cb18-3">    parse_receipt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Function.lookup(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"example-doc-ocr-jobs"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"parse_receipt"</span>)</span>
<span id="cb18-4"></span>
<span id="cb18-5">    form <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> request.form()</span>
<span id="cb18-6">    receipt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> form[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"receipt"</span>].read()  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># type: ignore</span></span>
<span id="cb18-7">    call <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> parse_receipt.spawn(receipt)</span>
<span id="cb18-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"call_id"</span>: call.object_id}</span>
<span id="cb18-9"></span>
<span id="cb18-10"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@web_app.get</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/result/</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{call_id}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb18-11"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> poll_results(call_id: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>):</span>
<span id="cb18-12">    <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> modal.functions <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> FunctionCall</span>
<span id="cb18-13"></span>
<span id="cb18-14">    function_call <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> FunctionCall.from_id(call_id)</span>
<span id="cb18-15">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb18-16">        result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> function_call.get(timeout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb18-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">TimeoutError</span>:</span>
<span id="cb18-18">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> fastapi.responses.JSONResponse(content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, status_code<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">202</span>)</span>
<span id="cb18-19"></span>
<span id="cb18-20">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> result</span></code></pre></div></div>
<p>and the frontend code uses them like</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb19-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">const</span> resp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fetch</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/parse"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> {</span>
<span id="cb19-2">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">method</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"POST"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb19-3">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">body</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> formData<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb19-4">    })<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb19-5"></span>
<span id="cb19-6"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span></span>
<span id="cb19-7"></span>
<span id="cb19-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">const</span> _intervalID <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">setInterval</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">async</span> () <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">=&gt;</span> {</span>
<span id="cb19-9">      <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">const</span> resp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fetch</span>(<span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">`/result/</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">${</span>callId<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb19-10">      <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (resp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">status</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">===</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>) {</span>
<span id="cb19-11">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setResult</span>(<span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> resp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">json</span>())<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb19-12">      }</span>
<span id="cb19-13">    }<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb19-14"></span>
<span id="cb19-15">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setIntervalId</span>(_intervalID)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div></div>
</section>
<section id="async-support" class="level3">
<h3 class="anchored" data-anchor-id="async-support">Async Support</h3>
<p>Modal stubbed functions can be async as well. The only thing that changes is how they are called; <code>await</code> is prepended as well as <code>.aio</code> appended<strong>func.remote(‚Ä¶)</strong>‚üπ<strong>await func.remote.aio(‚Ä¶)</strong>The magic is behind Modal‚Äôs<strong><a href="https://github.com/modal-labs/synchronicity">synchronicity</a></strong>library that makes sync and async functions to be used uniformly.</p>
</section>
<section id="class-support" class="level3">
<h3 class="anchored" data-anchor-id="class-support">Class Support</h3>
<p>Modal supports decorating Python classes with <code>@stub.cls()</code> but requires <code>__(a)enter__</code> with/without <code>__(a)exit__</code> methods and <code>@modal.method</code> decorator for the class methods. The <code>__(a)enter__</code> and <code>__(a)exit__</code> come with the the following<strong>caveat</strong>&gt; The syntax and behavior for the&nbsp;<code>__(a)enter__</code>&nbsp;and&nbsp;<code>__(a)exit__</code>&nbsp;functions are similar to&nbsp;<a href="https://docs.python.org/3/reference/datamodel.html#with-statement-context-managers">context managers</a>. However, they<strong>do not</strong>have the exact same semantics as Python‚Äôs corresponding&nbsp;<a href="https://docs.python.org/3/reference/datamodel.html#special-method-names">special methods</a>&nbsp;with the same name. <code>__(a)enter__</code> and <code>__(a)exit__</code>. &gt; &gt; &gt; &gt;<strong>The container entry handler is called when a new container is started. This is useful for doing one-time initialization, such as loading model weights or importing packages that are only present in that image.</strong>&gt; &gt; Mo</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> modal <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Stub, method</span>
<span id="cb20-2"></span>
<span id="cb20-3">stub <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Stub()</span>
<span id="cb20-4"></span>
<span id="cb20-5"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@stub.cls</span>()</span>
<span id="cb20-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Model:</span>
<span id="cb20-7">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__enter__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb20-8">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pickle.load(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"model.pickle"</span>))</span>
<span id="cb20-9"></span>
<span id="cb20-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@method</span>()</span>
<span id="cb20-11">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> predict(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, x):</span>
<span id="cb20-12">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.model.predict(x)</span>
<span id="cb20-13"></span>
<span id="cb20-14"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@stub.local_entrypoint</span>()</span>
<span id="cb20-15"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> main():</span>
<span id="cb20-16">    Model().predict.remote(x) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># &lt;-- it's not like context manager `with ...` at all!</span></span></code></pre></div></div>
<p>In fact, <code>@stub.cls</code> is more like a<strong>syntactic sugar for functions</strong>that needs to load an object or make a connection once and proceed with the rest of the work. The <code>__(a)enter__</code> is particularly useful for example, when we want to load a large ML model once and use it for inference.</p>
</section>
</section>
<section id="build-time-dependencies-and-resources" class="level2">
<h2 class="anchored" data-anchor-id="build-time-dependencies-and-resources">Build time Dependencies and Resources</h2>
<section id="modal.image" class="level3">
<h3 class="anchored" data-anchor-id="modal.image"><code>modal.Image</code></h3>
<p>So far, we have created and run functions with no dependency. Modal supports specifying build time dependencies via the <code>Image</code> object. For example,</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1">image <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Image.debian_slim().pip_install(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pandas"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"numpy"</span>)</span>
<span id="cb21-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@stub.function</span>(image<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>image)</span>
<span id="cb21-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> my_function():</span>
<span id="cb21-4">    <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb21-5">    <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb21-6">    ...</span></code></pre></div></div>
<p>The Image object is very versatile. One can do*pip install targeting GPU</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1">image <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb22-2">    Image.debian_slim(python_version<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"3.10"</span>)</span>
<span id="cb22-3">    .pip_install(</span>
<span id="cb22-4">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"optimum[onnxruntime-gpu]==1.7.3"</span>,</span>
<span id="cb22-5">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"transformers[onnx-gpu]==4.28.1"</span>,</span>
<span id="cb22-6">        gpu<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A10G"</span>,</span>
<span id="cb22-7">    )</span>
<span id="cb22-8">)</span></code></pre></div></div>
<ul>
<li>apt install:</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1">Image.debian_slim().apt_install(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ffmpeg"</span>)</span></code></pre></div></div>
<ul>
<li>add custom commands:</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1">Image.debian_slim().apt_install(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"curl"</span>).run_commands(</span>
<span id="cb24-2">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"curl -O https://raw.githubusercontent.com/opencv/opencv/master/data/haarcascades/haarcascade_frontalcatface.xml"</span>,</span>
<span id="cb24-3">)</span></code></pre></div></div>
<ul>
<li>build from dockerhub registry with a specific python version</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1">Image.from_registry(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"huanjason/scikit-learn"</span>, add_python<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.10</span>)</span></code></pre></div></div>
<ul>
<li>Conda</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1">Image.conda().conda_install(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"theano-pymc==1.1.2"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pymc3==3.11.2"</span>)</span></code></pre></div></div>
<ul>
<li>Poetry</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1">image <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> modal.Image.debian_slim(python_version<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"3.10"</span>).poetry_install_from_file(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pyproject.toml"</span>, without<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dev"</span>])</span></code></pre></div></div>
<ul>
<li>from local Dockerfile</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1">Image.from_dockerfile(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Dockerfile"</span>)</span></code></pre></div></div>
<ul>
<li>Or any combinations (also supports poetry) and with custom <code>run_function</code></li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> download_models():</span>
<span id="cb29-2">    <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sentence_transformers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> SentenceTransformer</span>
<span id="cb29-3"></span>
<span id="cb29-4">    SentenceTransformer(settings.EMBEDDING_MODEL_NAME, cache_folder<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>EMBEDDING_MODEL_DIR)</span>
<span id="cb29-5"></span>
<span id="cb29-6">image <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb29-7">    modal.Image.debian_slim(python_version<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"3.10"</span>)</span>
<span id="cb29-8">    .env({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ENV"</span>: ENV})</span>
<span id="cb29-9">    .run_commands(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"python -m pip install --upgrade pip"</span>)</span>
<span id="cb29-10">    .poetry_install_from_file(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pyproject.toml"</span>, without<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dev"</span>])</span>
<span id="cb29-11">    .pip_install(</span>
<span id="cb29-12">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"torch==2.1.0+cu118"</span>,</span>
<span id="cb29-13">        find_links<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://download.pytorch.org/whl/torch_stable.html"</span>,</span>
<span id="cb29-14">    )</span>
<span id="cb29-15">    .env({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"HF_HUB_ENABLE_HF_TRANSFER"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1"</span>})</span>
<span id="cb29-16">    .env({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"TRANSFORMERS_CACHE"</span>: EMBEDDING_MODEL_DIR})</span>
<span id="cb29-17">    .run_function(download_models)</span>
<span id="cb29-18">)</span></code></pre></div></div>
<p>If you have suffered from Python lack of proper dependency management, you will like this very powerful approach (yes, there are some caveat in mixing but you get the point). Also we can see how much it would<em>save</em>us from write our own Dockerfile, downloading the modal and include it in the image.</p>
<p>So far, we have established the mental model behind Modal (stubbed) functions as containers and how dependencies can be specified but for running a full-fledge app in cloud Modal defines its own resources. To start, similar to how docker-compose or k8s have the notion of Volume and Secrets, those can be specified in the stub too.</p>
</section>
<section id="modal.secret" class="level3">
<h3 class="anchored" data-anchor-id="modal.secret"><code>Modal.Secret</code></h3>
<p>For example, Secrets can either be defined and set via Modal‚Äôs dashboard or from <code>.env</code> file</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1">secret <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> modal.Secret.from_dotenv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".env"</span>))</span>
<span id="cb30-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@stub.function</span>(</span>
<span id="cb30-3">    image<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>image,</span>
<span id="cb30-4">    secret<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>secret)</span>
<span id="cb30-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> example():</span>
<span id="cb30-6">    ....</span></code></pre></div></div>
</section>
<section id="modal.volume-and-modal.networkfilesystem" class="level3">
<h3 class="anchored" data-anchor-id="modal.volume-and-modal.networkfilesystem"><code>Modal.Volume</code> and <code>Modal.NetworkFileSystem</code></h3>
<p>Volume is almost the same. As of writing this post, Modal has two ways to include Volume.<em><code>modal.Volume</code>: mutable volume built for high-performance file serving</em><code>modal.NetworkFileSystem</code>: A shared, writable file system accessible by one or more Modal functions.</p>
<p>Both must be attached to the stub like <code>stub.volume</code> and mapped in <code>@stub.function</code> runtime</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pathlib</span>
<span id="cb31-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> modal</span>
<span id="cb31-3"></span>
<span id="cb31-4">p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pathlib.Path(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/root/foo/bar.txt"</span>)</span>
<span id="cb31-5"></span>
<span id="cb31-6">stub <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> modal.Stub()</span>
<span id="cb31-7">stub.volume <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> modal.Volume.new()</span>
<span id="cb31-8"></span>
<span id="cb31-9"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@stub.function</span>(volumes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/root/foo"</span>: stub.volume})</span>
<span id="cb31-10"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> f():</span>
<span id="cb31-11">    p.write_text(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hello"</span>)</span>
<span id="cb31-12">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Created </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb31-13">    stub.volume.commit()  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Persist changes</span></span>
<span id="cb31-14">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Committed </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div></div>
<p>and</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> modal</span>
<span id="cb32-2"></span>
<span id="cb32-3">stub <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> modal.Stub()</span>
<span id="cb32-4">volume <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> modal.NetworkFileSystem.new()</span>
<span id="cb32-5"></span>
<span id="cb32-6"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@stub.function</span>(network_file_systems<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/root/foo"</span>: volume})</span>
<span id="cb32-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> f():</span>
<span id="cb32-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">pass</span></span>
<span id="cb32-9"></span>
<span id="cb32-10"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@stub.function</span>(network_file_systems<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/root/goo"</span>: volume})</span>
<span id="cb32-11"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> g():</span>
<span id="cb32-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">pass</span></span></code></pre></div></div>
<p>Both can also be examined with CLI too, <code>modal volume</code> and <code>modal nfs</code>.</p>
<p>Other resources like CPU/GPU, memory and more runtime configurations are also supported. For example,</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@stub.function</span>(</span>
<span id="cb33-2">    image<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>image,</span>
<span id="cb33-3">    secret<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>secret,</span>
<span id="cb33-4">    concurrency_limit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,</span>
<span id="cb33-5">    cpu<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,</span>
<span id="cb33-6">    gpu<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"t4"</span>,</span>
<span id="cb33-7">    memory<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span></span>
<span id="cb33-8">    timeout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span>,</span>
<span id="cb33-9">    keep_warm<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb33-10">    cloud<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"aws"</span>, <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># as of now, 'aws', 'gcp' and oracle cloud are supported</span></span>
<span id="cb33-11">)</span>
<span id="cb33-12"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@modal.asgi_app</span>(label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"server"</span>)</span>
<span id="cb33-13"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> main() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> Callable:</span>
<span id="cb33-14">    app <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_app()</span>
<span id="cb33-15">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> app</span></code></pre></div></div>
<p><a href="https://modal.com/pricing">Billing</a> is also pay as you go.</p>
</section>
<section id="build-time-vs-runtime-mental-model" class="level3">
<h3 class="anchored" data-anchor-id="build-time-vs-runtime-mental-model">Build time vs Runtime Mental Model</h3>
<p>Understanding the distinctions is very important for writing working apps. Anything that is defined<strong>outside</strong>of decorated stub using Modal constructs such as<strong>Image, Secret etc. are build time</strong>whereas anything that‚Äôs specified<strong>inside <code>@stub.function(...)</code> or <code>@stub.cls(...)</code> is for runtime</strong>.</p>
<p>For example,</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1">secret <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> modal.Secret.from_dotenv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".env"</span>))</span>
<span id="cb34-2">image <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb34-3">    modal.Image.debian_slim(python_version<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"3.10"</span>)</span>
<span id="cb34-4">    .env({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ENV"</span>: ENV})</span>
<span id="cb34-5">    .run_commands(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"python -m pip install --upgrade pip"</span>)</span>
<span id="cb34-6">    .poetry_install_from_file(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pyproject.toml"</span>, without<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dev"</span>])</span>
<span id="cb34-7">)</span></code></pre></div></div>
<p>are happening at build time so <code>ENV</code> and <code>.env</code> must be available at the build time (including the imports) and the runtime specifications is done as usual. At the runtime, Modal allocates cloud resources, injects image, secrets etc. and runs our application.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@stub.function</span>(</span>
<span id="cb35-2">    image<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>image,</span>
<span id="cb35-3">    secret<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>secret,</span>
<span id="cb35-4">    cpu<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,</span>
<span id="cb35-5">    gpu<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"any"</span>,</span>
<span id="cb35-6">    memory<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,</span>
<span id="cb35-7">    cloud<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"aws"</span>,</span>
<span id="cb35-8">)</span>
<span id="cb35-9"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> main():</span>
<span id="cb35-10">    ...</span></code></pre></div></div>
</section>
<section id="web-endpoints" class="level3">
<h3 class="anchored" data-anchor-id="web-endpoints">Web Endpoints</h3>
<p>Another advantage of Modal is it can turn<strong>any function</strong>to a web endpoint via <code>@web_enpoint</code>. It basically wraps the function in a FastAPI app. It can also work with any WSGI and ASGI compliant frameworks as well, including Flask, FastAPI, Sanic etc.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> modal <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Stub, web_endpoint</span>
<span id="cb36-2"></span>
<span id="cb36-3">stub <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Stub()</span>
<span id="cb36-4"></span>
<span id="cb36-5"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@stub.function</span>()</span>
<span id="cb36-6"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@web_endpoint</span>()</span>
<span id="cb36-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> f():</span>
<span id="cb36-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hello world!"</span></span></code></pre></div></div>
<p>For development, we can use <code>modal serve lib/hello_server.py</code> which supports hot-reloading of local changes automatically. And for deployment the usual <code>modal deploy</code> just works. See <a href="https://modal.com/docs/guide/webhooks">official docs</a>.</p>
<p>This works nicely esp.&nbsp;for rapid development, however, in my opinion when the number of endpoints grows it‚Äôs better to use the normal FastAPI or Flask way and hand it to Modal for serving via <code>@asgi_app</code> or <code>@wsgi_app</code>, respectively.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> fastapi <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> FastAPI, Request</span>
<span id="cb37-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> fastapi.responses <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> HTMLResponse</span>
<span id="cb37-3"></span>
<span id="cb37-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> modal <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Image, Stub, asgi_app</span>
<span id="cb37-5"></span>
<span id="cb37-6">web_app <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> FastAPI()</span>
<span id="cb37-7">stub <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Stub()</span>
<span id="cb37-8">image <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Image.debian_slim().pip_install(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"boto3"</span>)</span>
<span id="cb37-9"></span>
<span id="cb37-10"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@web_app.post</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/foo"</span>)</span>
<span id="cb37-11"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> foo(request: Request):</span>
<span id="cb37-12">    body <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> request.json()</span>
<span id="cb37-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> body</span>
<span id="cb37-14"></span>
<span id="cb37-15"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@web_app.get</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/bar"</span>)</span>
<span id="cb37-16"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> bar(arg<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"world"</span>):</span>
<span id="cb37-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> HTMLResponse(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"&lt;h1&gt;Hello Fast </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>arg<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">!&lt;/h1&gt;"</span>)</span>
<span id="cb37-18"></span>
<span id="cb37-19"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@stub.function</span>(image<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>image)</span>
<span id="cb37-20"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@asgi_app</span>()</span>
<span id="cb37-21"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> fastapi_app():</span>
<span id="cb37-22">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> web_app</span></code></pre></div></div>
</section>
<section id="modal-supports-crob-jobs-tunnel-sandbox-and-more" class="level3">
<h3 class="anchored" data-anchor-id="modal-supports-crob-jobs-tunnel-sandbox-and-more">Modal Supports Crob-jobs, Tunnel, Sandbox and more</h3>
<p>There are more resource objects available. Make sure to check out the <a href="https://modal.com/docs/guide">official guide</a> and <a href="https://modal.com/docs/reference">reference doc</a>. Some of the important ones are<em>Dict: distributed dictionary</em>Queue: distributed queue backed by Redis<em>Volume</em>Network Filesystem (NFS)<em>Period (for Cron jobs)</em>Secrets<em>Tunnel</em>‚Ä¶</p>
</section>
</section>
<section id="modal-launch-jupytervscode" class="level2">
<h2 class="anchored" data-anchor-id="modal-launch-jupytervscode"><code>modal launch jupyter</code>/<code>vscode</code></h2>
<p>Modal CLI has the option of<strong>launching jupyter or vscode from modal by also configuring CPU/GPU and memory as needed</strong>. This essentially makes manual SSHing and to EC2 instances<em>obsolete</em>. Jupyter is a great tool for exploratory part of ML such as<strong>training</strong>. The vscode is just another cherry on top. Here I have launched vscode with T4 GPU using</p>
<p><code>modal launch vscode --gpu T4</code></p>
<p><a href="https://ehsanmkermani.com/wp-content/uploads/2023/12/modal-vscode.png"><img src="https://ehsanmkermani.com/posts/2023-12-08-modal-labs-deep-dive/images/modal-vscode-1024x383.png" class="img-fluid"></a></p>
<p>The CLI command is basically running the following which you can customize as well.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Copyright Modal Labs 2023</span></span>
<span id="cb38-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># type: ignore</span></span>
<span id="cb38-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb38-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> secrets</span>
<span id="cb38-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> socket</span>
<span id="cb38-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> subprocess</span>
<span id="cb38-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> threading</span>
<span id="cb38-8"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> time</span>
<span id="cb38-9"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> webbrowser</span>
<span id="cb38-10"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> typing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Any</span>
<span id="cb38-11"></span>
<span id="cb38-12"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> modal <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Image, Queue, Stub, forward</span>
<span id="cb38-13"></span>
<span id="cb38-14">args: Any <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cpu'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'memory'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32768</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'gpu'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'T4'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'timeout'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3600</span>}</span>
<span id="cb38-15"></span>
<span id="cb38-16">stub <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Stub()</span>
<span id="cb38-17">stub.image <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Image.from_registry(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"codercom/code-server"</span>, add_python<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"3.11"</span>).dockerfile_commands(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ENTRYPOINT []"</span>)</span>
<span id="cb38-18">stub.q <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Queue.new()</span>
<span id="cb38-19"></span>
<span id="cb38-20"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> wait_for_port(data):</span>
<span id="cb38-21">    start_time <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> time.monotonic()</span>
<span id="cb38-22">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">while</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>:</span>
<span id="cb38-23">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb38-24">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> socket.create_connection((<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"localhost"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8080</span>), timeout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">15.0</span>):</span>
<span id="cb38-25">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">break</span></span>
<span id="cb38-26">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">OSError</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> exc:</span>
<span id="cb38-27">            time.sleep(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>)</span>
<span id="cb38-28">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> time.monotonic() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> start_time <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">15.0</span>:</span>
<span id="cb38-29">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">raise</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">TimeoutError</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Waited too long for port 8080 to accept connections"</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> exc</span>
<span id="cb38-30">    stub.q.put(data)</span>
<span id="cb38-31"></span>
<span id="cb38-32"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@stub.function</span>(cpu<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>args[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cpu"</span>], memory<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>args[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"memory"</span>], gpu<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>args[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpu"</span>], timeout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>args[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"timeout"</span>])</span>
<span id="cb38-33"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> run_jupyter():</span>
<span id="cb38-34">    os.chdir(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/home/coder"</span>)</span>
<span id="cb38-35">    token <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> secrets.token_urlsafe(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">13</span>)</span>
<span id="cb38-36">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> forward(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8080</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> tunnel:</span>
<span id="cb38-37">        url <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tunnel.url</span>
<span id="cb38-38">        threading.Thread(target<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>wait_for_port, args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>((url, token),)).start()</span>
<span id="cb38-39">        subprocess.run(</span>
<span id="cb38-40">            [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/usr/bin/entrypoint.sh"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"--bind-addr"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"0.0.0.0:8080"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"."</span>],</span>
<span id="cb38-41">            env<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>os.environ, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SHELL"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/bin/bash"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"PASSWORD"</span>: token},</span>
<span id="cb38-42">        )</span>
<span id="cb38-43">    stub.q.put(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"done"</span>)</span>
<span id="cb38-44"></span>
<span id="cb38-45"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@stub.local_entrypoint</span>()</span>
<span id="cb38-46"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> main():</span>
<span id="cb38-47">    stub.run_jupyter.spawn()</span>
<span id="cb38-48">    url, token <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stub.q.get()</span>
<span id="cb38-49">    time.sleep(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Give Jupyter a chance to start up</span></span>
<span id="cb38-50">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">VS Code on Modal, opening in browser..."</span>)</span>
<span id="cb38-51">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"   -&gt; </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>url<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb38-52">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"   -&gt; password: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>token<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb38-53">    webbrowser.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(url)</span>
<span id="cb38-54">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> stub.q.get() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"done"</span></span></code></pre></div></div>
</section>
<section id="best-practices" class="level2">
<h2 class="anchored" data-anchor-id="best-practices">Best Practices</h2>
<p>Since Modal is new there are almost no written best practices available. Here are my suggestions after using Modal for almost a year and trying many things</p>
<section id="single-stub-vs-multi-stub" class="level3">
<h3 class="anchored" data-anchor-id="single-stub-vs-multi-stub">Single stub vs Multi-stub</h3>
<p>Initially there seems to be a tendency to create one<em>new</em>stub per Modal function or class and use CLI to run / deploy each. If the application is simple and only a couple of stubs are used, is fine but using a single stub is not only possible also definitely more convenient for running, testing and deploying apps. In fact,<em>a single stub can contain any number of functions and each scale independently</em>. So<strong>deploy all together and scale independently</strong>is the idea here. At the root of my Python applications, I have</p>
<pre class="text"><code>myapp /
    __init__.py
    stub.py
    app /
        api.py
    services /
        service1.py
        service2.py</code></pre>
<p>where <code>stub.py</code> defined a global stub like</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> modal</span>
<span id="cb40-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> myapp.settings <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> get_settings</span>
<span id="cb40-3"></span>
<span id="cb40-4">settings <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_settings()</span>
<span id="cb40-5">stub <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> modal.Stub(settings.STUB_NAME)</span>
<span id="cb40-6">stub.queue <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> modal.Queue.new().persisted(label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>settings.STUB_QUEUE_NAME)</span></code></pre></div></div>
<p>and I import<strong>all</strong>the modules that use the stub in the root <code>__init__.py</code></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb41" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> myapp.api.app <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span></span>
<span id="cb41-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> myapp.services.service1 <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span></span>
<span id="cb41-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> myapp.services.service2 <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span></span></code></pre></div></div>
<p>In Python, this is not necessarily a good practice for libraries but for Modal apps is<em>fine</em>.</p>
<p>Having this allows running the entire application with a single command <code>modal deploy myapp</code> without specifying which stub to be deployed.</p>
</section>
<section id="testing-via-stub.local_entrypoint" class="level3">
<h3 class="anchored" data-anchor-id="testing-via-stub.local_entrypoint">Testing via <code>@stub.local_entrypoint()</code></h3>
<p>We can test each individual Modal function via <code>@stub.local_entrypoint()</code>. For example, in <code>services/service1.py</code>, we can have a embedding service and test it using</p>
<p><code>ENV=test modal run myapp/services/service1.py</code></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb42" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pathlib <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Path</span>
<span id="cb42-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> typing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> List</span>
<span id="cb42-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb42-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> tqdm</span>
<span id="cb42-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> modal</span>
<span id="cb42-6"></span>
<span id="cb42-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> myapp.settings <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> get_settings</span>
<span id="cb42-8"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> myapp.stub <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> stub</span>
<span id="cb42-9"></span>
<span id="cb42-10">settings <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_settings()</span>
<span id="cb42-11">secret <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> modal.Secret.from_dotenv( <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".env"</span>))</span>
<span id="cb42-12"></span>
<span id="cb42-13"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> download_models():</span>
<span id="cb42-14">    ...</span>
<span id="cb42-15"></span>
<span id="cb42-16">image <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb42-17">    modal.Image.debian_slim(python_version<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"3.10"</span>)</span>
<span id="cb42-18">    ...</span>
<span id="cb42-19">    .run_function(download_models)</span>
<span id="cb42-20">)</span>
<span id="cb42-21"></span>
<span id="cb42-22"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@stub.cls</span>(image<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>image, secret<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>secret)</span>
<span id="cb42-23"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> BatchEmbedding:</span>
<span id="cb42-24">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__enter__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb42-25">        <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sentence_transformers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> SentenceTransformer</span>
<span id="cb42-26"></span>
<span id="cb42-27">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> SentenceTransformer(</span>
<span id="cb42-28">            settings.EMBEDDING_MODEL_NAME,</span>
<span id="cb42-29">            cache_folder<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>EMBEDDING_MODEL_DIR,</span>
<span id="cb42-30">        )</span>
<span id="cb42-31">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span></span>
<span id="cb42-32"></span>
<span id="cb42-33">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@modal.method</span>()</span>
<span id="cb42-34">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> embed(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, texts) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> np.ndarray:</span>
<span id="cb42-35">        vectors <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.model.encode(</span>
<span id="cb42-36">            texts,</span>
<span id="cb42-37">            show_progress_bar<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb42-38">            batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>settings.EMBED_BATCH_SIZE,</span>
<span id="cb42-39">        )</span>
<span id="cb42-40">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> vector</span>
<span id="cb42-41"></span>
<span id="cb42-42"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> DocumentEmbeddingFn:</span>
<span id="cb42-43">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__call__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, document: Document) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> List[np.ndarray]:</span>
<span id="cb42-44">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(document):</span>
<span id="cb42-45">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> []</span>
<span id="cb42-46"></span>
<span id="cb42-47">        batches: List[List[TextDoc]] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb42-48">            document.chunks[i : i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> settings.EMBED_BATCH_SIZE]</span>
<span id="cb42-49">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(document), settings.EMBED_BATCH_SIZE)</span>
<span id="cb42-50">        ]</span>
<span id="cb42-51">        chunked_batches: List[List[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>]] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [[chunk.text <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> chunk <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> batch] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> batch <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> batches <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(batch)]</span>
<span id="cb42-52">        vectors: List[np.ndarray] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb42-53">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> batch <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> tqdm(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(BatchEmbedding().embed.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">map</span>(chunked_batches))):</span>
<span id="cb42-54">            vectors.extend(batch)</span>
<span id="cb42-55"></span>
<span id="cb42-56">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> vectors</span>
<span id="cb42-57"></span>
<span id="cb42-58"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> settings.ENV <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"test"</span>:</span>
<span id="cb42-59">    <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> io</span>
<span id="cb42-60">    <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pathlib <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Path</span>
<span id="cb42-61">    <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> fastapi <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> UploadFile</span>
<span id="cb42-62"></span>
<span id="cb42-63">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@stub.local_entrypoint</span>()</span>
<span id="cb42-64">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> test_embedding():</span>
<span id="cb42-65">        logger.info(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Testing embedding service with sample PDF file"</span>)</span>
<span id="cb42-66">        data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Path(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">__file__</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tests/data.pdf"</span></span>
<span id="cb42-67">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(data), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rb"</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> fin:</span>
<span id="cb42-68">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">file</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> UploadFile(</span>
<span id="cb42-69">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">file</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>io.BytesIO(fin.read()),</span>
<span id="cb42-70">                filename<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data.pdf"</span>,</span>
<span id="cb42-71">            )</span>
<span id="cb42-72">        doc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ..</span>
<span id="cb42-73">        embeddings <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DocumentEmbeddingFn()(doc)</span>
<span id="cb42-74">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(embeddings) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(doc)</span></code></pre></div></div>
</section>
<section id="managing-dependencies" class="level3">
<h3 class="anchored" data-anchor-id="managing-dependencies">Managing Dependencies</h3>
<p>If you‚Äôre like me who want all dependencies to be in the same place as much as possible, I recommend using Poetry and grouping your dependencies. The simplest default case is including <code>dev</code> dependencies. Modal <code>Image</code> can build them using</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1">poetry_install_from_file(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pyproject.toml"</span>, without<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dev"</span>])</span></code></pre></div></div>
<p>It‚Äôs also possible to have a fine-grained grouping like the following in <code>pyproject.toml</code></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb44" style="background: #f1f3f5;"><pre class="sourceCode toml code-with-copy"><code class="sourceCode toml"><span id="cb44-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[tool.poetry.dependencies]</span></span>
<span id="cb44-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">python</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&gt;=3.10,&lt;3.12"</span></span>
<span id="cb44-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">modal</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"^0.52.3366"</span></span>
<span id="cb44-4"></span>
<span id="cb44-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[tool.poetry.core.dependencies]</span></span>
<span id="cb44-6"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">numpy</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"^1.20.0"</span></span>
<span id="cb44-7"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">pydantic</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"^2.3.0"</span></span>
<span id="cb44-8"></span>
<span id="cb44-9"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[tool.poetry.db.dependencies]</span></span>
<span id="cb44-10"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">pymongo</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{ </span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">version</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"^4.5"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">, </span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">extras</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> =</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"srv"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">] }</span></span>
<span id="cb44-11"></span>
<span id="cb44-12"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[tool.poetry.service1.dependencies]</span></span>
<span id="cb44-13"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">...</span></span>
<span id="cb44-14"></span>
<span id="cb44-15"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[tool.poetry.service2.dependencies]</span></span>
<span id="cb44-16"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">...</span></span></code></pre></div></div>
<p>and build each stubbed function or class image using</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb45" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1">poetry_install_from_file(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pyproject.toml"</span>, with_<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"core"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"db"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"service1"</span>])</span></code></pre></div></div>
<p>this way centralizes the dependencies and makes upgrading and managing them easier esp.&nbsp;for medium to large projects than inlining them via <code>Image.debian_image().pip_install(...)</code>.</p>
</section>
<section id="observability" class="level3">
<h3 class="anchored" data-anchor-id="observability">Observability</h3>
<p>Modal offers granular logs for each functions as well as usage. I‚Äôve been using <a href="https://sentry.io/welcome/">Sentry</a> along side Modal and hasn‚Äôt disappointed me all at. I‚Äôve found its distributed tracing and performance monitoring adequate which help debugging eps. at times when finding the relevant stacktraces is hard from the Modal logs.</p>
</section>
</section>
<section id="acknowledgement" class="level2">
<h2 class="anchored" data-anchor-id="acknowledgement">Acknowledgement</h2>
<p>I want to thank Modal engineers in particular <a href="https://twitter.com/akshat_b">Akshat Bubna</a> (Modal‚Äôs co-founder), <a href="https://twitter.com/jonobelotti_IO">Jonathon Belotti</a> and <a href="https://twitter.com/luiscape">Luis Capelo</a> for their immense help, patient and being very responsive to my queries throughout using Modal. From my experience, Modal‚Äôs customer service is fantastic despite it being run by small developer team.</p>


</section>

 ]]></description>
  <category>DeepDive</category>
  <category>Framework</category>
  <guid>https://ehsanmkermani.com/posts/2023-12-08-modal-labs-deep-dive/</guid>
  <pubDate>Fri, 08 Dec 2023 00:00:00 GMT</pubDate>
</item>
<item>
  <title>The Core of Attention is Communication</title>
  <dc:creator>Ehsan M. Kermani</dc:creator>
  <link>https://ehsanmkermani.com/posts/2023-11-23-the-core-of-attention-is-communication/</link>
  <description><![CDATA[ 





<p>Over the past year, perhaps the most cited paper across the software industry is <a href="https://arxiv.org/abs/1706.03762">Attention is All You Need</a> that is at the heart of ChatGPT and GPT transformer models. The first thing you will notice in the paper is the Attention formula:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Ctext%7BAttention(Q,%20K,%20V)%7D%20=%20%5Ctext%7Bsoftmax%7D(%5Cfrac%7BQK%5ET%7D%7B%5Csqrt%7Bd%5C_k%7D%7D)V"></p>
<p>Unfortunately, very few sources have delved into where this has come from i.e.&nbsp;the core of the attention mechanism, and most explanations provide little to no intuition. For example, the celebrated <a href="https://jalammar.github.io/illustrated-transformer/">illustrated transformer</a> says</p>
<blockquote class="blockquote">
<p>What are the ‚Äúquery‚Äù, ‚Äúkey‚Äù, and ‚Äúvalue‚Äù vectors?</p>
<p>They‚Äôre abstractions that are useful for calculating and thinking about attention. Once you proceed with reading how attention is calculated below, you‚Äôll know pretty much all you need to know about the role each of these vectors plays.</p>
</blockquote>
<p>Well, squinting my eyes here! That‚Äôs not enough for my taste. Now we are going to put ourselves in the mind of the authors of the paper and try to rediscover such formula.</p>
<section id="rediscovering-attention" class="level2">
<h2 class="anchored" data-anchor-id="rediscovering-attention">Rediscovering Attention</h2>
<p>Interestingly, the of core attention has<em>nothing</em>to do with Deep Learning.<strong>Attention is in fact a communication mechanism in a graph / network</strong>. Let me explain how. Given a directed graph <img src="https://latex.codecogs.com/png.latex?G%20=%20(N,%20E)">, where <img src="https://latex.codecogs.com/png.latex?N"> is the set of nodes and <img src="https://latex.codecogs.com/png.latex?E"> a set of edges, we can associate<strong>two</strong>pieces of information to each node <img src="https://latex.codecogs.com/png.latex?n">;<strong>(key, query)</strong>where key is the ‚Äú<em>identity</em>‚Äù of the node, query is what the<em>node is looking for and is interested in finding</em>. (Note there is no value piece yet). Take the following directed graph. The red arrows from the view point of node <img src="https://latex.codecogs.com/png.latex?n">. The key is the self-arrow and the rest of the arrows make up the query piece. We haven‚Äôt yet defined key and query.</p>
<p><a href="https://ehsanmkermani.com/wp-content/uploads/2023/11/attention-graph-1.png"><img src="https://ehsanmkermani.com/posts/2023-11-23-the-core-of-attention-is-communication/images/attention-graph-1.png" class="img-fluid"></a></p>
<p>We can parameterize key and query and represent them as (learnable) vectors (in PyTorch <code>nn.Parameter</code>). So now looking at other nodes key vectors, the node <img src="https://latex.codecogs.com/png.latex?n"> can find its interest / ‚Äúattention‚Äù score by for example computing cosine similarity (cosSim) between its query and the key of every other neighbours (connected to) i.e.&nbsp;<img src="https://latex.codecogs.com/png.latex?%5Ctext%7BcosSim%7D(w%5C_q,%20%5Chat%7Bw%7D%5C_k)"></p>
<p>and gathering all the similarity scores in a vector</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Ctext%7Bscores%7D%20=%20(%5Ctext%7BcosSim%7D(w%5C_q,%20%5Chat%7Bw%7D%5C_1),%20%5Ctext%7BcosSim%7D(w%5C_q,%20%5Chat%7Bw%7D%5C_2),%20...,%20%5Ctext%7BcosSim%7D(w%5C_q,%20%5Chat%7Bw%7D%5C_m))"></p>
<p>So far so good! now what to do with this similarity vector? we need to include another piece which is the<strong>value</strong>. This value is the internal representation of nodes so for <img src="https://latex.codecogs.com/png.latex?n"> let‚Äôs denote it by <img src="https://latex.codecogs.com/png.latex?w%5C_v"> (note it‚Äôs parameterized to be learned). Normally, we would start with some value. For example in the NLP, node / token embedding and adjust that iteratively. But for now, we can assume the value vector is given so we update it by the discovered similarity scores for example by element-wise multiplication</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Ctext%7Bscores%7D%20%5Codot%20w%5C_v"></p>
<p>Note it doesn‚Äôt have to be element-wise multiplication but that seems to be the simplest case here. Now, recall</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Ctext%7BcosSim%7D(a,%20b)%20=%20%5Cfrac%7Bab%5ET%7D%7B%5C%7C%20a%5C%7C%20%5C%7C%20b%20%5C%7C%7D"></p>
<p>so</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Ctext%7Bscores%7D%20=%20(%5Ctext%7BcosSim%7D(w%5C_q,%20%5Chat%7Bw%7D%5C_1),%20%5Ctext%7BcosSim%7D(w%5C_q,%20%5Chat%7Bw%7D%5C_2),%20...,%20%5Ctext%7BcosSim%7D(w%5C_q,%20%5Chat%7Bw%7D%5C_m))"></p>
<p>is<em>almost</em>equivalent to</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Ctext%7BcosSim%7D(w%5C_q%20W%5C_k%5ET)"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?W%5C_k"> is a matrix formed by stacked all keys in rows. Note here, we have to be careful about full vector-matrix multiplication because we need to only multiply <img src="https://latex.codecogs.com/png.latex?w%5C_q"> to the keys of its neighbours. Let‚Äôs simplify and put that details aside. So as you can see the final rediscovered attention formula from the view point of a single node <img src="https://latex.codecogs.com/png.latex?n"> is</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Ctext%7BcosSim%7D(w%5C_q%20W%5C_k%5ET)%20w%5C_v"></p>
<p>or putting the ‚Äúweights‚Äù <img src="https://latex.codecogs.com/png.latex?w%5C_%5Cstar"> down</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Ctext%7BcosSim%7D(q%20K%5ET)%20v"></p>
<p>and going for all nodes by stacking their vectors into matrices, we will get at</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Ctext%7BcosSim%7D(QK%5ET)%20V"></p>
<p>it‚Äôs not hard to see it resembles the original attention formula</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Ctext%7Bsoftmax%7D(%5Cfrac%7BQK%5ET%7D%7B%5Csqrt%7Bd%5C_k%7D%7D)V"></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1">dim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span></span>
<span id="cb1-2">w_q <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nn.Parameter(torch.randn(dim))</span>
<span id="cb1-3">W_k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nn.Parameter(torch.randn(dim, dim))</span>
<span id="cb1-4">w_v <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nn.Parameter(torch.randn(dim))</span>
<span id="cb1-5">attention_scores <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> w_q <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W_k</span>
<span id="cb1-6">attention_weights <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.softmax(attention_scores, dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb1-7">output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> attention_weights <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> w_v</span></code></pre></div></div>
<p>In fact, <img src="https://latex.codecogs.com/png.latex?%5Ctext%7BcosSim%7D"> was replaced with <img src="https://latex.codecogs.com/png.latex?%5Ctext%7Bsoftmax%7D"> (and the additional <img src="https://latex.codecogs.com/png.latex?%5Csqrt%7Bd%5C_k%7D"> normalization). Also it turns out the <img src="https://latex.codecogs.com/png.latex?%5Ctext%7BcosSim%7D"> version is called<strong>Content-base attention</strong>and is used in <a href="https://arxiv.org/pdf/1410.5401.pdf">Neural Turing Machine</a>. In fact, others have tried different ‚Äúadjustments‚Äù to the formula as highlighted <a href="https://lilianweng.github.io/posts/2018-06-24-attention/#summary">here</a>.</p>
</section>
<section id="how-does-this-formulation-map-to-graphs-from-nlp-cv-etc" class="level2">
<h2 class="anchored" data-anchor-id="how-does-this-formulation-map-to-graphs-from-nlp-cv-etc">How does this formulation map to graphs from NLP, CV etc?</h2>
<p>NLP and Vision make explicit use of it by creating the graph suitable for their tasks. For example, in (Causal) Language Model (LM) the core of (GPT) attention graph looks like</p>
<p><a href="https://ehsanmkermani.com/wp-content/uploads/2023/11/lm-graph.png"><img src="https://ehsanmkermani.com/posts/2023-11-23-the-core-of-attention-is-communication/images/lm-graph.png" class="img-fluid"></a></p>
<p>It is auto-regressive i.e.&nbsp;only past informations / edges are allowed so with a proper mask (lower-triangular matrix) we can zero out the future information</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1">attention_scores <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> w_q <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W_k</span>
<span id="cb2-2">tril <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tril(torch.ones(T, T)) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># lower-triangle matrix of 1s</span></span>
<span id="cb2-3">attention_scores <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> attention_scores.masked_fill(tril <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'-inf'</span>)) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># masks the future and set to -inf</span></span>
<span id="cb2-4">attention_weights <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.softmax(attention_scores, dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb2-5">output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> attention_weights <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> w_v</span></code></pre></div></div>
<p>Or in Vision, the attention graph of the vision transformer model (ViT) from <a href="https://arxiv.org/pdf/2010.11929.pdf">An Image is Worth 16 x 16 Words</a> looks like this (complete graph i.e.&nbsp;all nodes are connected to each other)</p>
<p><a href="https://ehsanmkermani.com/wp-content/uploads/2023/11/cv-graph-2.png"><img src="https://ehsanmkermani.com/posts/2023-11-23-the-core-of-attention-is-communication/images/cv-graph-2-1024x389.png" class="img-fluid"></a></p>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>We tried to rediscover the attention formula and did it by putting the attention in a higher context i.e.<em>communication in a graph</em>. Note that depending on the task and the graph at hand we need to make adjustments like in the LM case, by masking out future information. Also the general notion of Attention has no notion of position and that is why encoding and incorporating positions i.e.&nbsp;positional encoding in LM is important. The complexity grows from here and we can create Multi-Head Attention and even more general Cross-Attention (with encoder-decoder). But these are less important than the core intuition I wanted to give in this post. Hope this post has clarified attention and the intuition behind it. If you are interested in more detail implementation of the Attention-is-all-You-Need paper, I recommend checking out annotated implementation in <a href="https://nn.labml.ai/transformers/mha.html">labm</a><a href="https://nn.labml.ai/transformers/index.html">l</a>.</p>


</section>

 ]]></description>
  <category>Machine Learning</category>
  <guid>https://ehsanmkermani.com/posts/2023-11-23-the-core-of-attention-is-communication/</guid>
  <pubDate>Thu, 23 Nov 2023 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Rust and Node.js: Harmonizing Performance and Safety</title>
  <dc:creator>Ehsan M. Kermani</dc:creator>
  <link>https://ehsanmkermani.com/posts/2023-11-19-rust-and-node-js-harmonizing-performance-and-safety/</link>
  <description><![CDATA[ 





<section id="prelude" class="level2">
<h2 class="anchored" data-anchor-id="prelude">Prelude</h2>
<p>In the Rust world, the interaction between Python and Rust is very well-known through the amazing <a href="https://github.com/PyO3/pyo3">PyO3</a> ecosystem. There is a similar relation between Python and Javascript in particular Node.js that I‚Äôm going to describe in this post. All the code is available <a href="https://github.com/ehsanmok/blog/tree/main/code/rust-node">here</a>.</p>
<p>Most programming language interactions happen through C layer ABI i.e.&nbsp;FFI. However, interacting Rust with JavaScript is commonly achieved through WebAssembly (WASM). Furthermore, Node.js (written in C++) <a href="https://nodejs.org/api/addons.html">addon-api</a> offers writing extending Node functionalities through C++ (FFI) without stepping into the WASM and the Rust ecosystem has created two frameworks on top<em><a href="https://github.com/napi-rs/napi-rs">napi-rs</a></em><a href="https://github.com/neon-bindings/neon">neon</a></p>
<p>We are going to explore neon as well since it is also the more mature alternative.</p>
<p>As a quick recap, companies such as <a href="https://dteare.medium.com/behind-the-scenes-of-1password-for-linux-d59b19143a23">1Password</a> and <a href="https://github.com/signalapp/libsignal">Signal</a> have adopted Rust in their Node applications, and more recently, a number of other companies like <a href="https://blog.logrocket.com/improving-node-js-performing-rust/">LogRocket</a> and <a href="https://blog.risingstack.com/node-js-native-modules-with-rust/">RisingStack</a> have supercharged their Node apps. They‚Äôve achieved this by delegating critical parts to Rust where Node.js falls short. Consequently, Rust enhances these applications with its memory and type safety, while also being more efficient in CPU and memory usage. This leads to orders of magnitude higher Requests Per Second (RPS), showcasing Rust‚Äôs robust capabilities in optimizing performance.</p>
<p>I‚Äôm assuming you have working <a href="https://www.rust-lang.org/tools/install">Rust toolchain</a> , NPM, <a href="https://nodejs.org/en/download/package-manager">Node.js</a>. Then install neon module with <code>npm i -g neon-cli</code>. First, the ‚Äúhello, world!‚Äù</p>
<ol type="1">
<li><code>npm init neon hello</code> creates</li>
</ol>
<pre class="text"><code>.
‚îú‚îÄ‚îÄ Cargo.toml
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ package.json
‚îî‚îÄ‚îÄ src
    ‚îî‚îÄ‚îÄ lib.rs
2 directories, 4 files</code></pre>
<p>The content of the preloaded <code>src/lib.rs</code> is</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode rust code-with-copy"><code class="sourceCode rust"><span id="cb2-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">use</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">neon::prelude::</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*;</span></span>
<span id="cb2-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fn</span> hello(<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">mut</span> cx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> FunctionContext) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> JsResult<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>JsString<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-3">    <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">Ok</span>(cx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>string(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hello node"</span>))</span>
<span id="cb2-4"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-5"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">#[</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">neon::</span>main<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb2-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fn</span> main(<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">mut</span> cx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> ModuleContext) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> NeonResult<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-7">    cx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>export_function(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hello"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> hello)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?;</span></span></code></pre></div></div>
<ol start="2" type="1">
<li><p><code>npm install</code> and</p></li>
<li><p>Run <code>node</code> prompt and</p></li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb3-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">require</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hello</span>()</span>
<span id="cb3-2"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'hello node'</span></span></code></pre></div></div>
<p>Super easy! All the compilation dependencies are included that calls for high DevX. For more details, check out the <a href="https://neon-bindings.com/docs/introduction">official neon documentation</a>.</p>
</section>
<section id="cheat-table" class="level2">
<h2 class="anchored" data-anchor-id="cheat-table">Cheat Table</h2>
<p>table { border-collapse: collapse; width: 100%; } th, td { border: 1px solid black; padding: 8px; text-align: left; }</p>
<table class="caption-top table">
<colgroup>
<col style="width: 33%">
<col style="width: 33%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th>Rust Neon Construct</th>
<th>Description</th>
<th>Example Usage</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>neon::prelude::*</code></td>
<td>Imports the essential traits and types for Neon modules.</td>
<td><code>use neon::prelude::*;</code></td>
</tr>
<tr class="even">
<td><code>FunctionContext&lt;'a&gt;</code></td>
<td>Represents the execution context of a JavaScript function call.</td>
<td><code>fn my_function(mut cx: FunctionContext) -&gt; JsResult&lt;JsValue&gt; { ... }</code></td>
</tr>
<tr class="odd">
<td><code>JsResult&lt;T&gt;</code></td>
<td>A result type for Neon functions, either <code>Ok(T)</code> or <code>Err(Throw)</code>.</td>
<td><code>fn my_function(...) -&gt; JsResult&lt;JsString&gt; { ... }</code></td>
</tr>
<tr class="even">
<td><code>JsValue</code></td>
<td>Represents any JavaScript value.</td>
<td><code>let js_value: Handle&lt;JsValue&gt; = cx.argument(0)?;</code></td>
</tr>
<tr class="odd">
<td><code>JsString</code>, <code>JsNumber</code>, etc.</td>
<td>Specific JavaScript value types.</td>
<td><code>let js_string: Handle&lt;JsString&gt; = cx.argument(0)?;</code></td>
</tr>
<tr class="even">
<td><code>Handle&lt;T&gt;</code></td>
<td>A handle to a JavaScript value, keeping it alive across the JS-Rust boundary.</td>
<td><code>let handle: Handle&lt;JsString&gt; = cx.argument(0)?;</code></td>
</tr>
<tr class="odd">
<td><code>ModuleContext&lt;'a&gt;</code></td>
<td>Represents the context of a module during initialization.</td>
<td><code>fn neon_module_init(cx: ModuleContext) -&gt; NeonResult&lt;()?&gt; { ... }</code></td>
</tr>
<tr class="even">
<td><code>register_module!</code></td>
<td>A macro to register the module with Node.js.</td>
<td><code>register_module!(cx, neon_module_init);</code></td>
</tr>
<tr class="odd">
<td><code>JsArray</code>, <code>JsObject</code></td>
<td>Types for JavaScript arrays and objects.</td>
<td><code>let js_array: Handle&lt;JsArray&gt; = JsArray::new(&amp;mut cx, 3);</code></td>
</tr>
<tr class="even">
<td><code>.to_string()</code>, <code>.to_number()</code>, etc.</td>
<td>Methods to convert Neon types to JavaScript types.</td>
<td><code>let js_num = cx.number(42.0).upcast&lt;JsValue&gt;();</code></td>
</tr>
<tr class="odd">
<td><code>cx.argument&lt;T&gt;(i)</code></td>
<td>Retrieves the <code>i</code>th argument of a function call.</td>
<td><code>let arg0: Handle&lt;JsString&gt; = cx.argument&lt;JsString&gt;(0)?;</code></td>
</tr>
<tr class="even">
<td><code>cx.throw_error()</code></td>
<td>Throws a JavaScript error from Rust.</td>
<td><code>cx.throw_error("Something went wrong")?;</code></td>
</tr>
<tr class="odd">
<td><code>cx.borrow()</code>, <code>cx.borrow_mut()</code></td>
<td>Borrows a reference to a JavaScript value.</td>
<td><code>let guard = cx.borrow(&amp;js_array);</code></td>
</tr>
</tbody>
</table>
</section>
<section id="resize-image-example" class="level2">
<h2 class="anchored" data-anchor-id="resize-image-example">Resize image example</h2>
<p>For another example, let‚Äôs say you want to enhance resizing jpeg image.</p>
<p><img src="https://ehsanmkermani.com/posts/2023-11-19-rust-and-node-js-harmonizing-performance-and-safety/images/cat.jpeg" class="img-fluid"><img src="https://ehsanmkermani.com/posts/2023-11-19-rust-and-node-js-harmonizing-performance-and-safety/images/resized_cat.jpeg" class="img-fluid"></p>
<ol type="1">
<li><code>npm init neon image-resize</code> and <code>cd image-resize</code></li>
<li>Then <code>cargo add image</code> and</li>
<li>Include the following in <code>src/lib.rs</code>. Check out the comments below</li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode rust code-with-copy"><code class="sourceCode rust"><span id="cb4-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">use</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">std::io::</span>Cursor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">use</span> image<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">use</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">neon::</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">prelude::</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*,</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">types::buffer::</span>TypedArray<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb4-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fn</span> resize_image(<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">mut</span> cx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> FunctionContext) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> JsResult<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>JsBuffer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Retrieve image buffer and dimensions from JavaScript arguments</span></span>
<span id="cb4-6">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> buffer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">argument::</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>JsBuffer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?;</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// &lt;- gets the first argument in node</span></span>
<span id="cb4-7">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> width <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">argument::</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>JsNumber<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?.</span>value(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">mut</span> cx) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">as</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">u32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-8">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> height <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">argument::</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>JsNumber<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?.</span>value(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">mut</span> cx) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">as</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">u32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-9">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Convert JS Buffer to a byte slice</span></span>
<span id="cb4-10">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> image_data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>[<span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">u8</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> buffer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>as_slice(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>cx)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-11">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Perform image resizing in rust</span></span>
<span id="cb4-12">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> img <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">image::</span>load_from_memory(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>image_data)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>expect(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Failed to load image from memory"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-13">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> resized <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> img<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>resize(width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> height<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">image::imageops::FilterType::</span>Nearest)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-14">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">mut</span> resized_buffer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">Cursor::</span>new(<span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Vec</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">::</span>new())<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-15">    resized</span>
<span id="cb4-16">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>write_to(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">mut</span> resized_buffer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">image::ImageOutputFormat::</span>Jpeg(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>))</span>
<span id="cb4-17">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>expect(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Failed to write image to buffer"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-18">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> img_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> resized_buffer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>into_inner()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-19">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Convert the byte vector back to a JS Buffer</span></span>
<span id="cb4-20">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> js_buffer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">JsBuffer::</span>external(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">mut</span> cx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> img_data)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-21">    <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">Ok</span>(js_buffer)</span>
<span id="cb4-22"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// finally export the function as a module</span></span>
<span id="cb4-24"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">register_module!</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">mut</span> cx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> cx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>export_function(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"resizeImage"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> resize_image) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div></div>
<ol start="4" type="1">
<li><p><code>npm install</code></p></li>
<li><p>Run <code>node</code> prompt and test with an image</p></li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb5-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">const</span> nativeModule <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">require</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">const</span> fs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">require</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fs'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> imageBuf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readFileSync</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cat.jpeg'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">const</span> resizedBuf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nativeModule<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">resizeImage</span>(imageBuf<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-5">fs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">writeFileSync</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'resized_cat.jpeg'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> resizedBuf)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div></div>
<p>neon also provides a lot of ‚Äúpromise-api‚Äù, ‚Äútask-api‚Äù to handle js promise and node worker pool jobs.</p>
</section>
<section id="segment-anything-in-node" class="level2">
<h2 class="anchored" data-anchor-id="segment-anything-in-node">Segment-Anything in Node</h2>
<p>Our examples won‚Äôt be complete with some deep learning heavy computation. We use <a href="https://github.com/facebookresearch/segment-anything">Segment-Anything</a> which is a state-of-the-art segmentation model by Meta. It produces high quality object masks from input prompts such as points or boxes, and it can be used to generate masks for all objects in an image. We will using <a href="https://github.com/huggingface/candle">Huggingface Candle Rust Deep Learning library</a> as the final example that delegates heavy lifting to Rust.</p>
<ol type="1">
<li><code>npm init neon sam-node</code> and <code>cd sam-node</code></li>
<li>Include the dependencies in <code>Cargo.tom</code>l as follows</li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode toml code-with-copy"><code class="sourceCode toml"><span id="cb6-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[dependencies]</span></span>
<span id="cb6-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">anyhow</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1.0.75"</span></span>
<span id="cb6-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">candle-core</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{ </span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">git</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://github.com/huggingface/candle.git"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">, </span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">version</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"0.3.1"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">, </span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">feautures</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> =</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb6-4">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"accelerate"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-5"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">] }</span></span>
<span id="cb6-6"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">candle-examples</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{ </span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">git</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://github.com/huggingface/candle.git"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">, </span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">version</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"0.3.1"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">, </span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">feautures</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> =</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb6-7">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"accelerate"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-8"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">] }</span></span>
<span id="cb6-9"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">candle-nn</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{ </span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">git</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://github.com/huggingface/candle.git"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">, </span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">version</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"0.3.1"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">, </span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">feautures</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> =</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb6-10">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"accelerate"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-11"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">] }</span></span>
<span id="cb6-12"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">candle-transformers</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{ </span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">git</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://github.com/huggingface/candle.git"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">, </span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">version</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"0.3.1"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">, </span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">feautures</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> =</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb6-13">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"accelerate"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-14"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">] }</span></span>
<span id="cb6-15"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">hf-hub</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"0.3.2"</span></span>
<span id="cb6-16"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">image</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"0.24.7"</span></span>
<span id="cb6-17"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">imageproc</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"0.23.0"</span></span></code></pre></div></div>
<p>and make sure you may need to set <a href="https://huggingface.co/">Huggingface</a> API key if you haven‚Äôt.</p>
<ol start="3" type="1">
<li>Now in <code>src/lib.rs</code></li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode rust code-with-copy"><code class="sourceCode rust"><span id="cb7-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fn</span> generate_sam(<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">mut</span> cx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> FunctionContext) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> JsResult<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>JsString<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb7-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> image_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">argument::</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>JsString<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?.</span>value(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">mut</span> cx)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-3">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> points <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">argument::</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>JsArray<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?;</span></span>
<span id="cb7-4">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> neg_points <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">argument::</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>JsArray<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?;</span></span>
<span id="cb7-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> points <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_points(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">mut</span> cx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> points)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-6">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> neg_points <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_points(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">mut</span> cx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> neg_points)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-7">    _generate_sam(image_path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> points<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> neg_points)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>expect(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"error generating sam"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-8">    <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">Ok</span>(cx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>string(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ok"</span>))</span>
<span id="cb7-9"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb7-10"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fn</span> get_points(cx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">mut</span> FunctionContext<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> Handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>JsArray<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Vec</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">String</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb7-11">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> points <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> handle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>to_vec(cx)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>expect(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"error converting to vec"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-12">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">mut</span> ret<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Vec</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">String</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Vec</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">::</span>new()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> point <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> points <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb7-14">        <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> point_string <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> point</span>
<span id="cb7-15">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">downcast::</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>JsString<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> FunctionContext<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>(cx)</span>
<span id="cb7-16">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>or_else(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span>_<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> cx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>throw_error(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Array element is not a string"</span>))</span>
<span id="cb7-17">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>unwrap()</span>
<span id="cb7-18">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>value(cx)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-19">        ret<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>push(point_string)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-20">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb7-21">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// return as a vec but a single contiguous string</span></span>
<span id="cb7-22">    ret <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">vec!</span>[ret<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>join(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">","</span>)]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-23">    ret</span>
<span id="cb7-24"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></div>
<p>where</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode rust code-with-copy"><code class="sourceCode rust"><span id="cb8-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fn</span> _generate_sam(</span>
<span id="cb8-2">    image_path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">String</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb8-3">    points<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Vec</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">String</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;,</span></span>
<span id="cb8-4">    neg_points<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Vec</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">String</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;,</span></span>
<span id="cb8-5">) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">anyhow::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Result</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-6">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> device <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">candle_examples::</span>device(<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">true</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?;</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// use CPU</span></span>
<span id="cb8-7">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> (image<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> initial_h<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> initial_w) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span></span>
<span id="cb8-8">        <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">candle_examples::</span>load_image(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>image_path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">Some</span>(<span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">sam::</span>IMAGE_SIZE))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?;</span></span>
<span id="cb8-9">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> image <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> image<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>to_device(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>device)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?;</span></span>
<span id="cb8-10">    <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">println!</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"loaded image {image:?}"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-11">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> api <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">hf_hub::api::sync::Api::</span>new()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?;</span></span>
<span id="cb8-12">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> api <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> api<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>model(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lmz/candle-sam"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>to_string())<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-13">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> filename <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mobile_sam-tiny-vitt.safetensors"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-14">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> api<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get(filename)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?;</span></span>
<span id="cb8-15">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> vb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">unsafe</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">VarBuilder::</span>from_mmaped_safetensors(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>[model]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">DType::</span>F32<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>device)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb8-16">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> sam <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">sam::Sam::</span>new_tiny(vb)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?;</span></span>
<span id="cb8-17">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Default options similar to the Python version.</span></span>
<span id="cb8-18">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> bboxes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sam<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>generate_masks(</span>
<span id="cb8-19">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>image<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb8-20">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* points_per_side */</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb8-21">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* crop_n_layer */</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb8-22">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* crop_overlap_ratio */</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1500</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.,</span></span>
<span id="cb8-23">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* crop_n_points_downscale_factor */</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb8-24">    )<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?;</span></span>
<span id="cb8-25">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (idx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> bbox) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> bboxes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>iter()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>enumerate() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-26">        <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">println!</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"{idx} {bbox:?}"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-27">        <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> mask <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>bbox<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>to_dtype(<span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">DType::</span>U8)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?;</span></span>
<span id="cb8-28">        <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> (h<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> w) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mask<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>dims2()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?;</span></span>
<span id="cb8-29">        <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> mask <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mask<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>broadcast_as((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> h<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> w))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?;</span></span>
<span id="cb8-30">        <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">candle_examples::</span>save_image_resize(</span>
<span id="cb8-31">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>mask<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb8-32">            <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">format!</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sam_mask{idx}.png"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb8-33">            initial_h<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb8-34">            initial_w<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb8-35">        )<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?;</span></span>
<span id="cb8-36">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb8-37">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> iter_points <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> points<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>iter()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>map(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span>p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> (p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">true</span>))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-38">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> iter_neg_points <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> neg_points<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>iter()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>map(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span>p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> (p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">false</span>))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-39">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> points <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> iter_points</span>
<span id="cb8-40">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>chain(iter_neg_points)</span>
<span id="cb8-41">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>map(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span>(point<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> b)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-42">            <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">use</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">std::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">str</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">::</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">FromStr</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-43">            <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> xy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> point<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>split(<span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">','</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">collect::</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Vec</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>_<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;</span>()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-44">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> xy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>len() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-45">                <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">anyhow::bail!</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"expected format for points is 0.4,0.2"</span>)</span>
<span id="cb8-46">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb8-47">            <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">Ok</span>((<span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">f64</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">::</span>from_str(xy[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">f64</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">::</span>from_str(xy[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?,</span> b))</span>
<span id="cb8-48">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span>)</span>
<span id="cb8-49">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">collect::</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">anyhow::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Result</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Vec</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>_<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;&gt;</span>()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?;</span></span>
<span id="cb8-50">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> start_time <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">std::time::Instant::</span>now()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-51">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> (mask<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> iou_predictions) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sam<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>forward(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>image<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>points<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">false</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?;</span></span>
<span id="cb8-52">    <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">println!</span>(</span>
<span id="cb8-53">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mask generated in {:.2}s"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb8-54">        start_time<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>elapsed()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>as_secs_f32()</span>
<span id="cb8-55">    )<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-56">    <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">println!</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mask:</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">{mask}"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-57">    <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">println!</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"iou_predictions: {iou_predictions}"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-58">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> mask <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (mask<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>ge(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?;</span></span>
<span id="cb8-59">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> (_one<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> h<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> w) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mask<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>dims3()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?;</span></span>
<span id="cb8-60">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> mask <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mask<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>expand((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> h<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> w))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?;</span></span>
<span id="cb8-61">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">mut</span> img <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">image::io::Reader::</span>open(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>image_path)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span></span>
<span id="cb8-62">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>decode()</span>
<span id="cb8-63">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>map_err(<span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">candle::</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Error</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">::</span>wrap)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?;</span></span>
<span id="cb8-64">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> mask_pixels <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mask<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>permute((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?.</span>flatten_all()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?.</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">to_vec1::</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">u8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?;</span></span>
<span id="cb8-65">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> mask_img<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">image::</span>ImageBuffer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">image::</span>Rgb<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">u8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Vec</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">u8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span></span>
<span id="cb8-66">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">match</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">image::ImageBuffer::</span>from_raw(w <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">as</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">u32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> h <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">as</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">u32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> mask_pixels) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-67">            <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">Some</span>(image) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=&gt;</span> image<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb8-68">            <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">None</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=&gt;</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">anyhow::bail!</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"error saving merged image"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb8-69">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb8-70">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> mask_img <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">image::DynamicImage::</span>from(mask_img)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>resize_to_fill(</span>
<span id="cb8-71">        img<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>width()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb8-72">        img<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>height()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb8-73">        <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">image::imageops::FilterType::</span>CatmullRom<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb8-74">    )<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-75">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">..</span>img<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>width() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-76">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> y <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">..</span>img<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>height() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-77">            <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> mask_p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">imageproc::drawing::Canvas::</span>get_pixel(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>mask_img<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> y)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-78">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> mask_p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-79">                <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">mut</span> img_p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">imageproc::drawing::Canvas::</span>get_pixel(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>img<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> y)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-80">                img_p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> img_p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-81">                img_p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-82">                img_p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-83">                <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">imageproc::drawing::Canvas::</span>draw_pixel(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">mut</span> img<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> img_p)</span>
<span id="cb8-84">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb8-85">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb8-86">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb8-87">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> b) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> points <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-88">        <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> img<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>width() <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">as</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">f64</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">as</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">i32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-89">        <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> img<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>height() <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">as</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">f64</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">as</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">i32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-90">        <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> color <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-91">            <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">image::</span>Rgba([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>])</span>
<span id="cb8-92">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-93">            <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">image::</span>Rgba([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>])</span>
<span id="cb8-94">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb8-95">        <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">imageproc::drawing::</span>draw_filled_circle_mut(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">mut</span> img<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> (x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> y)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> color)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-96">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb8-97">    img<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>save(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sam_merged.jpg"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?;</span></span>
<span id="cb8-98">    <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">Ok</span>(())</span>
<span id="cb8-99"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb8-100"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// finally register as node module</span></span>
<span id="cb8-101"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">register_module!</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">mut</span> cx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> cx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>export_function(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generateSam"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> generate_sam) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div></div>
<p>Next, after <code>sam-node/index.js</code> we add simple Node.js express server. (Note the dependencies <code>npm install axios express</code>)</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb9-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">const</span> express <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">require</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'express'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">const</span> nativeModule <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">require</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">const</span> app <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">express</span>()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">const</span> port <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3000</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">const</span> axios <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">require</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'axios'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">const</span> fs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">require</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fs'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">const</span> path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">require</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'path'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">downloadImage</span>(url<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> filePath) {</span>
<span id="cb9-9">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span> {</span>
<span id="cb9-10">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">const</span> response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">axios</span>({</span>
<span id="cb9-11">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">method</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'GET'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb9-12">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">url</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> url<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb9-13">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">responseType</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'stream'</span></span>
<span id="cb9-14">    })<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-15">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">const</span> writer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">createWriteStream</span>(filePath)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-16">    response<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pipe</span>(writer)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">new</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Promise</span>((resolve<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> reject) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">=&gt;</span> {</span>
<span id="cb9-18">      writer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">on</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'finish'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> resolve)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-19">      writer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">on</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'error'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> reject)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-20">    })<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-21">  } <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">catch</span> (error) {</span>
<span id="cb9-22">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">console</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">error</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Error downloading the image:'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> error)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-23">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">throw</span> error<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-24">  }</span>
<span id="cb9-25">}</span>
<span id="cb9-26">app<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">use</span>(express<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">json</span>())<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-27">app<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">listen</span>(port<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> () <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">=&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">console</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(<span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">`Listening on port </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">${</span>port<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-28">app<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">post</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/generate-sam"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">async</span> (req<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> res) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">=&gt;</span> {</span>
<span id="cb9-29">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span> {</span>
<span id="cb9-30">        <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">const</span> { imagUrl<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> points<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> negPoints } <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> req<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">body</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-31">        <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">const</span> name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> imagUrl<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">split</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'/'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pop</span>()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-32">        <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">const</span> filePath <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">__dirname</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> name)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-33">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">downloadImage</span>(imagUrl<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> filePath)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-34">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> nativeModule<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">generateSam</span>(filePath<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> points<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> negPoints)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-35">    } <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">catch</span> (error) {</span>
<span id="cb9-36">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">console</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(error)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-37">        res<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">status</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">send</span>(error)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-38">    }</span>
<span id="cb9-39">})<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div></div>
<p>Then <code>node index.js</code> and can test with <code>npm install node-fetch</code> script in <code>test.js</code></p>
<p>that downloads the sample JPG image</p>
<p><img src="https://ehsanmkermani.com/posts/2023-11-19-rust-and-node-js-harmonizing-performance-and-safety/images/bike.jpg" class="img-fluid"></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// testing using node-fetch to send a POST request to the server</span></span>
<span id="cb10-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">const</span> url <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'http://localhost:3000/generate-sam'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">const</span> imageUrl <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'https://githubraw.com/huggingface/candle/main/candle-examples/examples/yolo-v8/assets/bike.jpg'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">const</span> points <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'0.6'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'0.6'</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">const</span> negPoints <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'0.6'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'0.55'</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fetch</span>(url<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> {</span>
<span id="cb10-7">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">method</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'POST'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb10-8">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">headers</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> {</span>
<span id="cb10-9">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Content-Type'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'application/json'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb10-10">    }<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb10-11">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">body</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">JSON</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stringify</span>({</span>
<span id="cb10-12">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">imagUrl</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> imageUrl<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb10-13">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">points</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> points<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb10-14">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">negPoints</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> negPoints</span>
<span id="cb10-15">    })</span>
<span id="cb10-16">})</span>
<span id="cb10-17"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">then</span>(response <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">=&gt;</span> {</span>
<span id="cb10-18">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>response<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ok</span>) {</span>
<span id="cb10-19">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">throw</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">new</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Error</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Network response was not ok'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-20">    }</span>
<span id="cb10-21">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> response<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">blob</span>()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-22">})</span>
<span id="cb10-23"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">then</span>(blob <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">=&gt;</span> {</span>
<span id="cb10-24">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">console</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Image received:'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> blob)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-25">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">const</span> imageUrl <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> URL<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">createObjectURL</span>(blob)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-26">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">const</span> img <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">document</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">createElement</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'img'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-27">    img<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">src</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> imageUrl<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-28">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">document</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">body</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">appendChild</span>(img)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-29">})</span>
<span id="cb10-30"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">catch</span>(error <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">=&gt;</span> {</span>
<span id="cb10-31">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">console</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">error</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Fetch error:'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> error)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-32">})<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div></div>
<p><a href="https://ehsanmkermani.com/wp-content/uploads/2023/11/sam_merged-1.jpg"><img src="https://ehsanmkermani.com/posts/2023-11-19-rust-and-node-js-harmonizing-performance-and-safety/images/sam_merged-1.jpg" class="img-fluid"></a></p>
<p>where segmentation was applied to the right-most cyclist‚Äôs right foot.</p>
<p>Hope this post has ignited some spark to explore neon and the Rust-Node.js interactions.</p>


</section>

 ]]></description>
  <category>High Performance</category>
  <category>JavaScript</category>
  <category>Machine Learning</category>
  <category>Rust</category>
  <guid>https://ehsanmkermani.com/posts/2023-11-19-rust-and-node-js-harmonizing-performance-and-safety/</guid>
  <pubDate>Sun, 19 Nov 2023 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Notes on the Current State of LLM Frameworks</title>
  <dc:creator>Ehsan M. Kermani</dc:creator>
  <link>https://ehsanmkermani.com/posts/2023-08-13-notes-on-the-current-state-of-llm-frameworks/</link>
  <description><![CDATA[ 





<p>This post tries to shed some light on the rapidly changing LLM frameworks in particular, <a href="https://github.com/langchain-ai/langchain">LangChain</a> (LC) and <a href="https://github.com/jerryjliu/llama_index">Llama-index</a> (LI).</p>
<section id="library-vs.-framework" class="level2">
<h2 class="anchored" data-anchor-id="library-vs.-framework">Library vs.&nbsp;Framework</h2>
<p>It‚Äôs tricky to draw a clear boundary between a package/library and a framework, but for the sake of discussion, let‚Äôs look at some well-known examples<em><strong>Packages:</strong>Numpy falls into this category. It provides functionality that can be adapted to various Linear Algebra problems without dictating a particular structure or methodology.</em><strong>Mature Frameworks</strong>: Scikit-learn, PyTorch and HuggingFace transformers. They provide high-level abstractions but take customization and non-opinionated design seriously. As a result, they have become the de facto ways of doing ML/AI.<strong>Immature</strong>Frameworks:**<a href="https://github.com/langchain-ai/langchain">LangChain</a> (LC) and <a href="https://github.com/jerryjliu/llama_index">Llama-index</a> (LI) are examples in this category. Unlike packages, they offer higher-level abstractions and impose a specific way of building software. (Within this category, I‚Äôve found that LI provides better abstractions than LC).</p>
<p>I‚Äôve been using LC and LI for seven months now, and their evolution exemplifies a broader trend in the ML/AI world. While they‚Äôve been great for quickly creating a Proof-of-Concept, their higher-level abstractions miss many details and nuances of components that are hard to include in a clean abstraction.</p>
<p>Take VectorDB/VectorStore; within a few months, their numbers have grown quickly. The quality of each is up to the individual to decide and try (I have my own suggestions, perhaps for later). For a long time, none of these frameworks offered a simple, clear CRUD API. Also, each VectorDB has its nuances of handling embeddings, from storage to search. Some support async, and some don‚Äôt. Some support gRPC, and some don‚Äôt. Some support hybrid-search, and some don‚Äôt. To use them at scale for production, we need to know about these nuances to squeeze every bit of performance. So what LC and LI did was provide a base VectorStore class and implement methods like <code>add_documents</code> (and their async <code>aadd_documents</code>) and wrap them without exposing the individual nuances of VectorDBs.</p>
<p>Mostly in LC, almost every abstracted away component is opinionated and hard to customize. I can add <code>async</code>, <code>streaming</code>, <code>callback</code>-hell, <code>agent</code> and <code>memory</code> to the list. Not everything needs to be a subclass of pydantic <code>BaseModel</code>! I think ‚Äútrue chaining‚Äù is not there yet in LC (should admit overloading <a href="https://github.com/langchain-ai/langchain/blob/9b24f0b067d9f4a5f3e1f53fe3f7342f79a1f010/libs/langchain/langchain/schema/runnable/base.py#L47"><code>__or__</code></a> is an interesting new way, similar to Unix pipe), and the many ways of calling a chain/agent with <code>run</code>, <code>__call__</code>, <code>apply</code> (now with added async) are unhealthy. <a href="https://minimaxir.com/2023/07/langchain-problem/">These criticisms of LC</a> are mostly to the point but I also think given the rapid change of landscape both LC and LI provide values esp.&nbsp;as a generic off-the-shelf solutions.</p>
</section>
<section id="conclusion-updated" class="level2">
<h2 class="anchored" data-anchor-id="conclusion-updated">Conclusion (Updated)</h2>
<p>I don‚Äôt think these frameworks, esp.&nbsp;LC offers anything good long term. LI has a better chance of remaining relevant but after spending some time, I came into conclusion that many of the framework decisions were taken that are hard to change and won‚Äôt work with down the road esp.&nbsp;if you application needs much higher control over how things are done such as preserving the structure of the documents during chunking with non-flat node/graph system, granular control over embedding of different data types, handling VectorDBs components, let alone the ‚Äúdata‚Äù agent etc.</p>


</section>

 ]]></description>
  <category>LLM</category>
  <category>Machine Learning</category>
  <category>Thoughts</category>
  <guid>https://ehsanmkermani.com/posts/2023-08-13-notes-on-the-current-state-of-llm-frameworks/</guid>
  <pubDate>Sun, 13 Aug 2023 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Announcement üì¢ Releasing dlpackrs</title>
  <dc:creator>Ehsan M. Kermani</dc:creator>
  <link>https://ehsanmkermani.com/posts/2022-09-20-announcing-releasing-dlpackrs/</link>
  <description><![CDATA[ 





<p><a href="https://dmlc.github.io/dlpack/latest/">DLPack</a> is the standard in-memory data format that facilitates<em>zero-cost</em>tensor transfer across major Deep Learning frameworks (PyTorch, TensorFlow and TVM) and the supported Python Array processing frameworks such as Numpy, CuPy. The <a href="https://github.com/ehsanmok/dlpackrs">dlpackrs</a> provides a safe idiomatic Rust binding where Rust ndarray and tensor frameworks can use it to gain the same kind of benefits (if not done already) across the supported hardware types.</p>
<p>In Python, such conversion goes through <a href="https://github.com/python/cpython/blob/main/Include/pycapsule.h">PyCapsule</a> (minimal example for TVM - numpy conversion is <a href="https://github.com/jwfromm/numpy_dlpack">here</a>) but Rust needs no such restrictions or workaround. In fact, the <a href="https://github.com/PyO3/rust-numpy">PyO3/numpy</a> conversion to <a href="https://github.com/rust-ndarray/ndarray">Rust ndarray</a> is<em>already zero-cost</em>through pointers (taken from <a href="https://github.com/PyO3/rust-numpy/blob/v0.17.2/src/convert.rs#L148-L184">here</a>) which is</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode rust code-with-copy"><code class="sourceCode rust"><span id="cb1-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">impl</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>S<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> D<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> ToPyArray <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> ArrayBase<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>S<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> D<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb1-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">where</span></span>
<span id="cb1-3">    S<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> Data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Elem <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;,</span></span>
<span id="cb1-4">    D<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> Dimension<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-5">    A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> Element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-6"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-7">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">type</span> Item <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-8">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">type</span> Dim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> D<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-9"></span>
<span id="cb1-10">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fn</span> to_pyarray<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">'py</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">self</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> py<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> Python<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">'py</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">'py</span> PyArray<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Self</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">::</span>Item<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Self</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">::</span>Dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-11">        <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> len <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">self</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>len()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-12">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">match</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">self</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>order() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-13">            <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">Some</span>(flag) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">A::</span>IS_COPY <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-14">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// if the array is contiguous, copy it by `copy_nonoverlapping`.</span></span>
<span id="cb1-15">                <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> strides <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">self</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>npy_strides()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-16">                <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">unsafe</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-17">                    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> array <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">PyArray::</span>new_uninit(py<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">self</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>raw_dim()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> strides<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>as_ptr()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> flag)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-18">                    <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">ptr::</span>copy_nonoverlapping(<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">self</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>as_ptr()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> array<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>data()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> len)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// &lt;-- pointer copy</span></span>
<span id="cb1-19">                    array</span>
<span id="cb1-20">                <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-21">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-22">            _ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-23">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// if the array is not contiguous, copy all elements by `ArrayBase::iter`.</span></span>
<span id="cb1-24">                <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> dim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">self</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>raw_dim()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-25">                <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">unsafe</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-26">                    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> array <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">PyArray::</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> _<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">::</span>new(py<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">false</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-27">                    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">mut</span> data_ptr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> array<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>data()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-28">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> item <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">self</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>iter() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// &lt;-- pointer copy starts</span></span>
<span id="cb1-29">                        data_ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>write(item<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>clone())<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-30">                        data_ptr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> data_ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>add(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-31">                    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-32">                    array</span>
<span id="cb1-33">                <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-34">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-35">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-36">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-37"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></div>



 ]]></description>
  <category>Rust</category>
  <guid>https://ehsanmkermani.com/posts/2022-09-20-announcing-releasing-dlpackrs/</guid>
  <pubDate>Tue, 20 Sep 2022 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Announcement üì¢ Releasing smartalloc</title>
  <dc:creator>Ehsan M. Kermani</dc:creator>
  <link>https://ehsanmkermani.com/posts/2022-09-07-announcement-releasing-smartalloc/</link>
  <description><![CDATA[ 





<p>If you happen to write unsafe code in Rust where normal static checks are not available and want better UX for detecting memory issues along side using various sanitizers, checkout my new crate <a href="https://github.com/ehsanmok/smartalloc-rs">smartalloc</a> which provides idiomatic Rust binding for the original C version <a href="https://www.fourmilab.ch/smartall/">here</a>.</p>
<p>Beside the reason in README, note that MIRI can‚Äôt be used now since it doesn‚Äôt support FFI function call. With Rust 1.65.0-nightly running</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">cargo</span> +nightly miri run <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--example</span> undetected</span></code></pre></div></div>
<p>results the error</p>
<pre class="text"><code>error: unsupported operation: can't call foreign function: sm_malloc
 --&gt; examples/undetected.rs:6:16
  |
5 | #[global_allocator]
  | ------------------- in this procedural macro expansion
6 | static GLOBAL: SmartAlloc = SmartAlloc;
  |                ^^^^^^^^^^ can't call foreign function: sm_malloc
  |
  = help: this is likely not a bug in the program; it indicates that the program performed an operation that the interpreter does not support
  = note: BACKTRACE:
  = note: inside `_::__rg_alloc` at examples/undetected.rs:6:16
  = note: this error originates in the attribute macro `global_allocator` (in Nightly builds, run with -Z macro-backtrace for more info)

note: some details are omitted, run with `MIRIFLAGS=-Zmiri-backtrace=full` for a verbose backtrace</code></pre>



 ]]></description>
  <category>Rust</category>
  <guid>https://ehsanmkermani.com/posts/2022-09-07-announcement-releasing-smartalloc/</guid>
  <pubDate>Wed, 07 Sep 2022 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Announcement üì¢ Create your own programming language with Rust</title>
  <dc:creator>Ehsan M. Kermani</dc:creator>
  <link>https://ehsanmkermani.com/posts/2020-06-08-create-your-own-programming-language-with-rust/</link>
  <description><![CDATA[ 





<p>After almost a year from my last blog post, in this short post I‚Äôm very happy to announce that I‚Äôm writing a free online book where early chapters are <a href="http://createlang.rs">available</a> now. I‚Äôve explained my motivations and goals in the introduction. The accompanying codes are also available on my <a href="https://github.com/ehsanmok/create-your-own-lang-with-rust">GitHub</a>.</p>
<p>Feedbacks are welcome and happy learning. If you‚Äôve found the book useful, please consider donating to any of the organizations listed at either GitHub readme or at the end of the introduction chapter.</p>



 ]]></description>
  <category>Rust</category>
  <guid>https://ehsanmkermani.com/posts/2020-06-08-create-your-own-programming-language-with-rust/</guid>
  <pubDate>Mon, 08 Jun 2020 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Rust std study series: Pin</title>
  <dc:creator>Ehsan M. Kermani</dc:creator>
  <link>https://ehsanmkermani.com/posts/2019-08-16-rust-std-study-series-pin/</link>
  <description><![CDATA[ 





<p><img src="https://ehsanmkermani.com/posts/2019-08-16-rust-std-study-series-pin/images/rustacean-flat-happy-2.png" class="img-fluid"></p>
<p>This time we dive into <code>std::pin</code> which has a dense documentation.</p>
<blockquote class="blockquote">
<p>Types that<strong>pin data</strong>to its location in<strong>memory</strong>.</p>
<p>It is sometimes useful to have objects that are<strong>guaranteed to not move</strong>, in the sense that their<strong>placement in memory does not change</strong>, and can thus be relied upon. A prime example of such a scenario would be<strong>building self-referential structs</strong>, since moving an object with pointers to itself will invalidate them, which could cause undefined behavior.</p>
<p>Rust std doc</p>
</blockquote>
<section id="pin-and-unpin" class="level2">
<h2 class="anchored" data-anchor-id="pin-and-unpin">Pin and Unpin</h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode rust code-with-copy"><code class="sourceCode rust"><span id="cb1-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">#[</span>fundamental<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">]</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// compiler thing</span></span>
<span id="cb1-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">#[</span>repr<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">(</span>transparent<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">)]</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// --&gt; ensures same memory repr as P</span></span>
<span id="cb1-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">pub</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">struct</span> Pin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>P<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-4">    pointer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> P<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-5"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">pub</span> auto <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">trait</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Unpin</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// marker trait</span></span></code></pre></div></div>
<p>To construct a <code>Pin</code> safely via <code>Pin::new(pointer: P)</code>, we need to make sure that <code>P: Deref</code> (pointer-like) and <code>P::Target: Unpin</code>.</p>
<p>Note that <code>Unpin</code> ensures</p>
<blockquote class="blockquote">
<p>Types which can be<strong>safely moved after being pinned</strong>.</p>
<p>Since Rust itself has no notion of immovable types, and considers moves (e.g.&nbsp;through assignment or <a href="https://doc.rust-lang.org/std/mem/fn.replace.html"><code>mem::replace</code></a>) to always be safe, this trait cannot prevent types from moving by itself.<br>
Instead it is used to<strong>prevent moves through the type system</strong>, by controlling the behavior of pointers <code>P</code> wrapped in the <a href="https://doc.rust-lang.org/std/pin/struct.Pin.html"><code>Pin&lt;P&gt;</code></a> wrapper, which ‚Äúpin‚Äù the type in place by not allowing it to be moved out of them.</p>
<p>Rust std doc</p>
</blockquote>
<p>Basically, the vast majority of types are ‚Äúmovable‚Äù i.e.&nbsp;<code>Unpin</code>, so for most cases,<strong><code>Pin&lt;Pointer&lt;T&gt;&gt;</code></strong>is exactly like<strong><code>Pointer&lt;T&gt;</code></strong>when<strong><code>T: Unpin</code></strong>. However, if the referent (referenced type <code>T</code>) is ‚Äúimmovable‚Äù i.e.&nbsp;<code>T: !Unpin</code>, then the pinned wrapper won‚Äôt let the underlying value to move.*Intuitively it‚Äôs like having**<code>&amp;mut</code>* <em>but with</em> <em><code>&amp;</code></em> <em>access safety and immovability invariant</em>. It is in fact, <code>Unpin</code> that controls how <code>Pin</code> to work.</p>
<p>To iterate; <code>Pin&lt;P&gt;</code> ensures that the<strong>underlying data behind a pointer type</strong><code>P</code><strong>has a stable location in memory</strong>and<strong>its memory cannot be deallocated until it is dropped</strong>. So <code>Pin</code> pins the pointee (the data behind the pointer)<em>not the pointer itself</em>. Moreover,<a href="https://doc.rust-lang.org/std/pin/struct.Pin.html"><code>Pin&lt;P&gt;</code></a><strong>does not let clients actually obtain a</strong><code>Box&lt;T&gt;</code><strong>or</strong><code>&amp;mut T</code><strong>to the underlying pinned data</strong>, which implies that you<em>cannot</em>use operations such as <a href="https://doc.rust-lang.org/std/mem/fn.swap.html"><code>mem::swap</code></a>.</p>
<p>Furthermore,</p>
<blockquote class="blockquote">
<p>For correctness, <a href="https://doc.rust-lang.org/std/pin/struct.Pin.html"><code>Pin&lt;P&gt;</code></a> relies on the <a href="https://doc.rust-lang.org/std/ops/trait.Deref.html"><code>Deref</code></a> and <a href="https://doc.rust-lang.org/std/ops/trait.DerefMut.html"><code>DerefMut</code></a> implementations to<strong>not move out of their</strong><code>self</code><strong>parameter</strong>, and to only ever return a pointer to pinned data when they are called on a pinned pointer.</p>
<p>Rust std doc</p>
</blockquote>
<p>To implement <code>!Unpin</code> for a type directly, (up to this write up) we need nightly with <code>![feature(optin_builtin_traits)]</code>. The stable way is through the marker type <code>PhantomPinned</code> which already has <code>impl !Unpin for PhantomPinned {}</code></p>
</section>
<section id="closer-look" class="level2">
<h2 class="anchored" data-anchor-id="closer-look">Closer look</h2>
<p>We cannot create <code>Pin</code> for a <code>Pointer&lt;T&gt;</code> where <code>T: !Unpin</code> safely</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode rust code-with-copy"><code class="sourceCode rust"><span id="cb2-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">pub</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">struct</span> Pin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>P<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-2">    pointer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> P<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-3"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">impl</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>P<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Deref</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> Pin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>P<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> </span>
<span id="cb2-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">where</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">P::</span>Target<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Unpin</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// --&gt; underlying data is movable</span></span>
<span id="cb2-6"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-7">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">pub</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fn</span> new(pointer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> P) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> Pin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>P<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-8">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Safety: the value pointed to is `Unpin`, and so has no requirements</span></span>
<span id="cb2-9">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// around pinning.</span></span>
<span id="cb2-10">        <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">unsafe</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">Pin::</span>new_unchecked(pointer) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-11">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-12"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-13"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">impl</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>P<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Deref</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> Pin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>P<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-14">   <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">pub</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">unsafe</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fn</span> new_unchecked(pointer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> P) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> Pin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>P<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-15">        Pin <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> pointer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-16">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-17"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></div>
<section id="so-how-to-pin-a-t-unpin-safely" class="level3">
<h3 class="anchored" data-anchor-id="so-how-to-pin-a-t-unpin-safely">So how to pin a <code>T: !Unpin</code> safely?</h3>
<p>We can use <code>Box::pin</code> (similarity with <code>Rc::pin</code> or <code>Arc::pin</code>) where</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode rust code-with-copy"><code class="sourceCode rust"><span id="cb3-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">impl</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Box</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-2">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">#[</span>inline<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">(</span>always<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">)]</span></span>
<span id="cb3-3">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">pub</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fn</span> pin(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> T) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> Pin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Box</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-4">        (<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">box</span> x)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>into()</span>
<span id="cb3-5">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-6"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">impl</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Sized</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">From</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Box</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> Pin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Box</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/// This conversion does not allocate on the heap and happens in place.</span></span>
<span id="cb3-9">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fn</span> from(boxed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Box</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Self</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-10">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Box</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">::</span>into_pin(boxed)</span>
<span id="cb3-11">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-12"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-13"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">impl</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Sized</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Box</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-14">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">pub</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fn</span> into_pin(boxed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Box</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> Pin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Box</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-15">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// It's not possible to move or replace the insides of a `Pin&lt;Box&lt;T&gt;&gt;`</span></span>
<span id="cb3-16">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// when `T: !Unpin`,  so it's safe to pin it directly without any</span></span>
<span id="cb3-17">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// additional requirements.</span></span>
<span id="cb3-18">        <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">unsafe</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">Pin::</span>new_unchecked(boxed) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-19">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-20"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></div>
<p>Some notable methods of <code>Pin</code> are<em><code>as_ref: &amp;Pin&lt;Pointer&lt;T&gt;&gt; ---&gt; Pin&lt;&amp;T&gt;</code></em><code>as_mut: &amp;mut Pin&lt;Pointer&lt;T&gt;&gt; ---&gt; Pin&lt;&amp;mut T&gt;</code><em><code>get_ref: Pin&lt;Pointer&lt;T&gt;&gt; ---&gt; &amp;T</code></em><code>get_mut: Pin&lt;Pointer&lt;T&gt;&gt; ---&gt; &amp;mut T</code> (given <code>T: Unpin</code>)</p>
<p>There is also a <code>set</code> method which overwrites the pinned data and it might seem is invalidating the pinned construct but the subtle point is that before assigning the new value, the destructor of the old data is run so it‚Äôs ok.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode rust code-with-copy"><code class="sourceCode rust"><span id="cb4-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">impl</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>P<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">DerefMut</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> Pin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>P<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">pub</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fn</span> set(<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">self</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">mut</span> Pin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>P<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;,</span> value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">P::</span>Target)</span>
<span id="cb4-3">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">where</span></span>
<span id="cb4-4">        <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">P::</span>Target<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Sized</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb4-5">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-6">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">self</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>pointer) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// --&gt; before assignment the pointee *self.pointer is dropped</span></span>
<span id="cb4-7">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-8"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></div>
<p>So the whole point is, we can change the pointee <code>Pointer::Target</code> of a mutable pinned pointer but cannot get a <code>&amp;mut T</code> out of a <code>Pin&lt;Pointer&lt;T&gt;&gt;</code> (<code>Pointer::Target = T</code> in here) when <code>T: !Unpin</code>.</p>
<p><code>Pin</code> has been introduced to resolve the issues around <code>Future</code> and <code>async/.await</code> (and more general, <code>Generator</code>). To get a better idea, I recommend looking into <code>async book pin section</code> to see, for example, how an <code>async</code> block is turned into structs (like closures) with potentially<em>self-referential mutable fields</em>and how <code>Pin</code> helps there.</p>
<p>Hope we have entangled some of the complications for understanding what <code>Pin</code> is and what it does. For more details, checkout the complete documentation as well as more discussion on <a href="https://doc.rust-lang.org/std/pin/index.html#projections-and-structural-pinning">structural pinning and the safety issues around it</a>.</p>


</section>
</section>

 ]]></description>
  <category>Rust</category>
  <guid>https://ehsanmkermani.com/posts/2019-08-16-rust-std-study-series-pin/</guid>
  <pubDate>Fri, 16 Aug 2019 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Rust std study series: alloc</title>
  <dc:creator>Ehsan M. Kermani</dc:creator>
  <link>https://ehsanmkermani.com/posts/2019-07-03-rust-std-study-series-alloc/</link>
  <description><![CDATA[ 





<p><img src="https://ehsanmkermani.com/posts/2019-07-03-rust-std-study-series-alloc/images/rustacean-flat-happy-2.png" class="img-fluid"></p>
<p>Let‚Äôs get deep into <code>std::alloc</code>!</p>
<section id="memory-allocator-101" class="level2">
<h2 class="anchored" data-anchor-id="memory-allocator-101">Memory allocator 101</h2>
<p>The very basic need for any program to compile and execute is having access to either physical memory or <a href="https://en.wikipedia.org/wiki/Virtual_memory">virtual memory</a>. An allocator is responsible for providing such an access. You can think of an allocator as a<em>service</em>, taking some sort of requests and either giving back a (pointer) to<em>block of memory</em>or some errors. In Rust, a request is a <code>Layout</code> i.e.&nbsp;some meta-data about how the memory we want is supposed to take up the space.</p>
<p>A memory layout is made up of<em><code>size</code> (in bytes)</em><code>alignment</code> (in bytes and<strong>must be power of two</strong>): the CPU always<strong>reads memory</strong>at its<strong>word size</strong>(<strong>4 bytes</strong>on<em>32-bit</em>system or<strong>8 bytes</strong>on<em>64-bit</em>system). See <a href="https://stackoverflow.com/questions/381244/purpose-of-memory-alignment/381368#381368">what‚Äôs the purpose of memory alignment</a>.</p>
<section id="stdalloclayout" class="level3">
<h3 class="anchored" data-anchor-id="stdalloclayout">std::alloc::Layout</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode rust code-with-copy"><code class="sourceCode rust"><span id="cb1-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">#[</span>lang <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"alloc_layout"</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb1-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">pub</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">struct</span> Layout <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// size of the requested block of memory, measured in bytes.</span></span>
<span id="cb1-4">    size_<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">usize</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-5"></span>
<span id="cb1-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// alignment of the requested block of memory, measured in bytes.</span></span>
<span id="cb1-7">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// we ensure that this is always a power-of-two ...</span></span>
<span id="cb1-8">    align_<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> NonZeroUsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-9"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></div>
<p>For example, to check the size and alignment of<strong>a</strong>type<strong>vs a</strong>value**, we can do (<a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=2f9b392eea87f302e1a16c3dbfaa20aa">playpen</a>)</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode rust code-with-copy"><code class="sourceCode rust"><span id="cb2-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">println!</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type alignment of i32 {}"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">mem::align_of::</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">i32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>())<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// --&gt; 4 bytes</span></span>
<span id="cb2-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">println!</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"val alignment 1i32 {}"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">mem::</span>align_of_val(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1i32</span>))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// --&gt; 4 bytes</span></span>
<span id="cb2-3"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">println!</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type size i32 {}"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">mem::size_of::</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">i32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>())<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// --&gt; 4 bytes</span></span>
<span id="cb2-4"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">println!</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"val size 1i32 {}"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">mem::</span>size_of_val(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1i32</span>))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// --&gt; 4 bytes</span></span>
<span id="cb2-5"></span>
<span id="cb2-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// empty struct</span></span>
<span id="cb2-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">struct</span> A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> val <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-9"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">println!</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type alignment {}"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">mem::align_of::</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>())<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// --&gt; 1 byte</span></span>
<span id="cb2-10"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">println!</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"val alignment {}"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">mem::</span>align_of_val(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>val))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// --&gt; 1 byte</span></span>
<span id="cb2-11"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">println!</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type size {}"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">mem::size_of::</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>())<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// --&gt; 0 bytes</span></span>
<span id="cb2-12"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">println!</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"val size {}"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">mem::</span>size_of_val(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>val))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// --&gt; 0 bytes</span></span>
<span id="cb2-13"></span>
<span id="cb2-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// also with</span></span>
<span id="cb2-15"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">println!</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Layout of A: {:?}"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">Layout::new::</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>())<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// --&gt; Layout { size_: 0, align_: 1 }</span></span></code></pre></div></div>
</section>
<section id="are-there-any-relations-between-size-and-align" class="level3">
<h3 class="anchored" data-anchor-id="are-there-any-relations-between-size-and-align">Are there any relations between size and align?</h3>
<p>Looking into <code>std::alloc::from_size_align</code> indicates three requirements (invariants) that must be held when constructing a layout given size and alignment:<em><code>align</code> must be<strong>non-zero</strong></em><code>align</code> must be a<strong>power of two</strong><em><code>size</code> when</em>rounded up*to the<strong>nearest multiple</strong>of <code>align</code>,<strong>must not overflow</strong>(i.e., the rounded value must be less than <code>usize::MAX</code>) i.e.&nbsp;<img src="https://latex.codecogs.com/png.latex?%5Ctext%7Bsize%7D%20+%20%5Ctext%7Balign%7D%20-%201%20%5Cleq%20%5Ctext%7Busize::MAX%7D">.</p>
<p>We can compute the the<em>round up size</em>with <img src="https://latex.codecogs.com/png.latex?(size%20+%20align%20-%201)%20%5C;%5C;%20%5C&amp;%20%5C;%5C;%20!(align%20-%201)."> For example, if we want to create a layout with size <img src="https://latex.codecogs.com/png.latex?6"> bytes and alignment <img src="https://latex.codecogs.com/png.latex?8"> bytes, then the round up size will be <img src="https://latex.codecogs.com/png.latex?8">, but for size of <img src="https://latex.codecogs.com/png.latex?10"> bytes and the same <img src="https://latex.codecogs.com/png.latex?8"> alignment, the round up size will be <img src="https://latex.codecogs.com/png.latex?16"> bytes. The difference between the rounded up size and the given size is the amount of padding needed for that alignment which are <img src="https://latex.codecogs.com/png.latex?2"> and <img src="https://latex.codecogs.com/png.latex?6,"> respectively. (<a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=2778a3d76dcac3cbf2594d02258bad50">playpen</a>)</p>
<p>We saw in the earlier example that we can create a layout for a type <code>T</code> using <code>Layout::new::&lt;T&gt;()</code>. Moreover, given a reference <code>&amp;T</code>, we can create the desirable layout with <code>std::alloc::for_value</code>. Basically, they are</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode rust code-with-copy"><code class="sourceCode rust"><span id="cb3-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">impl</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> Layout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">pub</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fn</span> new<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Self</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-3">        <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> (size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> align) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">mem::size_of::</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">mem::align_of::</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>())<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-4">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Note that the align is guaranteed by rustc to be a power of two and</span></span>
<span id="cb3-5">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// the size+align combo is guaranteed to fit in our address space. As a</span></span>
<span id="cb3-6">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// result use the unchecked constructor here to avoid inserting code</span></span>
<span id="cb3-7">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// that panics if it isn't optimized well enough.</span></span>
<span id="cb3-8">        <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">debug_assert!</span>(<span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">Layout::</span>from_size_align(size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> align)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>is_ok())<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-9">        <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">unsafe</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-10">            <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">Layout::</span>from_size_align_unchecked(size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> align)</span>
<span id="cb3-11">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-12">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-13"></span>
<span id="cb3-14">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">pub</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fn</span> for_value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Sized</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>(t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>T) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Self</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-15">        <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> (size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> align) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">mem::</span>size_of_val(t)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">mem::</span>align_of_val(t))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-16">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// See rationale in `new` for why this us using an unsafe variant below</span></span>
<span id="cb3-17">        <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">debug_assert!</span>(<span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">Layout::</span>from_size_align(size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> align)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>is_ok())<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-18">        <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">unsafe</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-19">            <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">Layout::</span>from_size_align_unchecked(size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> align)</span>
<span id="cb3-20">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-21">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-22"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></div>
<p>So far we have covered the layout (request part of the allocator service). Let‚Äôs look closer into the main constituent of the service.</p>
</section>
</section>
<section id="stdallocglobalalloc" class="level2">
<h2 class="anchored" data-anchor-id="stdallocglobalalloc">std::alloc::GlobalAlloc</h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode rust code-with-copy"><code class="sourceCode rust"><span id="cb4-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">pub</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">unsafe</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">trait</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">GlobalAlloc</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// required methods</span></span>
<span id="cb4-3">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">unsafe</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fn</span> alloc(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">self</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> layout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> Layout) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">mut</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">u8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-4">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">unsafe</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fn</span> dealloc(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">self</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">mut</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">u8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> layout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> Layout)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// provided methods</span></span>
<span id="cb4-6">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">unsafe</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fn</span> alloc_zeroed(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">self</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> layout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> Layout) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">mut</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">u8</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-7">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">unsafe</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fn</span> realloc(</span>
<span id="cb4-8">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">self</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> </span>
<span id="cb4-9">        ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">mut</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">u8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> </span>
<span id="cb4-10">        layout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> Layout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> </span>
<span id="cb4-11">        new_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">usize</span></span>
<span id="cb4-12">    ) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">mut</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">u8</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-13"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></div>
<p>Implementing this trait for a type, must be followed by using the attribute <code>#[global_allocator]</code> so that we can register it as the<strong>global std allocator</strong>. For a given layout, the <code>alloc</code> method returns*a pointer<strong>to a* <em>block memory</em>or a null pointer in case of<em>Out-Of-Memory (OOM) or invalid layout</em>.</strong>The allocated block of memory may or may not be initialized**.</p>
<p>Up to writing these notes, the experimental variant of <code>GlobalAlloc</code> trait is <code>std::alloc::Alloc</code> with more functionalities. Note that the default allocator provided by the OS is <code>std::alloc::System</code> which in case of <code>alloc</code> provides either a<strong>non-null</strong>pointer (to some block of memory) or some <code>AllocErr</code>. This is configured as</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode rust code-with-copy"><code class="sourceCode rust"><span id="cb5-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">pub</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">struct</span> System<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-2"></span>
<span id="cb5-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// The Alloc impl just forwards to the GlobalAlloc impl, which is in `std::sys::*::alloc`.</span></span>
<span id="cb5-4"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">#[</span>unstable<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">(</span>feature <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"allocator_api"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> issue <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"32838"</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">)]</span></span>
<span id="cb5-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">unsafe</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">impl</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Alloc</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> System <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb5-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">#[</span>inline<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb5-7">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">unsafe</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fn</span> alloc(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">mut</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">self</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> layout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> Layout) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Result</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>NonNull<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">u8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;,</span> AllocErr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb5-8">        <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">NonNull::</span>new(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">GlobalAlloc</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">::</span>alloc(<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">self</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> layout))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>ok_or(AllocErr)</span>
<span id="cb5-9">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb5-10"></span>
<span id="cb5-11">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">#[</span>inline<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb5-12">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">unsafe</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fn</span> alloc_zeroed(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">mut</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">self</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> layout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> Layout) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Result</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>NonNull<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">u8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;,</span> AllocErr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb5-13">        <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">NonNull::</span>new(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">GlobalAlloc</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">::</span>alloc_zeroed(<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">self</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> layout))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>ok_or(AllocErr)</span>
<span id="cb5-14">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb5-15"></span>
<span id="cb5-16">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">#[</span>inline<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb5-17">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">unsafe</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fn</span> dealloc(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">mut</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">self</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> NonNull<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">u8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;,</span> layout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> Layout) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb5-18">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">GlobalAlloc</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">::</span>dealloc(<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">self</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>as_ptr()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> layout)</span>
<span id="cb5-19">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb5-20"></span>
<span id="cb5-21">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">#[</span>inline<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb5-22">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">unsafe</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fn</span> realloc(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">mut</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">self</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-23">                      ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> NonNull<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">u8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;,</span></span>
<span id="cb5-24">                      layout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> Layout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-25">                      new_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">usize</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Result</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>NonNull<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">u8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;,</span> AllocErr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb5-26">        <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">NonNull::</span>new(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">GlobalAlloc</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">::</span>realloc(<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">self</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>as_ptr()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> layout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> new_size))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>ok_or(AllocErr)</span>
<span id="cb5-27">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb5-28"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></div>
<p>And for example on <a href="https://github.com/rust-lang/rust/blob/master/src/libstd/sys/unix/alloc.rs">unix</a>, the <code>System</code> allocator is defined using <code>libc::malloc</code> satisfying the condition below</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode rust code-with-copy"><code class="sourceCode rust"><span id="cb6-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">unsafe</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">impl</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">GlobalAlloc</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> System <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-2">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">#[</span>inline<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb6-3">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">unsafe</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fn</span> alloc(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">self</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> layout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> Layout) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">mut</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">u8</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-4">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> layout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>align() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> MIN_ALIGN <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> layout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>align() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> layout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-5">            <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">libc::</span>malloc(layout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>size()) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">as</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">mut</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">u8</span></span>
<span id="cb6-6">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-7">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">#[</span>cfg<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">(</span>target_os <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"macos"</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">)]</span></span>
<span id="cb6-8">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-9">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> layout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>align() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">31</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-10">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">ptr::</span>null_mut()</span>
<span id="cb6-11">                <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb6-12">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb6-13">            aligned_malloc(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>layout) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// --&gt; more or less is: libc::memalign(layout.align(), layout.size()) as *mut u8</span></span>
<span id="cb6-14">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb6-15">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb6-16">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span></span></code></pre></div></div>
<p>That‚Äôs it for now! we have covered most of the basics and important aspects of <code>std::alloc</code>.</p>


</section>

 ]]></description>
  <category>Rust</category>
  <guid>https://ehsanmkermani.com/posts/2019-07-03-rust-std-study-series-alloc/</guid>
  <pubDate>Wed, 03 Jul 2019 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Rust std study series: Interior mutability</title>
  <dc:creator>Ehsan M. Kermani</dc:creator>
  <link>https://ehsanmkermani.com/posts/2019-06-18-rust-std-study-series-interior-mutability/</link>
  <description><![CDATA[ 





<p><img src="https://ehsanmkermani.com/posts/2019-06-18-rust-std-study-series-interior-mutability/images/rustacean-flat-happy-2.png" class="img-fluid"></p>
<p>Continuing the standard library study, it‚Äôs time for <code>Cell&lt;T&gt;</code>!</p>
<p>Rust compiler enforces<em>multiple reads</em>access and a<em>single write</em>access mutually exclusive, i.e.&nbsp;either multiple shared references <code>&amp;</code> or one and only one mutable reference <code>&amp; mut</code>. So essentially, Rust prevents the evil of<em>aliasing and mutation between multiple threads</em>.</p>
<p><code>Cell&lt;T&gt;</code> is a<strong>sharable mutable container</strong>designed carefully to prevent stepping into the UB land. Note that<em>unsafe cast</em>of <code>&amp;</code> to <code>&amp; mut</code> is<strong>immediate UB</strong>, so <code>Cell</code> was designed to manage/catch such UB at compile time. This container behaves like <code>&amp;</code> allowing <code>&amp; mut</code>. However, there‚Äôs a distinction between a single threaded behavior and multi-threaded one:<em>Single threaded: <code>Cell&lt;T&gt;</code> (<strong>owns</strong>a values) and <code>RefCell&lt;T&gt;</code> (<strong>borrows</strong>a value with</em>runtime<em>cost).</em>Multi-threaded: <code>Mutex&lt;T&gt;</code>, <code>RwLock&lt;T&gt;</code>, etc. (synchronization primitives)</p>
<p>The essence of <code>Cell</code> can be understood in terms of<em>Variance</em>and the compiler support which <a href="https://ehsanmkermani.com/2019/03/16/variance-in-rust-an-intuitive-explanation/">we explored before</a>. As usual, std has a great explanations in particular, an enlightening example in <a href="https://doc.rust-lang.org/std/cell/#mutating-implementations-of-clone"><strong>mutating implementations of Clone</strong></a> that manages the side-effect of <code>Rc&lt;T&gt;</code> via <code>Cell</code>. In other words, an<em>immutable struct</em>with a <code>Cell</code> ed field allows mutation for that field.</p>
<p>There core primitive for interior mutability is <code>UnsafeCell&lt;T&gt;</code> which to my knowledge is the only<em>invariant container</em>.</p>
<section id="cell" class="level2">
<h2 class="anchored" data-anchor-id="cell">Cell<t></t></h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode rust code-with-copy"><code class="sourceCode rust"><span id="cb1-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">#[</span>lang <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"unsafe_cell"</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">]</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// &lt;-- invariant type support</span></span>
<span id="cb1-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">#[</span>repr<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">(</span>transparent<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">)]</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// &lt;-- enforces the same type repr as the underlying `T`</span></span>
<span id="cb1-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">pub</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">struct</span> UnsafeCell<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Sized</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-4">    value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-5"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// UnsafeCell is not Sync, hence "single-threadedness".</span></span>
<span id="cb1-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// In other words, it cannot share references between multiple threads </span></span>
<span id="cb1-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">impl</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Sized</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Sync</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> UnsafeCell<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span></span>
<span id="cb1-9"></span>
<span id="cb1-10"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">impl</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Sized</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> UnsafeCell<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-11">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">pub</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">const</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fn</span> get(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">self</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">mut</span> T <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-12">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// We can just cast the pointer from `UnsafeCell&lt;T&gt;` to `T` because of</span></span>
<span id="cb1-13">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// #[repr(transparent)]</span></span>
<span id="cb1-14">        <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">self</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">as</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">const</span> UnsafeCell<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">as</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">const</span> T <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">as</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">mut</span> T</span>
<span id="cb1-15">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-16"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-17"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">#[</span>repr<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">(</span>transparent<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">)]</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// &lt;-- so the final type repr is the same as `T`</span></span>
<span id="cb1-18"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">pub</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">struct</span> Cell<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Sized</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-19">    value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> UnsafeCell<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;,</span></span>
<span id="cb1-20"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-21"></span>
<span id="cb1-22"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">impl</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Copy</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> Cell<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// &lt;-- note that `T` must be `Copy`</span></span>
<span id="cb1-23">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">pub</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fn</span> get(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">self</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> T <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-24">        <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">unsafe</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">self</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-25">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-26"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-27"></span>
<span id="cb1-28"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">impl</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> Cell<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-29">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// compile time guarantee that we process the ONLY one reference</span></span>
<span id="cb1-30">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">pub</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fn</span> get_mut(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">mut</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">self</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">mut</span> T <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-31">        <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">unsafe</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-32">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">mut</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">self</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get()</span>
<span id="cb1-33">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-34">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-35">    </span>
<span id="cb1-36">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">pub</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fn</span> set(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">self</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> val<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> T) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-37">        <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> old <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">self</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>replace(val)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-38">        drop(old)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// &lt;-- drops the old value</span></span>
<span id="cb1-39">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-40"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-41"></span>
<span id="cb1-42"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Uphold the assumption of the wrapped `UnsafeCell`</span></span>
<span id="cb1-43"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">impl</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Sized</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Sync</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> Cell<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span></span>
<span id="cb1-44"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// If `T` can be transferred across thread boundaries, so does `Cell`</span></span>
<span id="cb1-45"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">unsafe</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">impl</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Sized</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Send</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> Cell<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">where</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Send</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span></span></code></pre></div></div>
<section id="notable-propertiescells-get-method-is-definedonlyfor-copy-i.e.bit-wise-copyable-otherwise-cannot-move-of-the-borrowed-self.only-when-the-underlying-type-is-copy-it-is-possible-to-clone-the-cell.cells-swap-method-is-just-a-pointer-swap-and-the-difference-between-this-and-memswap-is-cells-swap-doesnt-need-mut.cells-take-method-takes-the-value-of-the-cell-and-leaves-defaultdefault-value-in-its-place.cells-replace-method-uses-memreplace-to-replace-the-new-value-and-return-the-old-value.cellt-is-send-sync-given-t-send-meaning-it-is-safe-to-transfer-cell-between-multiple-threads-when-the-underlying-value-allows-us-butreferencesof-the-cellcannot-be-sharedbetween-multiple-threads." class="level3">
<h3 class="anchored" data-anchor-id="notable-propertiescells-get-method-is-definedonlyfor-copy-i.e.bit-wise-copyable-otherwise-cannot-move-of-the-borrowed-self.only-when-the-underlying-type-is-copy-it-is-possible-to-clone-the-cell.cells-swap-method-is-just-a-pointer-swap-and-the-difference-between-this-and-memswap-is-cells-swap-doesnt-need-mut.cells-take-method-takes-the-value-of-the-cell-and-leaves-defaultdefault-value-in-its-place.cells-replace-method-uses-memreplace-to-replace-the-new-value-and-return-the-old-value.cellt-is-send-sync-given-t-send-meaning-it-is-safe-to-transfer-cell-between-multiple-threads-when-the-underlying-value-allows-us-butreferencesof-the-cellcannot-be-sharedbetween-multiple-threads.">Notable properties<em><a href="https://doc.rust-lang.org/std/cell/struct.Cell.html#method.get">Cell‚Äôs get method</a> is defined<strong>only</strong>for <code>Copy</code> i.e.</em>bit-wise copyable<em>, otherwise cannot move of the borrowed <code>&amp;self</code>.</em>Only when the underlying type is <code>Copy</code> it is possible to <code>clone</code> the <code>Cell</code>.<em><a href="https://doc.rust-lang.org/std/cell/struct.Cell.html#method.swap">Cell‚Äôs swap method</a> is just a pointer swap and the difference between this and <a href="https://doc.rust-lang.org/std/mem/fn.swap.html"><code>mem::swap</code></a> is Cell‚Äôs swap doesn‚Äôt need <code>&amp; mut</code>.</em><a href="https://doc.rust-lang.org/std/cell/struct.Cell.html#method.take">Cell‚Äôs take method</a>, takes the value of the cell and leaves <code>Default::default</code> value in its place.<em><a href="https://doc.rust-lang.org/std/cell/struct.Cell.html#method.replace">Cell‚Äôs replace method</a> uses <code>mem::replace</code> to replace the new value and return the old value.</em><code>Cell&lt;T&gt;</code> is <code>Send + !Sync</code> (given <code>T: Send</code>), meaning it is safe to transfer <code>Cell</code> between multiple threads (when the underlying value allows us) but<strong>references</strong>of the <code>Cell</code><strong>cannot be shared</strong>between multiple threads.</h3>
</section>
<section id="refcell" class="level3">
<h3 class="anchored" data-anchor-id="refcell">RefCell<t></t></h3>
<blockquote class="blockquote">
<p>A mutable memory location with dynamically checked borrow rules</p>
<p>Rust std doc</p>
</blockquote>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode rust code-with-copy"><code class="sourceCode rust"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Positive values shows the number of active `Ref`</span></span>
<span id="cb2-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Negative values shows the number of active `RefMut`</span></span>
<span id="cb2-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">type</span> BorrowFlag <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">isize</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-4"></span>
<span id="cb2-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">pub</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">struct</span> RefCell<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Sized</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-6">    borrow<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> Cell<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>BorrowFlag<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;,</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// &lt;-- subtle</span></span>
<span id="cb2-7">    value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> UnsafeCell<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;,</span></span>
<span id="cb2-8"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-9"></span>
<span id="cb2-10"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">unsafe</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">impl</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Sized</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Send</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> RefCell<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">where</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Send</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span></span>
<span id="cb2-11"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">impl</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Sized</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Sync</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> RefCell<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span></span>
<span id="cb2-12"></span>
<span id="cb2-13"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">struct</span> BorrowRef<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">'b</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-14">    borrow<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">'b</span> Cell<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>BorrowFlag<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;,</span></span>
<span id="cb2-15"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-16"></span>
<span id="cb2-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/// A wrapper type for an immutably borrowed value from a `RefCell&lt;T&gt;`</span></span>
<span id="cb2-18"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">pub</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">struct</span> Ref<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">'b</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Sized</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">'b</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-19">    value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">'b</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-20">    borrow<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> BorrowRef<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">'b</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;,</span></span>
<span id="cb2-21"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-22"></span>
<span id="cb2-23"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">struct</span> BorrowRefMut<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">'b</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-24">    borrow<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">'b</span> Cell<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>BorrowFlag<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;,</span></span>
<span id="cb2-25"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-26"></span>
<span id="cb2-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/// A wrapper type for a mutably borrowed value from a `RefCell&lt;T&gt;`</span></span>
<span id="cb2-28"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">pub</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">struct</span> RefMut<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">'b</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Sized</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">'b</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-29">    value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">'b</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">mut</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-30">    borrow<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> BorrowRefMut<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">'b</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;,</span></span>
<span id="cb2-31"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></div>
<blockquote class="blockquote">
<p><code>Ref</code> and <code>RefMut</code> are both two words in size, and so there will likely never be enough <code>Ref</code>s or <code>RefMut</code>s in existence to overflow half of the <code>usize</code> range. Thus, a <code>BorrowFlag</code> will probably never overflow or underflow. However, this is not a guarantee, as a pathological program could repeatedly create and then <code>mem::forget</code> <code>Ref</code>s or <code>RefMut</code>s. Thus, all code must explicitly check for overflow and underflow in order to avoid unsafety, or at least behave correctly in the event that overflow or underflow happens.</p>
<p>Internal std doc of BorrowFlag</p>
</blockquote>
<p>One important distinction between <code>RefCell</code> and <code>Cell</code> is the ability to<em><code>try_borrow</code> (and the panicking version<code>borrow</code>):</em>It immutably borrows the wrapped value, returning an error if the value is currently mutably borrowed<strong>.</strong>The borrow lasts until the returned <code>Ref</code> exits scope.<em> </em><a href="https://doc.rust-lang.org/std/cell/struct.RefCell.html#method.try_borrow_mut"><code>try_borrow_mut</code></a> (panicking version <code>borrow_mut</code>):<em>Mutably borrows the wrapped value, returning an error if the value is currently borrowed. The borrow lasts until the returned <code>RefMut</code> or all <code>RefMut</code>s derived from it exit scope. The value cannot be borrowed while this borrow is active.</em>We‚Äôve covered most of details and important points of how managed interior mutability is possible in Rust.</p>


</section>
</section>

 ]]></description>
  <category>Rust</category>
  <guid>https://ehsanmkermani.com/posts/2019-06-18-rust-std-study-series-interior-mutability/</guid>
  <pubDate>Tue, 18 Jun 2019 00:00:00 GMT</pubDate>
</item>
<item>
  <title>The State of Machine Learning in Rust</title>
  <dc:creator>Ehsan M. Kermani</dc:creator>
  <link>https://ehsanmkermani.com/posts/2019-05-13-state-of-machine-learning-in-rust/</link>
  <description><![CDATA[ 





<p>Every once in a while this topic comes up on a social media or Rust <a href="https://users.rust-lang.org/t/is-rust-good-for-deep-learning-and-artificial-intelligence/22866">user channel</a>. I‚Äôd like to describe briefly the way I see where things are going by a little bit of history as well as some information about existing flux of Machine Learning/Deep Learning frameworks and major recent trends.</p>
<section id="brief-history-and-where-we-are-now" class="level2">
<h2 class="anchored" data-anchor-id="brief-history-and-where-we-are-now">Brief history and where we are now?</h2>
<p>Existing ML/DL ecosystems are huge because they are the combinations of High Performance Computing, Mathematical Optimization, System and Compiler Engineering, etc. etc. So for the sake of simplicity, if we go by the common breakdown of ML into<strong>traditional ML</strong>vs.<strong>DL</strong>(overlap included), then <a href="https://crates.io/crates/rusty-machine">rusty-machine</a>, <a href="https://crates.io/crates/rustlearn">rustlearn</a> vs.&nbsp;<a href="https://crates.io/crates/leaf">leaf</a> comes in front of our eyes. They have done very interesting and bold developments, in particular, <code>leaf</code> at their time, but eventually they were mostly abandoned because of the huge task of creating a complete open-source ML/DL framework which requires<em>Various<strong>language supports</strong>(will get into in a bit)</em><strong>Mature base</strong>linear algebra and statistic crates*A<strong>community</strong>of ML specialists who happen to know Rust and are willing to contribute</p>
<p>Dominant existing ML libraries (mostly in Python/Cython or C++) have been developed with all these supports and Rust is no exception.</p>
<section id="language-support-and-crates" class="level3">
<h3 class="anchored" data-anchor-id="language-support-and-crates">Language support and crates</h3>
<p>A while ago<em>Gonzalo</em>has put up a <a href="https://internals.rust-lang.org/t/roadmap-2017-request-needs-of-hpc/4276">list of HPC requirements</a> which as of now, we can say Rust supports most of the items as language (stable/unsable) features or in crates and hopefully by the end of this year we will see more and more supports. Still <a href="https://github.com/rust-lang/rfcs/blob/master/text/2000-const-generics.md">constant-generics</a> (good array support), stable <code>std::simd</code> and native GPU, async etc. supports are work-in-progress. Some workarounds and existing solutions namely are; <a href="https://crates.io/crates/generic-array">generic-array</a> (using <a href="https://crates.io/crates/typenum">typenum</a>), <a href="https://github.com/rust-lang-nursery/packed_simd">packed simd</a>, <a href="https://github.com/bheisler/RustaCUDA">RustaCUDA</a>. For<em>MPI</em>, there‚Äôs an <a href="https://github.com/bsteinb/rsmpi">MPI-binding</a> and for<em>OpenMP</em>, there‚Äôs <a href="https://github.com/rayon-rs/rayon">rayon</a>.</p>
</section>
<section id="linear-algebra-base" class="level3">
<h3 class="anchored" data-anchor-id="linear-algebra-base">Linear algebra base</h3>
<p><a href="https://www.arewelearningyet.com/">Are we learning yet?</a> is tracking most of the signals in this area and a simple search over <a href="https://crates.io/search?q=machine%20learning">crates.io</a> will tell you that we have a lot of things to cover, so when in comes to production Rust is not there yet!</p>
<p>Thanks to<em>bluss</em>who initiated <a href="https://github.com/rust-ndarray/ndarray">ndarray</a> and various contributors, <code>ndarray</code> has become the <code>numpy</code> of Rust i.e.&nbsp;the base linear algebra crate (though still a lot to be done). Note that, this is very fundamental and simply wrapping BLAS/BLIS, LAPACK etc. are not enough!</p>
<p><code>ndarray</code> has become the base for Rust ML ecosystem where others are building upon for example, <a href="https://crates.io/crates/ndarray-linalg">ndarray-linalg</a>, <a href="https://crates.io/crates/ndarray-stats">ndarray-stats</a>.</p>
</section>
<section id="community" class="level3">
<h3 class="anchored" data-anchor-id="community">Community</h3>
<p>Looking back, it is fair to say people have been, more or less, experimenting with Rust for ML. I think the experimental phase is getting into its final stage, once Rust pushes the immediate requirements such as const-generic, GAT, <code>std::simd</code>, GPU support. I think the community is getting bigger and considering the collective efforts of the authors and contributors of the aforementioned crates, the number of ML specialists and enthusiasts is approx. where we can all get together to do interesting things by learning from and assessing existing ones (in particular in Python) to create our own curated Rust ecosystem. I think it is time to create an<em>ML Working Group</em>or at least for now, if you‚Äôre interested you can join <a href="https://github.com/rust-ml">rust-ml</a> group to see how things would turn out.</p>
</section>
</section>
<section id="what-about-deep-learning" class="level2">
<h2 class="anchored" data-anchor-id="what-about-deep-learning">What about Deep Learning?</h2>
<p>This is the area I‚Äôm mostly passionate about. DL<em>frontiers</em>are pushing more and more into systems and compiler so that harder computations, graph level optimizations,<em>differentiation</em>(aka differentiable programming), efficient codegen and kernel generations etc. to happen at the<em>compile time</em>. Major frontiers are; <a href="https://github.com/dmlc/tvm/">TVM</a>, <a href="https://github.com/tensorflow/swift">tensorflow/swift</a>, <a href="https://github.com/pytorch/glow">pytorch/glow</a> (also <a href="https://github.com/pytorch/tvm">pytorch with TVM</a> backend). So when it comes to Rust, all these efforts<strong>cannot be ignored</strong>.</p>
<p>Therefore, a (short term) solution is creating bindings. That‚Äôs what <a href="https://github.com/dmlc/tvm/tree/master/rust/frontend">I did for TVM</a>. Basically, we can train (mostly vision tasks now) using any DL frameworks (TensorFlow, PyTorch, MXNet) or bridge some with <a href="https://github.com/onnx/onnx">ONNX</a>, then compile using TVM on varieties of supported hardwares, and for<strong>inference</strong>, we can use our beloved Rust. I should also mention the existing bindings such as <a href="https://github.com/tensorflow/rust">tensorflow/rust</a> and <a href="https://github.com/LaurentMazare/tch-rs">tch-rs</a>. The major problem with these bindings is they‚Äôre limited. For example, <code>tenorflow/rust</code> does not have the higher abstractions that Python has now and <code>tch-rs</code> is<em>far from being safe</em>.</p>
<p>Inference, in particular on edge devices, is one of the hottest areas. Another very interesting project which uses Rust for inference is <a href="https://github.com/snipsco/tract">tract</a> which has good support for TF and ONNX ops. I should mention that Google‚Äôs <a href="https://www.tensorflow.org/lite/">TFLite</a>, Tencent‚Äôs <a href="https://github.com/Tencent/ncnn">NCNN</a> or <a href="https://github.com/Tencent/FeatherCNN">FeatherCNN</a>, Xiaomi‚Äôs <a href="https://github.com/XiaoMi/mace">MACE</a> and Microsoft‚Äôs <a href="https://github.com/Microsoft/ELL">ELL</a> are all trying to push their own solutions, but frankly, they‚Äôre still limited to certain well-known tasks and are painful to use for varieties of other tasks.</p>
<p>You might ask,<em>how about creating a DL framework in Rust from scratch?</em>I‚Äôd say, first read the source code of any major DL framework and try to catch up on the compiler development. Then you‚Äôll see the pieces are moving fast and haven‚Äôt even converged to a relatively complete solution. Though it could work out as a<em>very</em>long term solution, personally I‚Äôm not interested now.</p>
</section>
<section id="final-words" class="level2">
<h2 class="anchored" data-anchor-id="final-words">Final words</h2>
<p>I love Rust because of two main reasons<em>It is very community driven and offering solutions never/less seen before by keeping the community healthy where</em>no-ego<em>rules and any inputs are welcome</em>The community and in particular the<em>leaders</em>have<em>high EQ</em>which in my opinion, is one of the most neglected cohesive forces in fruitful long lasting open-source communities</p>
<p>I would love to see Rust flourishing in ML/DL domains. There are still areas that it lacks a decent crate such as a<em>Visualizations</em>crate for ML type of workloads, but my bet is on Rust. I hope this post has cleared up where Rust is when it comes to ML/DL. For inputs from other people, please see the <a href="https://github.com/rust-ml/discussion/issues/1">rust-ml discussion</a>.</p>


</section>

 ]]></description>
  <category>Machine Learning</category>
  <category>Rust</category>
  <guid>https://ehsanmkermani.com/posts/2019-05-13-state-of-machine-learning-in-rust/</guid>
  <pubDate>Mon, 13 May 2019 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Rust std study series: VecDeque</title>
  <dc:creator>Ehsan M. Kermani</dc:creator>
  <link>https://ehsanmkermani.com/posts/2019-04-28-rust-std-study-series-vecdeque/</link>
  <description><![CDATA[ 





<p><img src="https://ehsanmkermani.com/posts/2019-04-28-rust-std-study-series-vecdeque/images/rustacean-flat-happy-2.png" class="img-fluid"></p>
<p>Continuing from <a href="https://doc.rust-lang.org/std/">Rust standard library</a> study series, it‚Äôs time for <a href="https://doc.rust-lang.org/std/collections/struct.VecDeque.html">VecDeque<t></t></a>. Because of its similarity to <code>Vec</code>, there isn‚Äôt much to say.</p>
<blockquote class="blockquote">
<p>A<em>double-ended</em><strong>queue</strong>implemented with a<em>growable <a href="https://en.wikipedia.org/wiki/Circular_buffer">ring buffer</a></em>.<br>
The ‚Äúdefault‚Äù usage of this type as a queue is to use <a href="https://doc.rust-lang.org/std/collections/struct.VecDeque.html#method.push_back"><code>push_back</code></a> to<strong>add</strong>to the queue, and <a href="https://doc.rust-lang.org/std/collections/struct.VecDeque.html#method.pop_front"><code>pop_front</code></a> to<strong>remove</strong>from the queue. <a href="https://doc.rust-lang.org/std/collections/struct.VecDeque.html#method.extend"><code>extend</code></a> and <a href="https://doc.rust-lang.org/std/collections/struct.VecDeque.html#method.append"><code>append</code></a> push onto the back in this manner, and iterating over <code>VecDeque</code> goes front to back.</p>
<p>Rust std doc<em>Similar to <code>Vec</code>, <code>VecDeque</code> has amortized <img src="https://latex.codecogs.com/png.latex?O(1)"> insert to both ends of the container, but unlike <code>Vec</code>, it has amortized <img src="https://latex.codecogs.com/png.latex?O(1)"> removal from both ends. (Recalling from <code>Vec</code> study, removal is strictly <img src="https://latex.codecogs.com/png.latex?O(1)"> with no shrink factor involved)</em>Similar to <code>Vec</code>, indexing is <img src="https://latex.codecogs.com/png.latex?O(1)."></p>
</blockquote>
<p>Similar to <a href="https://ehsanmkermani.com/2019/03/10/rust-std-study-series-vec/">Vec<t> study</t></a>, here‚Äôs the stripped down definition of <code>VecDeque&lt;T&gt;</code></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode rust code-with-copy"><code class="sourceCode rust"><span id="cb1-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">struct</span> VecDeque<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// tail and head are pointers into the buffer. Tail always points</span></span>
<span id="cb1-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// to the first element that could be read, Head always points</span></span>
<span id="cb1-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// to where data should be written.</span></span>
<span id="cb1-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// If tail == head the buffer is empty. The length of the ringbuffer</span></span>
<span id="cb1-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// is defined as the distance between the two.</span></span>
<span id="cb1-7">    tail<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">usize</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-8">    head<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">usize</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-9">    buf<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> RawVec<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;,</span></span>
<span id="cb1-10"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-11"></span>
<span id="cb1-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Default Global allocator</span></span>
<span id="cb1-13"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">struct</span> RawVec<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Alloc</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Global<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-14">    ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> Unique<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;,</span></span>
<span id="cb1-15">    cap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">usize</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-16">    a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-17"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-18"></span>
<span id="cb1-19"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">#[</span>repr<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">(</span>transparent<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">)]</span></span>
<span id="cb1-20"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">struct</span> Unique<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Sized</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-21">    pointer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">const</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-22">    _marker<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> PhantomData<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;,</span></span>
<span id="cb1-23"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></div>
<p>The same <code>Vec</code> methods, such as <code>with_capacity</code> (note that ring buffer always<em>leaves one space empty</em>), <code>truncate</code>, <code>shrink_to</code> etc. exist and follow the same observations as in <code>Vec</code> study. The notable methods are<em><code>push_back</code> and <code>pop_back</code> which involve moving the <code>head</code> pointer and <code>push_front</code> and <code>pop_front</code> which involve moving the <code>tail</code> pointer.</em><a href="https://doc.rust-lang.org/std/collections/struct.VecDeque.html#method.retain">retain</a> which acts as the filter method.<em><a href="https://doc.rust-lang.org/std/collections/struct.VecDeque.html#method.resize_with">resize_with</a> with a <code>generator: impl FnMut() -&gt; T</code></em><a href="https://doc.rust-lang.org/std/collections/struct.VecDeque.html#method.as_slices">as_slices</a> (and the mut one) which contains, in order the content of the <code>VecDeque</code>.</p>
<p>That‚Äôs it for now!</p>



 ]]></description>
  <category>Rust</category>
  <guid>https://ehsanmkermani.com/posts/2019-04-28-rust-std-study-series-vecdeque/</guid>
  <pubDate>Sun, 28 Apr 2019 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Rust std study series: LinkedList</title>
  <dc:creator>Ehsan M. Kermani</dc:creator>
  <link>https://ehsanmkermani.com/posts/2019-03-25-rust-std-study-linkedlist/</link>
  <description><![CDATA[ 





<p><img src="https://ehsanmkermani.com/posts/2019-03-25-rust-std-study-linkedlist/images/rustacean-flat-happy-2.png" class="img-fluid"></p>
<p>Continuing from <a href="https://doc.rust-lang.org/std/">Rust standard library</a> study series, it‚Äôs time for <code>LinkedList&lt;T&gt;</code>. Note that implementation are taken from<em>Rust stable v1.33.0</em>.</p>
<blockquote class="blockquote">
<p>A<strong>doubly-linked</strong>list with<strong>owned nodes</strong>.<br>
The <code>LinkedList</code> allows<em>push</em>ing and<em>pop</em>ping elements at either end in<strong>constant time</strong>.<br>
Almost always it is better to use <code>Vec</code> or <code>VecDeque</code> instead of <code>LinkedList</code>. In general, array-based containers are<strong>faster</strong>, more memory efficient<strong>and make better use of CPU</strong>cache**.</p>
<p>Rust std doc</p>
</blockquote>
<p>Note that unlike <code>Vec&lt;T&gt;</code></p>
<ol type="1">
<li>accessing an element through index is <img src="https://latex.codecogs.com/png.latex?O(n)"> i.e.&nbsp;needs to iterate linearly over the list.</li>
<li><code>append</code> is <img src="https://latex.codecogs.com/png.latex?O(1)."></li>
<li>Interesting how <code>linked_list::Iter</code> is different from <code>linked_list::IterMut</code>. Invariant of <code>IterMut</code> is enforced with <code>&amp;mut</code> and <code>PhantomData&lt;&amp;'a Node&lt;T&gt;&gt;</code> ensures soundness (more on <code>PhantomData</code>, dropck later).</li>
</ol>
<p>There‚Äôs an <a href="http://cglab.ca/~abeinges/blah/too-many-lists/book/">entire book</a> (which I highly recommend to go through details if you haven‚Äôt already) convincing the reader why it‚Äôs tricky to implement even<em>singly</em>-linked list and most probably not a good idea for new Rust users!</p>
<p>Because of Rust‚Äôs affine type system / ownership, it‚Äôs actually tricky to implement<em>doubly</em>-linked list. The main reason is it seems a node needs to have<em>two owners</em>from adjacent nodes. However, that‚Äôs possible with <code>NonNull&lt;T&gt;</code> which we talked about in <code>Vec&lt;T&gt;</code> <a href="https://ehsanmkermani.com/2019/03/10/rust-std-study-series-vec/">study</a>.</p>
<p>Here‚Äôs the stripped down definition</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode rust code-with-copy"><code class="sourceCode rust"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Note: NonNull&lt;T&gt; does NOT own the referent</span></span>
<span id="cb1-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">#[</span>repr<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">(</span>transparent<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">)]</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// &lt;-- enforces the same type representation as *const T</span></span>
<span id="cb1-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">struct</span> NonNull<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Sized</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-4">    pointer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">const</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-5"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-6"></span>
<span id="cb1-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">struct</span> Node<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-8">    next<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Option</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>NonNull<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Node<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;&gt;,</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Not Option&lt;Box&lt;Node&lt;T&gt;&gt;&gt;</span></span>
<span id="cb1-9">    prev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Option</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>NonNull<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Node<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;&gt;,</span></span>
<span id="cb1-10">    element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-11"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-12"></span>
<span id="cb1-13"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">struct</span> LinkedList<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-14">    head<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Option</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>NonNull<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Node<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;&gt;,</span></span>
<span id="cb1-15">    tail<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Option</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>NonNull<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Node<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;&gt;,</span></span>
<span id="cb1-16">    len<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">usize</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-17">    marker<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> PhantomData<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Box</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Node<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;&gt;,</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// &lt;-- sound dropck</span></span>
<span id="cb1-18"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></div>
<section id="why-not-optionboxnodet" class="level3">
<h3 class="anchored" data-anchor-id="why-not-optionboxnodet">Why not <code>Option&lt;Box&lt;Node&lt;T&gt;&gt;&gt;</code> ?</h3>
<p>It‚Äôs probably a good idea to see what would be the difference if we use <code>Box&lt;Node&lt;T&gt;&gt;</code> instead. We discussed what <code>Unique&lt;T&gt;</code> is and how it‚Äôs different from <code>NonNull&lt;T&gt;</code> previously, but as a quick reminder, <code>Unique&lt;T&gt;</code> owns the referent whereas <code>NonNull&lt;T&gt;</code> does not and in fact <code>Box&lt;T&gt;</code> (a<strong>pointer type</strong>for<strong>heap allocation</strong>) just wraps <code>Unique&lt;T&gt;</code> and provides new interface for interacting with <code>Unique&lt;T&gt;</code>.</p>
<p>Let‚Äôs consider <code>Node&lt;T&gt;</code> with <code>Box</code> as follows (<a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=0bee2ec0e478b34557daffcb05e4a55a">playpen link</a>)</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode rust code-with-copy"><code class="sourceCode rust"><span id="cb2-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">struct</span> Node<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-2">    prev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Option</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Box</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Node<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;&gt;,</span></span>
<span id="cb2-3">    next<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Option</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Box</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Node<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;&gt;,</span></span>
<span id="cb2-4">    element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-5"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-6"></span>
<span id="cb2-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fn</span> main() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-8">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">mut</span> head_node <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Node <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-9">        prev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">None</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-10">        next<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">None</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-11">        element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-12">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb2-13">    </span>
<span id="cb2-14">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> next_node <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Node <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-15">        prev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">Some</span>(<span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Box</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">::</span>new(head_node))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// &lt;-- head_node is moved here</span></span>
<span id="cb2-16">        next<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">None</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-17">        element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-18">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb2-19">    </span>
<span id="cb2-20">    head_node<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>next <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">Some</span>(<span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Box</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">::</span>new(next_node))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Not good!</span></span>
<span id="cb2-21"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></div>
<p>This begs for<em>Use-After-Free</em>(UAF) so<em>Undefined Behavior</em>(UB) which we know we shouldn‚Äôt push further. However, using a non-owning <code>NonNull&lt;T&gt;</code> can solve the problem as follows (<a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=16f03cf6df4832dc45c19d7d549a1bcf">playpen link</a>)</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode rust code-with-copy"><code class="sourceCode rust"><span id="cb3-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">use</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">std::ptr::</span>NonNull<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-2"></span>
<span id="cb3-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">struct</span> Node<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-4">    prev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Option</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>NonNull<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Node<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;&gt;,</span></span>
<span id="cb3-5">    next<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Option</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>NonNull<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>Node<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;&gt;,</span></span>
<span id="cb3-6">    element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb3-7"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-8"></span>
<span id="cb3-9"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fn</span> main() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-10">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">mut</span> head_node <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Node <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-11">        prev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">None</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb3-12">        next<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">None</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb3-13">        element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb3-14">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb3-15">    </span>
<span id="cb3-16">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> next_node <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Node <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-17">        prev<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">NonNull::</span>new(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">mut</span> head_node <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">as</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">mut</span> _)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb3-18">        next<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">None</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb3-19">        element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb3-20">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb3-21">    </span>
<span id="cb3-22">    head_node<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>next <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">NonNull::</span>new(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>next_node <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">as</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">const</span> _ <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">as</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">mut</span> _)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-23"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></div>
<p>But how can we make sure this is sound esp.&nbsp;when using it in <code>LinkedList&lt;T&gt;</code>. More precisely</p>
</section>
<section id="whats-the-relation-between-phantomdata-and-dropck" class="level3">
<h3 class="anchored" data-anchor-id="whats-the-relation-between-phantomdata-and-dropck">What‚Äôs the relation between <code>PhantomData</code> and dropck ?</h3>
<p>I‚Äôve been trying to understand the deeper relation between <code>PhantomData</code> and what makes dropck sound (so does <code>LinkedList&lt;T&gt;</code> sound), but couldn‚Äôt find any clear explanations so I asked it in the user channel and got an <a href="https://users.rust-lang.org/t/phantomdata-and-dropck-confusion/26624">amazing thorough answer</a> which can be generalized to <code>Vec</code>, <code>LinkedList</code> etc.</p>


</section>

 ]]></description>
  <category>Rust</category>
  <guid>https://ehsanmkermani.com/posts/2019-03-25-rust-std-study-linkedlist/</guid>
  <pubDate>Mon, 25 Mar 2019 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Variance in Rust: An intuitive explanation</title>
  <dc:creator>Ehsan M. Kermani</dc:creator>
  <link>https://ehsanmkermani.com/posts/2019-03-16-variance-in-rust-an-intuitive-explanation/</link>
  <description><![CDATA[ 





<p>Recently I‚Äôve made a <a href="https://github.com/ehsanmok/van-rust-meetup/blob/master/type_system/subtyping.md">presentation</a> about<em>subtyping and variance in Rust</em>for our local <a href="https://www.meetup.com/Vancouver-Rust/">Vancouver Rust meetup</a>, but I still think intuition was rather lost in the formalism, so here‚Äôs my shot at explaining it as<em>intuitively</em>as I can. For more succinct definitions, please checkout the presentation or the resources at the end.</p>
<p>First, two important points that we‚Äôre going to talk about</p>
<ol type="1">
<li>Variance is a concept related to<strong>generic parameter(s)</strong>.</li>
<li>Rust has<strong>subtyping</strong>wrt<strong>lifetime parameters</strong>.</li>
</ol>
<p>Things can get confusing because a lifetime parameter is actually a generic parameter, so variance and subtyping are<em>tied</em>together.</p>
<section id="intuition" class="level2">
<h2 class="anchored" data-anchor-id="intuition">Intuition</h2>
<p>Variance in Rust is about allowing a lifetime parameter to be ok (i.e.&nbsp;approximated) with a</p>
<ol type="1">
<li>Shorter lifetime:<strong>co</strong>-variance</li>
<li>Longer lifetime:<strong>contra</strong>-variance</li>
<li>Neither shorter nor longer lifetime:<strong>in</strong>-variance</li>
</ol>
<p>These are actually the<strong>assumptions</strong>we need to make so that we can be sure our implementation is<strong>sound</strong>.<em>Note</em>: Wherever you see variance in Rust, by<em>default</em>it means covariance.</p>
<p>Now here‚Äôs a classic example:</p>
<p>Try to guess the output first. (<a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=475f965de3ffbcdddad860b47bded84b">Playground link</a>)</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode rust code-with-copy"><code class="sourceCode rust"><span id="cb1-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">struct</span> MyCell<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-2">    value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> T</span>
<span id="cb1-3"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-4"></span>
<span id="cb1-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">impl</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Copy</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> MyCell<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-6">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fn</span> new(value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> T) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Self</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-7">        MyCell <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-8">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-9"></span>
<span id="cb1-10">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fn</span> get(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">self</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> T <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-11">        <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">self</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>value</span>
<span id="cb1-12">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-13"></span>
<span id="cb1-14">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fn</span> set(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">self</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> new_value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> T) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-15">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// signature: pub unsafe fn write&lt;T&gt;(dst: *mut T, src: T)</span></span>
<span id="cb1-16">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Overwrites a memory location with the given value without reading</span></span>
<span id="cb1-17">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// or dropping the old value</span></span>
<span id="cb1-18">        <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">unsafe</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">std::ptr::</span>write(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">self</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>value <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">as</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">const</span> T <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">as</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">mut</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> new_value)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-19">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-20"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-21"></span>
<span id="cb1-22"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fn</span> foo(rcell<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>MyCell<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&amp;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">i32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-23">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> val<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">i32</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">13</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-24">    rcell<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>set(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>val)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-25">    <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">println!</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"foo set value: {}"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> rcell<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>value)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-26"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-27"></span>
<span id="cb1-28"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fn</span> main() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-29">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">static</span> X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">i32</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-30">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> cell <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">MyCell::</span>new(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>X)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-31">    foo(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>cell)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-32">    <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">println!</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"end value: {}"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> cell<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>value)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-33"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></div>
<p>And the output is</p>
<pre class="text"><code>foo set value: 13
end value: 32766 // ???</code></pre>
<p>If you could guess the<em>end value</em>will be non-sense you might skip to the end and if it‚Äôs unsettling and you were hoping the compiler will guide us here, please keep reading.</p>
<p>Well, before going into more details here‚Äôs the example using <code>Cell&lt;T&gt;</code>. Can you guess the output now? (<a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=d2fd20a2a14fec7d160992854f889572">Run in playground</a>)</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode rust code-with-copy"><code class="sourceCode rust"><span id="cb3-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">use</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">std::cell::</span>Cell<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-2"></span>
<span id="cb3-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fn</span> foo(rcell<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>Cell<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&amp;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">i32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-4">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> val<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">i32</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">13</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-5">    rcell<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>set(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>val)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-6"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-7"></span>
<span id="cb3-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fn</span> main() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb3-9">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">static</span> X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">i32</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-10">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> cell <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">Cell::</span>new(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>X)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-11">    foo(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>cell)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-12"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></div>
<p>And it doesn‚Äôt compile because of</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode rust code-with-copy"><code class="sourceCode rust"><span id="cb4-1">error[E0597]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> `val` does not live long enough</span>
<span id="cb4-2"> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--&gt;</span> src<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>rs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span></span>
<span id="cb4-3">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span></span>
<span id="cb4-4"><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fn</span> foo(rcell<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>Cell<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&amp;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">i32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-5">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span>                     <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> let<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">'s</span> call the lifetime of this reference `<span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>`</span>
<span id="cb4-6"><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span>     <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> val<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">i32</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">13</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-7"><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span>     rcell<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>set(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>val)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-8">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span>     <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">----------^^^^-</span></span>
<span id="cb4-9">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span>     <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span>         <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span></span>
<span id="cb4-10">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span>     <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span>         borrowed value does not live long enough</span>
<span id="cb4-11">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span>     argument requires that `val` is borrowed <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> `<span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>`</span>
<span id="cb4-12"><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-13">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> `val` dropped here <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">while</span> still borrowed</span>
<span id="cb4-14"></span>
<span id="cb4-15">error<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> aborting due to previous error</span></code></pre></div></div>
<p>Ok! this is what we expect from the compiler, right?</p>
<p>To understand where the root of the problem is in <code>MyCell&lt;T&gt;</code>, let‚Äôs try to analyze using <a href="https://doc.rust-lang.org/nightly/nomicon/lifetimes.html">nomicon‚Äôs visual representation of lifetime</a></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode rust code-with-copy"><code class="sourceCode rust"><span id="cb5-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">static</span> X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">i32</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-2"><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">'a</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb5-3">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> cell <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">MyCell::</span>new(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">'a</span> X)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-4">    <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">'b</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb5-5">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// foo(&amp;'b cell) more or less is:</span></span>
<span id="cb5-6">        <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">let</span> val<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">i32</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">13</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// &lt;-- created here</span></span>
<span id="cb5-7">        <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">'c</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb5-8">            rcell<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>set(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">'c</span> val)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-9">            <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">println!</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"foo set value: {}"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> rcell<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>value)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-10">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb5-11">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// &lt;-- val is dropped here</span></span>
<span id="cb5-12">    <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">println!</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"end value: {}"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> cell<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>value)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-13"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></div>
<p>The problem occurs when we‚Äôve allowed change/mutation to be ok for shorter lifetime <code>`c</code> than <code>`a</code> (co-variant assumption). However, clearly this is not sound, because <code>val</code> exists in <code>`b</code> and is <strong>dropped</strong> at the end of <code>`b</code>‚Äôs scope, that‚Äôs why printing the <code>cell.value</code> will be nonsense (content of a freed pointer!).</p>
<p><strong><em>Claim</em></strong>: It doesn‚Äôt matter how you implement <code>set</code> for <code>MyCell&lt;T&gt;</code> it‚Äôll <strong><em>always be unsound</em></strong>.</p>
<p>Pretty powerful claim! The reason is that the essence of <code>MyCell&lt;T&gt;</code> doesn‚Äôt put any restrictions on not allowing shorter lifetimes to mess up with its value. In other words, we‚Äôre kind of <em>forgetting</em> about any particular lifetime constraints, meaning that our <code>MyCell&lt;T&gt;</code> is co-variant wrt <code>T</code> where for our case <code>T</code>is <code>&amp;'a i32</code> so is co-variant wrt <code>`a</code>.</p>
<p>To be able to make such claims, we need to have <em>type-level</em> knowledge (more succinct treatment through type constructor) and value-level knowledge is <em>not</em> enough. We can be pretty sure that these issues have been taken care of when using types provided for us in standard library.</p>
</section>
<section id="but-how-does-cellt-enforce-in-variance" class="level2">
<h2 class="anchored" data-anchor-id="but-how-does-cellt-enforce-in-variance">But how does <code>Cell&lt;T&gt;</code> enforce in-variance?</h2>
<p>Here‚Äôs the stripped down definition of <code>Cell&lt;T&gt;</code></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode rust code-with-copy"><code class="sourceCode rust"><span id="cb6-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">pub</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">struct</span> Cell<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Sized</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-2">    value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> UnsafeCell<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;,</span></span>
<span id="cb6-3"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb6-4"></span>
<span id="cb6-5"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">#[</span>lang <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"unsafe_cell"</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">]</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// --&gt; known to the compiler</span></span>
<span id="cb6-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">pub</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">struct</span> UnsafeCell<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Sized</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-7">    value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-8"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></div>
<p>Wait what? what‚Äôs the difference? o_0</p>
<p>The answer has <a href="https://github.com/rust-lang/rust/blob/79d8a0fcefa5134db2a94739b1d18daa01fc6e9f/src/librustc_typeck/variance/terms.rs#L93">deep root in compiler with the attribute #[lang = ‚Äúunsafe_cell‚Äù]</a>.</p>
<section id="can-we-fix-mycellt-somehow" class="level3">
<h3 class="anchored" data-anchor-id="can-we-fix-mycellt-somehow">Can we fix <code>MyCell&lt;T&gt;</code> somehow?</h3>
<p>If you find yourself in a situation that need to make your type in-variant, you can include any in-variant type, such as <code>Cell&lt;T&gt;</code> or <code>UnsafeCell&lt;T&gt;</code> in <a href="https://doc.rust-lang.org/std/marker/struct.PhantomData.html">PhantomData</a>, for example with <code>PhantomData&lt;Cell&lt;T&gt;&gt;</code> (Exercise: Can you find other in-variant types?). <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=a018dacccbe4ac84fe96339b890427cf">Checkout how it fixes the issue</a>.</p>
<p>I hope you can see how important variance is and how the compiler is handling it for us in most cases. Complete understanding of this matter becomes really important when writing unsafe code in FFI for example.</p>
<p>You might ask how using a longer lifetime could be ok? Well, it‚Äôs kind of rare in fact. For example, for<code>fn(&amp;'a i32)</code> it‚Äôs ok to use <code>fn(&amp;'static i32)</code> so it is<em>contra-variant wrt its arguments</em>(and <code>fn</code> is co-variant wrt return types in general).</p>
<p>Lastly, for the sake of completeness, there‚Äôs a fourth case such as most of primitive types that are<strong>bi</strong>-variant, meaning they‚Äôre<em>both</em>co-variant and contra-variant.</p>
</section>
</section>
<section id="resources" class="level2">
<h2 class="anchored" data-anchor-id="resources">Resources</h2>
<p>If you‚Äôre interested in knowing more there are some great resources</p>
<ol type="1">
<li><a href="https://www.youtube.com/watch?v=fI4RG_uq-WU">Felix Klock presentation</a></li>
<li><a href="https://doc.rust-lang.org/stable/nomicon/subtyping.html">Rustonomicon</a>.</li>
<li>Other resources at the end of my presentation <a href="https://github.com/ehsanmok/van-rust-meetup/blob/master/type_system/subtyping.md#resources-smile">here</a>.</li>
<li>The <a href="https://github.com/rust-lang/rfcs/blob/master/text/0738-variance.md">Variance RFC</a> is excellent but don‚Äôt get confused with some historic changes.</li>
<li><a href="https://rust-lang.github.io/rustc-guide/variance.html">Rust compiler guide</a>.</li>
</ol>


</section>

 ]]></description>
  <category>Rust</category>
  <guid>https://ehsanmkermani.com/posts/2019-03-16-variance-in-rust-an-intuitive-explanation/</guid>
  <pubDate>Sat, 16 Mar 2019 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Rust std study series: Vec</title>
  <dc:creator>Ehsan M. Kermani</dc:creator>
  <link>https://ehsanmkermani.com/posts/2019-03-10-rust-std-study-series-vec/</link>
  <description><![CDATA[ 





<p><img src="https://ehsanmkermani.com/posts/2019-03-10-rust-std-study-series-vec/images/rustacean-flat-happy-2.png" class="img-fluid"></p>
<p>The upcoming series of blog posts will contain my study of <a href="https://doc.rust-lang.org/std/">Rust standard library</a>. I‚Äôve partially written some parts of the series in scattered places and want to gather them in one place for better and easier access. I intend to update whenever I discover something interesting/important to remember.</p>
<p>I‚Äôm referring to implementations in<em>Rust stable v1.33.0</em>.</p>
<p>This post covers some details of <a href="https://doc.rust-lang.org/std/vec/index.html">std::vec</a> that I found important.</p>
<section id="vec" class="level2">
<h2 class="anchored" data-anchor-id="vec">Vec<t></t></h2>
<p><code>Vec&lt;T&gt;</code> is a dynamic array which only grows and never shrinks automatically.</p>
<blockquote class="blockquote">
<p>A<em>contiguous</em><strong>growable array</strong>type with<strong>heap-allocatedcontents</strong>.</p>
<p>Rust std doc</p>
</blockquote>
<p>Notice the difference between its counterpart<em>stack-allocated fixed-size</em>array <code>[T; N]</code> (where at this time <code>N</code> needs to be a specified non-negative integer. <a href="https://github.com/rust-lang/rfcs/blob/26197104b7bb9a5a35db243d639aee6e46d35d75/text/2000-const-generics.md">Constant generic</a> hopefully will come soon).</p>
<p>Ok! let‚Äôs dig in to it. <code>Vec&lt;T&gt;</code> contains<strong>(pointer, capacity, length)</strong>.</p>
<section id="vec-pointer" class="level3">
<h3 class="anchored" data-anchor-id="vec-pointer">Vec pointer</h3>
<ol type="1">
<li>The pointer will<strong>never be null</strong>, so it enjoys<em>null-pointer-optimization</em>.</li>
<li>The pointer may<em>not</em>actually point to allocated memory for example in<code>Vec::new(), vec![]</code> or <code>Vec::with_capacity(0)</code>.</li>
</ol>
</section>
<section id="vec-capacity-and-length" class="level3">
<h3 class="anchored" data-anchor-id="vec-capacity-and-length">Vec capacity and length</h3>
<ol type="1">
<li>The capacity of a vector is the amount of space allocated for any future elements that will be added onto the vector.</li>
<li>The length is the number of actual elements pushed/inserted in the vector.</li>
<li><code>Vec</code> allocates memory iff <code>mem::size_of::&lt;T&gt;() * capacity() &gt; 0</code>. So it does<em>not</em>allocate for a Zero-Sized-Type (ZST) even with positive capacity.</li>
<li>When length matches the capacity, <code>Vec</code> will (re)allocate by a certain growth factor. This makes insertion<em>amortized</em><img src="https://latex.codecogs.com/png.latex?O(1)">. Right now <a href="https://github.com/rust-lang/rust/blob/9d71ec1358ac063fe6ff1eaed0ba6ed3cedde610/src/liballoc/raw_vec.rs#L306">the growth factor is 2.</a> However, comparing to other languages such as C++, Java, etc. it doesn‚Äôt seem to be optimal given any global first-fit allocator. Heuristically,<strong><a href="https://groups.google.com/forum/#!topic/comp.lang.c++.moderated/asH_VojWKJw%5B1-25%5D">1.5</a></strong><a href="https://groups.google.com/forum/#!topic/comp.lang.c++.moderated/asH_VojWKJw%5B1-25%5D">or a number a bit less than golden ratio is considered optimal</a>. Here‚Äôs the related <a href="https://github.com/rust-lang/rust/issues/29931">issue</a> that‚Äôs currently open. I found it interesting to dig in!</li>
<li>How about shrink factor? for example, if we <code>pop</code> half of the elements out, would a quarter of the memory be freed? No, actually! That‚Äôs if <code>pop</code>ing all the elements the <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=e6476ebbff5227a8fde13b1a95060ef7">capacity won‚Äôt change</a> leaving a hole on the heap. Therefore, <code>pop</code> (from back) is <img src="https://latex.codecogs.com/png.latex?O(1)"> and<strong>not</strong>amortized <img src="https://latex.codecogs.com/png.latex?O(1)."> If you need to free up some memory, use <code>shrink_to_fit</code>.</li>
<li>If need to use <code>Vec</code> for FFI or as a memory-backed collection, be sure to deallocate memory with <a href="https://doc.rust-lang.org/std/vec/struct.Vec.html#method.from_raw_parts"><code>from_raw_parts</code></a> and then drop explicitly.</li>
<li>If used in FFI and need to pass as pointer, for safety remember to call <code>shrink_to_fit</code> or <a href="https://doc.rust-lang.org/std/vec/struct.Vec.html#method.truncate"><code>truncate</code></a> by the length prior to passing the (<code>as_mut_ptr()</code> or <code>as_ptr()</code>) to not pass uninitialized memory buffer.</li>
<li>The order of elements is always guaranteed to be the same if <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=c74b629607742799e7088be046e213a1">coerced into slice</a>.</li>
</ol>
<p>Here‚Äôs the stripped down definition</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode rust code-with-copy"><code class="sourceCode rust"><span id="cb1-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">struct</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Vec</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-2">    buf<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> RawVec<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;,</span></span>
<span id="cb1-3">    len<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">usize</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-4"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-5"></span>
<span id="cb1-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Default Global allocator</span></span>
<span id="cb1-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">struct</span> RawVec<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Alloc</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Global<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-8">    ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> Unique<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;,</span></span>
<span id="cb1-9">    cap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">usize</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-10">    a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-11"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-12"></span>
<span id="cb1-13"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">#[</span>repr<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">(</span>transparent<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">)]</span></span>
<span id="cb1-14"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">struct</span> Unique<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Sized</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-15">    pointer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">const</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-16">    _marker<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> PhantomData<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;,</span></span>
<span id="cb1-17"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></div>
</section>
<section id="unique" class="level3">
<h3 class="anchored" data-anchor-id="unique">Unique<t></t></h3>
<ol type="1">
<li><a href="https://github.com/rust-lang/rfcs/blob/master/text/1758-repr-transparent.md">#[repr(transparent)]</a> enforces that <code>Unique&lt;T&gt;</code>type representation is the same as <code>*const T</code>.</li>
<li><code>Unique&lt;T&gt;</code> is the <a href="https://github.com/ehsanmok/van-rust-meetup/blob/master/type_system/subtyping.md">covariant</a> version of <code>*mut T</code> (wrt <code>T</code>) and has<em>stronger</em>semantic than <code>NonNull&lt;T&gt;</code>.</li>
<li>Unlike <code>*mut T</code>, the pointer must<strong>always be non-null</strong>.</li>
<li>In fact, <code>Box&lt;T&gt;</code> wraps <code>Unique&lt;T&gt;</code> i.e.&nbsp;<code>struct Box&lt;T: ?Sized&gt;(Unique&lt;T&gt;)</code>.</li>
<li>It can be accessed in nightly through <code>#![feature(ptr_internals)]</code> and <code>core::ptr::Unique</code>.</li>
<li>If <code>T</code>is <code>Send/Sync</code> then <code>Unique&lt;T&gt;</code> is <code>Send/Sync</code>.</li>
<li>The presence of <code>PhantomData&lt;T&gt;</code> marker is only important for<em><a href="https://github.com/rust-lang/rust/blob/master/src/librustc_typeck/check/dropck.rs">rustc dropck</a></em>to understand that we logically own a <code>T</code> causing the main difference between <code>Unique&lt;T&gt;</code> and <code>NonNull&lt;T&gt;</code> where it‚Äôs defined as</li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode rust code-with-copy"><code class="sourceCode rust"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// NonNull&lt;T&gt; doesn't own the referent whereas Unique&lt;T&gt; does</span></span>
<span id="cb2-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">#[</span>repr<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">(</span>transparent<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">)]</span></span>
<span id="cb2-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">struct</span> NonNull<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Sized</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-4">    pointer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">const</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-5"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></div>


</section>
</section>

 ]]></description>
  <category>Rust</category>
  <guid>https://ehsanmkermani.com/posts/2019-03-10-rust-std-study-series-vec/</guid>
  <pubDate>Sun, 10 Mar 2019 00:00:00 GMT</pubDate>
</item>
<item>
  <title>NIPS, AI hype and the lost rigor</title>
  <dc:creator>Ehsan M. Kermani</dc:creator>
  <link>https://ehsanmkermani.com/posts/2017-12-06-nips-ai-hype-and-the-lost-rigor/</link>
  <description><![CDATA[ 





<p><em>Warning: This post contains a mixture of excitements, frustrations and rants!</em></p>
<p>Today, Machine Learning/Deep Learning people have been sharing their great excitements over <a href="https://www.facebook.com/NIPSlive/videos/1490306974358477/">Ali Rahimi‚Äôs talk at NIPS</a> (from min 57 onwards). Undoubtedly, it‚Äôs a great talk and you should check it out if you care about fundamental issues and the lost rigor in Deep Learning results. His talk has resonated a lot with me as well and for more reasons that I‚Äôll try to explain in my own way while these tweets sum up the hype part well <img src="https://ehsanmkermani.com/posts/2017-12-06-nips-ai-hype-and-the-lost-rigor/images/hype21.png" class="img-fluid" alt="hype2"> &nbsp; <img src="https://ehsanmkermani.com/posts/2017-12-06-nips-ai-hype-and-the-lost-rigor/images/ai-hype1.png" class="img-fluid" alt="ai-hype"> <img src="https://ehsanmkermani.com/posts/2017-12-06-nips-ai-hype-and-the-lost-rigor/images/nips.png" class="img-fluid" alt="nips"> &nbsp; While there‚Äôs no doubt <a href="https://blogs.scientificamerican.com/observations/falling-walls-the-past-present-and-future-of-artificial-intelligence/">Deep Learning has been an incredible enabler</a> but<strong>AI hype is real</strong>and you can feel its bittersweet taste. It is too naive to think that at this stage Deep Learning will bring us<em>Artificial General Intelligence</em>and portraying ML/DL like in terminator movie coming to extinct the human race is irresponsible and idiotic. At this stage Deep Learning is like a bundle of techniques and since it is led by (empirical part of) Computer Science community, ‚Äúworking code‚Äù and seeing the empirical results is somehow<em>the</em> <em>proof</em>. Moreover, apparently in order to get into ML/DL, you‚Äôd only need to know calculus and coding to<em>be the revolution</em>and<em>change the world</em>!&nbsp;¬Ø\__(„ÉÑ)__/¬Ø M<em>y<strong>pessimistic side</strong></em>is saying what is happening now is that Deep Learning is growing exponentially fast with big army of enthusiasts ready to code up something quickly, generate results, publish papers and attract many attentions. These results somehow contribute to building systems for health care for example, which is sensitive enough and we cannot give more power to Deep Learning until there‚Äôs a solid,<em>real</em>foundation. One such example of these serious issues is reflected in this tweet &nbsp; <img src="https://ehsanmkermani.com/posts/2017-12-06-nips-ai-hype-and-the-lost-rigor/images/ml-worry-tweet1.png" class="img-fluid" alt="ml-worry-tweet"> &nbsp; What is baffling to me is there are many faculties who seem happy about this situation and are not addressing the real problems and are somehow becoming the enemy of science. Their ignorance is mind blowing! My<strong>optimistic side</strong>is pointing me towards&nbsp;the efforts and initiatives for addressing these issues. &nbsp;Some examples include introduction of <a href="https://colab.research.google.com">google‚Äôs colaboratory project</a>&nbsp;and now<em>reproducibility</em>of results are much easier than ever before. Well-known <a href="https://distill.pub/">distill.pub</a> initiative aims at clearing up the air of current DL research. <a href="http://dawn.cs.stanford.edu/2017/11/29/dawnbench-intro/">Stanford DAWNbench competition</a>. From research sides,<em>Bayesian Neural Networks</em>is getting more attention and abundant of probabilistic programming frameworks such as <a href="http://docs.pymc.io/">PyMC3</a>, <a href="http://edwardlib.org/">Edward</a>, <a href="http://zhusuan.readthedocs.io/en/latest/">ZhuSuan</a>, <a href="https://eng.uber.com/pyro/">Pyro</a> and <a href="https://github.com/probtorch/probtorch">ProbTorch</a> help a lot. <a href="https://www.youtube.com/watch?v=bLqJHjXihK8">Information theory of DL talk by Naftali Tishby</a> at Yandex school is addressing some of the fundamental issues. Hinton‚Äôs talk on <a href="https://www.youtube.com/watch?v=rTawFwUvnLE">what‚Äôs wrong with convolutional neural nets</a>&nbsp;which led to the very recent <a href="https://arxiv.org/abs/1710.09829">Capsule paper</a>. Moreover, his another recent paper on&nbsp;<a href="https://arxiv.org/pdf/1711.09784.pdf">Distilling a Neural Network into a Soft Decision Tree</a>. To finish off, I think another important part is the realm of optimization algorithms more towards <a href="https://arxiv.org/abs/1312.6055">Unit Tests for Stochastic Optimization</a>&nbsp;type of research.</p>



 ]]></description>
  <category>Deep Learning</category>
  <category>Machine Learning</category>
  <guid>https://ehsanmkermani.com/posts/2017-12-06-nips-ai-hype-and-the-lost-rigor/</guid>
  <pubDate>Wed, 06 Dec 2017 00:00:00 GMT</pubDate>
</item>
<item>
  <title>What‚Äôs up with word embedding?</title>
  <dc:creator>Ehsan M. Kermani</dc:creator>
  <link>https://ehsanmkermani.com/posts/2017-07-12-whats-up-with-word-embedding/</link>
  <description><![CDATA[ 





<p>Word embedding is one of the interesting areas of research in Natural Language Processing. There are huge amount of materials with a lot of interesting ideas. I have been studying some of them lately and in this post, I‚Äôd like to create a<em>brief account</em>of the ideas I have found most interesting so far.</p>
<section id="word2vec-yet-another-explanation" class="level2">
<h2 class="anchored" data-anchor-id="word2vec-yet-another-explanation">Word2Vec (Yet another explanation)</h2>
<p><img src="https://ehsanmkermani.com/posts/2017-07-12-whats-up-with-word-embedding/images/youtho.jpg" class="img-fluid" alt="youtho"> Let‚Äôs start with the intuitive&nbsp;<a href="https://en.wikipedia.org/wiki/Distributional_semantics#Distributional_hypothesis">distributional hypothesis</a> &gt; A<em>word is characterized by the company it keeps</em>or<em>linguistic items with similar distributions have similar meanings.</em>In other words, we expect to see words used in similar<em>contexts</em>have similar<em>meaning (semantic relations)</em>. The goal is to build a mathematical model such that given a&nbsp;word (token)&nbsp;<img src="https://latex.codecogs.com/png.latex?w,"> we can assign real-valued vector <img src="https://latex.codecogs.com/png.latex?v%5C_w"> (in some space), so that interesting properties of words such as semantic relations, are preserved&nbsp; for example, by using their inner product or&nbsp;<a href="https://en.wikipedia.org/wiki/Cosine_similarity">cosine similarity</a>&nbsp;of vectors as metric. <a href="https://arxiv.org/abs/1301.3781">Mikolov et. al.</a> constructed such vector representations of words from natural language text that preserve semantic relations via simple quantities of vectors such as their<em>inner product</em>. Their<em>set of models</em>is called Word2Vec. Intuitively, there are two basic ideas; for a series of words (tokens) <img src="https://latex.codecogs.com/png.latex?w%5C_1,%20w%5C_2,%20%5Ccdots,%20w%5C_T"> in a corpus/<em>Text</em>data, and a choice of<em>context</em><img src="https://latex.codecogs.com/png.latex?C"> i.e.&nbsp;a<em>window (set)</em>of words, either find the probability of some word <img src="https://latex.codecogs.com/png.latex?w%5C_i"> given the some word in the context <img src="https://latex.codecogs.com/png.latex?c%20%5Cin%20C"> that is, <img src="https://latex.codecogs.com/png.latex?p(w%5C_i%20%7C%20c)"><em>or</em>find the probability of observing a context given a word <img src="https://latex.codecogs.com/png.latex?w%5C_i,"> that is, <img src="https://latex.codecogs.com/png.latex?p(c%7Cw%5C_i)."> The first model is called Continuous Bag of Words (CBOW) and the second model is called SkipGram. (If you‚Äôve never heard of these terms before, I suggest reading <a href="https://web.stanford.edu/class/cs224n/lecture_notes/cs224n-2017-notes1.pdf">this note</a>.) One of well-known tasks that Word2Vec performed well is the analogy task. Word2Vec captures the following type of relations between words: Formally, let <img src="https://latex.codecogs.com/png.latex?v%5C_%7B%5Ctext%7Bw%7D%7D"> be a vector representation (embedding) of a word <img src="https://latex.codecogs.com/png.latex?w"> in some Euclidean vector space. Then</p>
<p>&nbsp;<img src="https://latex.codecogs.com/png.latex?v%5C_%7B%5Ctext%7Bman%7D%7D%20-%C2%A0v%5C_%7B%5Ctext%7Bwoman%7D%7D%20%5Csimeq%20v%5C_%7B%5Ctext%7Bking%7D%7D%20-%C2%A0v%5C_%7B%5Ctext%7Bqueen%7D%7D"></p>
<p>and one such similarity measure <img src="https://latex.codecogs.com/png.latex?%5Csimeq"> can be&nbsp;<a href="https://en.wikipedia.org/wiki/Cosine_similarity">cosine similarity</a>&nbsp;of vectors, for example.</p>
</section>
<section id="skipgram-model" class="level2">
<h2 class="anchored" data-anchor-id="skipgram-model">SkipGram model</h2>
<p>Given the notations above and the conditional probabilities <img src="https://latex.codecogs.com/png.latex?p(c%7Cw),"> the goal is to find some parameters <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> of the parametrized <img src="https://latex.codecogs.com/png.latex?p(c%7Cw;%20%5Ctheta)"> in order to maximize the corpus probability, i.e.</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Ctext%7Bargmax%7D%5C_%7B%5Ctheta%7D%20%5Cprod%5C_%7Bw%20%5Cin%20W%7D%20%5Cleft(%5Cprod%5C_%7Bc%20%5Cin%20C(w)%7D%20p(c%20%7C%20w;%20%5Ctheta)%20%5Cright)%20%5C;%5C;%5C;%5C;%20(%5Cstar)"></p>
<p>There is an independent assumption (reflected in $_{c C(w)} p(c | w; ) $) that given a word then observing different words in a context are independent from each other and those events for each word themselves are independent (reflected in the outer <img src="https://latex.codecogs.com/png.latex?%5Cprod%5C_%7Bw%20%5Cin%20%5Ctext%7BW%7D%7D">). Note also that contexts are words and SkipGram models each context given a word<em>independently</em>. One approach to model the conditional probabilities <img src="https://latex.codecogs.com/png.latex?p(c%20%7C%20w;%20%5Ctheta)"> so as to connect the word-vector representation idea, is via softmax function</p>
<p><img src="https://latex.codecogs.com/png.latex?p(c%20%7C%20w;%20%5Ctheta)%20=%20%5Cdfrac%7B%5Cexp(%5Clangle%20v%5C_c,%20v%5C_w%20%5Crangle)%7D%7B%5Csum%5C_%7Bc'%20%5Cin%20C(w)%7D%5Cexp(%5Clangle%20v%5C_c',%20v%5C_w%20%5Crangle)%7D%20%5C;%5C;%5C;%5C;%20(%5Cstar%20%5Cstar)"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?v%5C_c,%20v%5C_w"> are the desired vector representations for <img src="https://latex.codecogs.com/png.latex?c,%20w,"> and <img src="https://latex.codecogs.com/png.latex?%5Clangle%20v%5C_c,%20v%5C_w%20%5Crangle"> is the (Euclidean) inner product. Note that <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> is the set of all <img src="https://latex.codecogs.com/png.latex?v%5C_w,%20v%5C_c"> for all <img src="https://latex.codecogs.com/png.latex?w%20%5Cin%20W"> and <img src="https://latex.codecogs.com/png.latex?c%20%5Cin%20C,"> so there are <img src="https://latex.codecogs.com/png.latex?%7CW%7C%20%5Ctimes%20%7CC%7C%20%5Ctimes%20d"> number of parameters where <img src="https://latex.codecogs.com/png.latex?d"> is the embedding dimension. This representation can be considered as a shallow neural network with softmax output. To address some of the difficulties on the training such as finding the denominator in the softmax there‚Äôre two proposed solutions; 1)<em>hierarchical softmax</em>2)<em>negative sampling</em>. &nbsp;In practice negative sampling is more favorable. To get to know more I recommend reading <a href="https://arxiv.org/abs/1402.3722">Word2Vec explained</a> paper and more expanded version in <a href="https://arxiv.org/abs/1411.2738">Word2Vec parameter learning explained</a>.</p>
<section id="point-wise-mutual-information-matrix-pmi" class="level3">
<h3 class="anchored" data-anchor-id="point-wise-mutual-information-matrix-pmi">Point-wise mutual information matrix (PMI)</h3>
<p>Recall that if two random outcomes <img src="https://latex.codecogs.com/png.latex?x,%20y"> are independent, then <img src="https://latex.codecogs.com/png.latex?p(x,y)%20=%20p(x)%20p(y)."> That is, their join distribution factorizes into their individual distributions. To have a general measure of this phenomenon, given any two (not necessarily independent) random outcomes, we can define their Point-wise Mutual Information as <img src="https://latex.codecogs.com/png.latex?%5Ctext%7Bpmi%7D(x,%20y)%20=%20%5Clog%20%5Cleft(%5Cdfrac%7Bp(x,y)%7D%7Bp(x)p(y)%7D%20%5Cright)."> In case of word-context pairs, we can define the PMI matrix whose entries are <img src="https://latex.codecogs.com/png.latex?%5Ctext%7Bpmi%7D(w,%20c)"> which is <img src="https://latex.codecogs.com/png.latex?%7CW%7C%20%5Ctimes%20%7CC%7C"> matrix.</p>
<p>One can use Singular Value Decomposition on the PMI matrix to get lower dimensional representations of words. Let <img src="https://latex.codecogs.com/png.latex?U%20%5CSigma%20V%5ET"> be the SVD of the PMI matrix, then for example, the symmetric factorization <img src="https://latex.codecogs.com/png.latex?W%20=%20U%20%5CSigma%5E%7B%5Cfrac%2012%7D"> and <img src="https://latex.codecogs.com/png.latex?C%20=%20V%20%5CSigma%5E%7B%5Cfrac%2012%7D"> provide word and context representations, respectively. However, SVD provides the best rank <img src="https://latex.codecogs.com/png.latex?d"> approximation wrt <img src="https://latex.codecogs.com/png.latex?L%5C_2"> matrix norm, and in practice, this is not enough!</p>
<blockquote class="blockquote">
<p><em>What‚Äôs the relation between SkipGram and PMI?</em>### SkipGram with negative sampling (SGNS) vs.&nbsp;PMI</p>
</blockquote>
<p><a href="https://papers.nips.cc/paper/5477-neural-word-embedding-as-implicit-matrix-factorization.pdf">Levy-Goldberg</a>&nbsp;showed that if you take the word embedding <img src="https://latex.codecogs.com/png.latex?W"> and the context embedding <img src="https://latex.codecogs.com/png.latex?C"> obtained in SGNS, then <img src="https://latex.codecogs.com/png.latex?WC%5ET"> is in fact, a factorization of (shifted)&nbsp;<a href="https://en.wikipedia.org/wiki/Pointwise_mutual_information">PMI</a> matrix. In other words, <img src="https://latex.codecogs.com/png.latex?%5Clangle%20v%5C_w,%20v%5C_c%20%5Crangle%20%C2%A0%5Csimeq%20%5Ctext%7BPMI%7D(w,%20c)%20-%20%5Clog%20k"> where <img src="https://latex.codecogs.com/png.latex?k"> is the number of negative samples. This result bridges the neural network method with the traditional <a href="https://arxiv.org/pdf/1003.1141.pdf">vector space model of semantics</a>. Another important advantage is that<strong>PMI approach suffers from scalability but SGNS is very scalable, indeed.</strong>### Variants of SGNS</p>
<section id="i-nce" class="level4">
<h4 class="anchored" data-anchor-id="i-nce">i) NCE:</h4>
<p><a href="http://papers.nips.cc/paper/5165-learning-word-embeddings-efficiently-with-noise-contrastive-estimation.pdf">Minh et. al</a>&nbsp;used noise contrastive estimation (NCE) to model the probability of a word-context coming from correct sample vs.&nbsp;incorrect one. Levy-Goldberg also showed that this approach is equivalent to factorizing the word-context matrix whose entries are shifted <img src="https://latex.codecogs.com/png.latex?%5Clog%20p(w%7Cc)."></p>
</section>
<section id="ii-glove" class="level4">
<h4 class="anchored" data-anchor-id="ii-glove">ii) GloVe:</h4>
<p>Another approach is described in&nbsp;<a href="https://nlp.stanford.edu/pubs/glove.pdf">GloVe: Global vectors for word representations</a>. &nbsp;The idea is to related<em>inner product</em>of desired vectors to the<em>ratio</em>of the context-word conditional probabilities. The optimization function that is</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Csum%5C_%7Bi,j%7D%20f(X%5C_%7Bij%7D)%20(v%5C_%7Bw%5C_i%7D%5ET%20v%5C_%7Bc%5C_j%7D%20-%20%5Clog%20X%5C_%7Bij%7D%20+%20b%5C_%7Bw%7D%20+%20b%5C_c)"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?X%5C_%7Bij%7D"> is the element <img src="https://latex.codecogs.com/png.latex?(i,%20j)"> of the matrix of word-word co-occurence count <img src="https://latex.codecogs.com/png.latex?X,"> <img src="https://latex.codecogs.com/png.latex?b%5C_w,%20b%5C_c"> are biases and <img src="https://latex.codecogs.com/png.latex?f"> is some function (found empirically) with some desired properties. Despite GloVe gives more parameters to the model,<strong>its performance is quite<em>similar</em>to SGNS</strong>. In fact, by fixing the biases to be the logarithm of word and context counts, GloVe also factorizes a shifted version of PMI matrix.</p>
</section>
</section>
<section id="sgns-as-weighted-logistic-pca-and-its-generalization" class="level3">
<h3 class="anchored" data-anchor-id="sgns-as-weighted-logistic-pca-and-its-generalization">SGNS as weighted logistic PCA and its generalization</h3>
<p>Levy-Goldberg have also provided a much more clear description of the SGNS model, which briefly goes like this: After taking <img src="https://latex.codecogs.com/png.latex?%5Clog"> from <img src="https://latex.codecogs.com/png.latex?(%5Cstar)"> and using the softmax <img src="https://latex.codecogs.com/png.latex?(%5Cstar%20%5Cstar)"> it &nbsp;becomes equivalent to</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Ctext%7Bargmax%7D%5C_%7B%5Ctheta%7D%20%5Csum%5C_%7B(w,%20c)%20%5Cin%20D%7D%20%5Clog%20p(c%20%7C%20w;%20%5Ctheta)%20=%20%5Csum%5C_%7B(w,%20c)%20%5Cin%20D%7D%20(v%5C_c%5ET%20v%5C_w%20-%20%5Clog%20%5Csum%5C_%7Bc'%7D%20%5Cexp(v%5C_%7Bc'%7D%5ETv%5C_w))"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?D"> is the set of all word-context pairs from <img src="https://latex.codecogs.com/png.latex?%5Ctext%7BText%7D."> The role of Negative Sampling is to approximation the softmax log of probabilities. Basically, to approximate the above objective, we change it to a classification task of <img src="https://latex.codecogs.com/png.latex?p(D=1%7Cw,c)%20=%20%5Cdfrac%7B1%7D%7B1%20+%20%5Cexp(v%5C_c%5ETv%5C_w)%7D,"> which is given a word-context <img src="https://latex.codecogs.com/png.latex?(w,%20c)"> whether it is coming from our <img src="https://latex.codecogs.com/png.latex?%5Ctext%7BText%7D"> or not <img src="https://latex.codecogs.com/png.latex?p(D=0%20%7C%20w,c)."> So we need to gather some noise word-contexts <img src="https://latex.codecogs.com/png.latex?D'">. Mikolov et. al, did it by randomly sampling from<em>smoothed</em>unigram distribution (i.e.&nbsp;to power <img src="https://latex.codecogs.com/png.latex?0.75">), <img src="https://latex.codecogs.com/png.latex?k"> context noises <img src="https://latex.codecogs.com/png.latex?c%5C_%7B%5Ctext%7BNoise%7D%7D"> (in short <img src="https://latex.codecogs.com/png.latex?c%5C_N">) for each word <img src="https://latex.codecogs.com/png.latex?w."> Note that without negative samples, the above objective can be maximized<em>when all word and context vectors become equal &nbsp;<img src="https://latex.codecogs.com/png.latex?v%5C_w%20=%20v%5C_c"> with big enough inner product</em>. Therefore, with negative sampling, the approximation goes like this;</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Ctext%7Bargmax%7D%5C_%7B%5Ctheta%7D%20%5Cprod%5C_%7B(w,%20c)%20%5Cin%20D%7D%20p(D=1%7Cc,w;%5Ctheta)%5Cprod%5C_%7B(w,%20c)%20%5Cin%20D'%7D%20p(D=0%7Cc,w%20;%20%5Ctheta)"></p>
<p>After some standard simplifications (see <a href="https://arxiv.org/abs/1402.3722">Word2Vec Explained</a>), &nbsp;the above objective becomes</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Ctext%7Bargmax%7D%5C_%7B%5Ctheta%7D%20%5Csum%5C_%7B(w,c)%20%5Cin%20D%7D%20%5Clog%20%5Csigma(v%5C_c%5ETv%5C_w)%20+%20%5Csum%5C_%7B(w,%20c)%20%5Cin%20D'%7D%20%5Clog%20%5Csigma%20(-v%5C_c%5ETv%5C_w)%20%5C;%5C;%5C;%5C;%20(%5Cstar%20%5Cstar%20%5Cstar)"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?%5Csigma"> is the Sigmoid function. In the presence of negative samples <img src="https://latex.codecogs.com/png.latex?c%5C_N">, for each <img src="https://latex.codecogs.com/png.latex?(w,%20c)%20%5Cin%20D,"> we are computing</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Clog%20%5Csigma(v%5C_c%5ETv%5C_w)%20+%20%5Csum%5C_%7B(w,%20c)%20%5Cin%20D'%7D%20%5Clog%20%5Csigma%20(-v%5C_c%5ETv%5C_w)%20=%5Clog%20%5Csigma(v%5C_c%5ETv%5C_w)%20+%20k%20%5Cmathbb%7BE%7D%5C_%7Bc%5C_N%7D%20%5B%5Clog%20%5Csigma%20(-v%5C_c%5ETv%5C_w)%5D"></p>
<p>For a given <img src="https://latex.codecogs.com/png.latex?(w,%20c)"> let <img src="https://latex.codecogs.com/png.latex?n%5C_%7Bw,c%7D"> be the number of times they appear in <img src="https://latex.codecogs.com/png.latex?D."> (this about <img src="https://latex.codecogs.com/png.latex?D"> like matrix, <img src="https://latex.codecogs.com/png.latex?n%5C_%7Bw,c%7D"> is the entry in row <img src="https://latex.codecogs.com/png.latex?w"> and column <img src="https://latex.codecogs.com/png.latex?c">). So the SGNS objective (equation <img src="https://latex.codecogs.com/png.latex?(%5Cstar%20%5Cstar%20%5Cstar)">) summed with multiplicities becomes</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Csum%5C_%7B(w,%20c)%7D%20n%5C_%7Bw,%20c%7D%20(%5Clog%20%5Csigma(v%5C_c%5ETv%5C_w)%20+%20k%20%5Cmathbb%7BE%7D%5C_%7Bc%5C_N%7D%20%5B%5Clog%20%5Csigma%20(-v%5C_c%5ETv%5C_w)%5D)"></p>
<p><a href="https://arxiv.org/abs/1705.09755">Landgrad-Bellay</a>&nbsp;has recently provided another interpretation of the above SGNS objective and they showed that it is equivalent to the<em>weighted logistic</em>PCA. The generalization of this fact is captured through <a href="https://www.cs.jhu.edu/~jason/papers/cotterell+al.eacl17.pdf">exponential family PCA</a>.</p>
</section>
</section>
<section id="enriching-the-word-embedding" class="level2">
<h2 class="anchored" data-anchor-id="enriching-the-word-embedding">Enriching the word embedding</h2>
<p>Another interesting idea is to do with the recent work of&nbsp;<a href="https://arxiv.org/pdf/1704.01938.pdf">Avraham-Goldberg</a>&nbsp;to include morphological information of words with Part of Speech (POS) tagging with preprocessing of the text and consider the<em>pair</em><img src="https://latex.codecogs.com/png.latex?(w,%20%5Ctext%7BPOS%7D)"> instead of the word <img src="https://latex.codecogs.com/png.latex?w"> alone. The result is having different vector representations for cases like <img src="https://latex.codecogs.com/png.latex?%5Ctext%7Bplant%7D%5C_%7B%5Ctext%7BNOUN%7D%7D"> and&nbsp;<img src="https://latex.codecogs.com/png.latex?%5Ctext%7Bplant%7D%5C_%7B%5Ctext%7BVERB%7D%7D."></p>
</section>
<section id="geometry-of-the-word-embedding" class="level2">
<h2 class="anchored" data-anchor-id="geometry-of-the-word-embedding">Geometry of the word embedding</h2>
<p>To understand geometric structures of data, one can look into <a href="https://en.wikipedia.org/wiki/Topological_data_analysis">Topological Data Analysis</a>&nbsp;and its methods such as <a href="https://en.wikipedia.org/wiki/Persistent_homology">Persistent Homology</a>. <a href="http://pages.cs.wisc.edu/~jerryzhu/pub/homology.pdf">Zhu</a>&nbsp;has an introduction of such approach for Natural Language Processing. In basic algebraic topology (with enough assumption), the dimension of zeroth homology group (zeroth Betti number) of a topological space is the number of connected components and its first Betti number counts the number of holes. Given some data points, the idea of persistent homology is to<em>track homological classes along increasing neighborhoods of (simplicial complexes) data points</em>. Recently <a href="https://arxiv.org/abs/1705.10900">Michel et. al</a>&nbsp;using persistent homological approach concluded that such method doesn‚Äôt have positive impact on document classification and clustering tasks. They have used Gromov-Haussdorff distance (which is insensitive to isometries) and defined two documents have the same ‚Äúgeometry‚Äù if their GH distance if zero. However, it could be argued that this definition of ‚Äúgeometry‚Äù is very limiting and doesn‚Äôt capture all existing structures in document data!</p>
</section>
<section id="generalization-to-graph-and-manifold-embedding" class="level2">
<h2 class="anchored" data-anchor-id="generalization-to-graph-and-manifold-embedding">Generalization to graph and manifold embedding</h2>
<p>Arora et. al.&nbsp;in their work, <a href="https://arxiv.org/abs/1502.03520">RAND-WALK: A latent variable model approach to word embeddings</a>&nbsp;with generative modelling approach, provided more justifications for relations between PMI, Word2Vec and GloVe. <a href="https://arxiv.org/abs/1509.05808">Hashimoto-Alvarez-Melis</a>&nbsp;considered the task of word embedding as<em>metric recovery</em>. That is, given a word embedding <img src="https://latex.codecogs.com/png.latex?v%5C_%7Bw%5C_1%7D,%20%5Ccdots,%20v%5C_%7Bw%5C_m%7D"> over a document with <img src="https://latex.codecogs.com/png.latex?s"> sentences with total number <img src="https://latex.codecogs.com/png.latex?m"> words and <img src="https://latex.codecogs.com/png.latex?n"> vocabulary (unique words), one can view <img src="https://latex.codecogs.com/png.latex?p(c%5C_j%7Cw%5C_i)"> (where context is a word as well and there‚Äôs no separate context embedding vectors, such as SGNS throwing away the context vectors) as a Markov (Gaussian) random walk <img src="https://latex.codecogs.com/png.latex?X%5C_1,%20%5Ccdots,%20X%5C_m"> with transition function</p>
<p><img src="https://latex.codecogs.com/png.latex?p(X%5C_t%20=%20v%5C_%7Bw%5C_j%7D%20%7C%20X%5C_%7Bt-1%7D=v%5C_%7Bw%5C_i%7D)%20=%20%5Cdfrac%7B%5Cexp(-%20%5C%7Cv%5C_%7Bw%5C_i%7D%20-%20v%5C_%7Bw%5C_j%7D%20%5C%7C%5C_2%5E2)%7D%7B%5Csum%5C_%7Bk=1%7D%5En%20%5Cexp(-%20%5C%7Cv%5C_%7Bw%5C_i%7D%20-%20v%5C_%7Bw%5C_k%7D%20%5C%7C%5C_2%5E2)%7D"></p>
<p>then there exists a sequence <img src="https://latex.codecogs.com/png.latex?a%5C_i%5Em,%20b%5C_j%5Em"> such that in probability, as <img src="https://latex.codecogs.com/png.latex?m%20%5Cto%20%5Cinfty,"></p>
<p><img src="https://latex.codecogs.com/png.latex?-%5Clog(C%5C_%7Bij%7D)%20-%20a%5C_i%5Em%20%5Cstackrel%7Bp%7D%7B%5Clongrightarrow%7D%20%5C%7Cv%5C_%7Bw%5C_i%7D%20-%20v%5C_%7Bw%5C_j%7D%20%5C%7C%5C_2%5E2%20+%20b%5C_j%5Em"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?C%20=%20%5BC%5C_%7Bij%7D%5D"> is the co-occurence matrix over our document. (matrix version of earlier <img src="https://latex.codecogs.com/png.latex?D"> with contexts as words). This described<strong>log-linear relation between co-occurences and distance.</strong>The metric recovery holds in more general setting for random walk over<em>unweighted directed graphs and data manifold.</em>Intuitively,</p>
<p><img src="https://latex.codecogs.com/png.latex?-%5Clog(%5Ctext%7Bco-occurence%7D)%20%5Cstackrel%7B%5Ctext%7Bconverges%7D%7D%7B%5Clongrightarrow%7D%20%5Ctext%7Bgeodesic%7D(v%5C_%7Bw%5C_i%7D,%20v%5C_%7Bw%5C_j%7D)%5E2"></p>
<p>for some meaning of convergence and distance/geodesic.</p>
</section>
<section id="hyperbolic-embedding" class="level2">
<h2 class="anchored" data-anchor-id="hyperbolic-embedding">Hyperbolic embedding</h2>
<p>We can view words as symbolic data and try to represent their relations with graphs. To learn a representation of symbolic data with hierarchical relations (with existence of power-law distribution), one well-known approach is embedding the data in a<strong>non-Euclidean space</strong>, such as <img src="https://latex.codecogs.com/png.latex?d">-dimensional<em>Poincar√© ball</em><img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BB%7D%5Ed%20=%20%5C%7Bx%20%5Cin%20%5Cmathbb%7BR%7D%5Ed%20%7C%20%5C%7Cx%5C%7C%5C_2%20%3C%201%5C%7D"> (or complex upper half-plane <img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BH%7D">) which is the Euclidean <img src="https://latex.codecogs.com/png.latex?d"> dimensional ball equipped with (non-Euclidean) Riemannian metric. In two closely published papers <a href="https://arxiv.org/abs/1705.10359">Chamberlain et. al</a> studied hyperbolic embedding for <img src="https://latex.codecogs.com/png.latex?2">-dimensional Poincar√© ball and <a href="https://arxiv.org/abs/1705.08039">Nickel-Kiela</a> for a general <img src="https://latex.codecogs.com/png.latex?d">-dimensional Poincar√© ball. They examined such embeddings for different types of symbolic data such as text and network graphs and showed improvements as well as the ability of capturing more information in lower dimension because hyperbolic spaces are richer than flat Euclidean spaces.</p>
</section>
<section id="encode-decoder" class="level2">
<h2 class="anchored" data-anchor-id="encode-decoder">Encode-Decoder</h2>
<p>Another line of ideas is related to encode-decoder (seq2seq) approach where either encoder or decoder can be any of Convolutional NN or Recurrent NN such as LSTM or GRU. The basic idea is to encode a sequence of data (sentences) and try to reconstruct them back with decoder. In the meantime, compact representations are constructed. One such successful approach has been introduced by Kiros et. al.&nbsp;in their <a href="https://arxiv.org/abs/1506.06726">Skip-Thought Vectors</a>&nbsp;with GRU as encoder and decoder. Given a tuple of sentences <img src="https://latex.codecogs.com/png.latex?(s%5C_%7Bi-1%7D,%20s%5C_i,%20s%5C_%7Bi+1%7D),"> let <img src="https://latex.codecogs.com/png.latex?w%5C_i%5Et"> be the <img src="https://latex.codecogs.com/png.latex?t">-th word for sentence <img src="https://latex.codecogs.com/png.latex?s%5C_i"> and let <img src="https://latex.codecogs.com/png.latex?v%5C_%7Bw%5C_i%5Et%7D"> be its embedding. &nbsp;The objective is to maximize the log-probabilities for the<strong>forward and backward sentences conditioned on the encoder representation</strong>:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Csum%5C_t%20%5Clog%20p(w%5C_%7Bi+1%7D%5Et%20%7C%20w%5C_%7Bi+1%7D%5E%7B%3C%20t%7D,%20h%5C_i)%20+%5Csum%5C_t%20%5Clog%20p(w%5C_%7Bi-1%7D%5Et%20%7C%20w%5C_%7Bi-1%7D%5E%7B%3C%20t%7D,%20h%5C_i)"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?w%5C_%7Bi+1%7D%5E%7B%3C%20t%7D"> is the sequence of words in sentence <img src="https://latex.codecogs.com/png.latex?s%5C_i"> coming before the <img src="https://latex.codecogs.com/png.latex?t">-th words and <img src="https://latex.codecogs.com/png.latex?h%5C_i"> is the hidden state of the encoder GRU.</p>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>Thanks for reading this post! &nbsp;I‚Äôm still learning and will try to update this post if I find more interesting ideas. If you have any thoughts, please comment below.</p>


</section>

 ]]></description>
  <category>Deep Learning</category>
  <category>Machine Learning</category>
  <category>NLProc</category>
  <guid>https://ehsanmkermani.com/posts/2017-07-12-whats-up-with-word-embedding/</guid>
  <pubDate>Wed, 12 Jul 2017 00:00:00 GMT</pubDate>
</item>
<item>
  <title>From Machine Learning to Formal Math and Type Theory</title>
  <dc:creator>Ehsan M. Kermani</dc:creator>
  <link>https://ehsanmkermani.com/posts/2017-06-30-from-machine-learning-to-type-theory/</link>
  <description><![CDATA[ 





<p>The idea of this post was sparkled from the new paper<em><a href="https://arxiv.org/abs/1706.08605">Developing Bug-Free Machine Learning Systems with Formal Mathematics.</a></em>Meanwhile, I have had the idea of writing about what you‚Äôre going to readfor a long time and this paper happily forced me to do it finally! The first and final parts are about my journey and thoughts I want to write about. They may not seem directly related. If you only want to know about the paper, you can read that part.</p>
<section id="brief-history" class="level2">
<h2 class="anchored" data-anchor-id="brief-history">Brief history</h2>
<p>When I was studying Algebraic Geometry the language of category, object, morphism, functors, natural-morphism, etc. were essential in understanding modern aspects of the field as well as modern Mathematics, in general. When I switched to Computer Science I stumbled upon Functional Language and Functional Programming (FP) through Scala programming language (mainly because of Apache Spark) and I loved it. I clearly remember the moment when I realized the connections between category theory language that I was using in my Math-time and then in Computer Science, with the implementations of Functor, Monad, Moniod, etc. It was fascinating and sweet, indeed. I quickly found out that Scala has a purely functional extension called <a href="https://github.com/scalaz/scalaz">Scalaz</a>&nbsp;that even has <a href="https://github.com/1ambda/scala/blob/master/learning-scalaz/src/main/scala/yoneda/Yoneda.scala">Yoneda object</a>&nbsp;defined. It was a WOW moment! I really enjoyed understanding and applying <a href="https://en.wikipedia.org/wiki/Yoneda_lemma#Formal_statement">Yoneda lemma</a> in my Math-time.</p>
</section>
<section id="the-paper" class="level2">
<h2 class="anchored" data-anchor-id="the-paper">The paper</h2>
<p>It discusses about the a way for developers to &gt; use an<strong>interactive proof assistant</strong>to both<em>implement their system</em>and to<em>state a formal theorem</em>defining what it means for their system to be correct.</p>
<p>It is a way to close the gap between implementation errors and the formal Mathematical theory behind the implementation. The mechanism is important because when you design a machine learning system that enables you to &gt; find implementation errors<em>systematically</em>without recourse to empirical testing.</p>
<p>Basically, it gives you <a href="https://en.wikipedia.org/wiki/Formal_verification">formal verification</a> of your program. It does so by using <a href="https://github.com/leanprover/lean">Lean programming language</a>&nbsp;which is an<em>interactive proof assistant</em>as well as a programming language (<a href="https://www.youtube.com/watch?v=69ytTKfSSgc">talk</a> by the creator of Lean). I‚Äôll explain more about what interactive proof assistant does. As a case study, the author developed a system called <a href="https://github.com/dselsam/certigrad">Centigrad</a> &gt; which allows users to construct arbitrary stochastic computation graphs.<strong>Stochastic computation graph</strong>is a DAG (computation graph) having deterministic or stochastic computational units. Its<em>loss function</em>is defined as the<em>expected value</em>of sum of the leaf nodes<em>over stochastic choices</em>. Here‚Äôs an example of a simple variational autoencoder (VAE) (which is a generative model with stochastic computation graph introduced by the normal sampling layer in the middle. For more about VAE, see the nice post by <a href="http://blog.fastforwardlabs.com/2016/08/12/introducing-variational-autoencoders-in-prose-and.html">fastforwardlabs</a>) <img src="https://ehsanmkermani.com/posts/2017-06-30-from-machine-learning-to-type-theory/images/vae.png" class="img-fluid" alt="vae"> Assume that you want to develop a backpropagation algorithm for such loss function. You may also have a sketch of &nbsp;the final derivation. Also assume that we don‚Äôt have access to Tensorflow or other deeplearning frameworks that do automatic differentiation. You may even have no data!<strong>It‚Äôs you and your computer</strong>and you want to make a formal Mathematical system that does all the things for you. You can be sure that the derivation is correct formally, when your system doesn‚Äôt fail and is then<em>bug-free</em>. To do so, you‚Äôd need to define a long series of things in your system so that it can understand what the above loss function mean and how to compute backpropagration. Basically, you‚Äôd need to define real number <img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BR%7D"> type, tensors, function, differentiation operator <img src="https://latex.codecogs.com/png.latex?%5Cnabla">, differentiability, integration operator <img src="https://latex.codecogs.com/png.latex?%5Cint">, integrability, conditions such that differentiation commutes with integration, notion of distribution, sampling from a distribution, computing the expectation (monadic operation!) and more details so that the system can understand the meaning the loss function and what backpropagation supposed to do.<em>The novelty is that in Lean you can do so and it even can lead you interactively from in between steps / lemmas (aka&nbsp;tactics in Lean) to the final machine-checkable formal derivation</em>. In conclusion, the authors wrote &gt; ‚Ä¶ we were able to achieve extremely high confidence that our system was bug-free without needing to think about how all the pieces of the system fit together. In our approach, the computer‚Äî not the human‚Äîis responsible for ensuring that all the local properties that the developer establishes imply that the overall system is correct.</p>
</section>
<section id="thoughts" class="level2">
<h2 class="anchored" data-anchor-id="thoughts">Thoughts</h2>
<p>Given the initial background</p>
<ol type="1">
<li>Scala is really a good fit, if one wants to create next Lean programming language.</li>
<li>This paper lead me to read and think about&nbsp;<a href="https://en.wikipedia.org/wiki/Intuitionistic_type_theory#Extensional_versus_intensional">type theory</a>, <a href="https://en.wikipedia.org/wiki/Decision_problem">decidability</a> and <a href="https://en.wikipedia.org/wiki/Homotopy_type_theory">homotopy type theory.</a>&nbsp;Their applications and contributions to the foundations of modern Mathematics. It is truly fascinating that such abstractions not only paves the road for Mathematicians in various fields such as Algebraic Geometry, Algebraic Topology, etc. but also enables creation of computer languages to assist us in constructing proofs and verify computations formally.</li>
</ol>


</section>

 ]]></description>
  <category>Functional Programming</category>
  <category>Machine Learning</category>
  <category>Type Theory</category>
  <guid>https://ehsanmkermani.com/posts/2017-06-30-from-machine-learning-to-type-theory/</guid>
  <pubDate>Fri, 30 Jun 2017 00:00:00 GMT</pubDate>
</item>
<item>
  <title>General Monty Hall Simulation</title>
  <dc:creator>Ehsan M. Kermani</dc:creator>
  <link>https://ehsanmkermani.com/posts/2016-05-05-monty-hall-simulation/</link>
  <description><![CDATA[ 





<p>The idea of this post came up to my mind last night. I‚Äôm assuming you have already heard about the famous&nbsp;<a href="https://en.wikipedia.org/wiki/Monty_Hall_problem">Monty Hall Problem</a>&nbsp;(if you haven‚Äôt, watch the quicker intro in <a href="https://www.youtube.com/watch?v=4Lb-6rxZxx0">Numberphile clip</a>). Here I‚Äôd like to demonstrate a simulation taking the<strong>general case</strong>into account, i.e.&nbsp;assume we have <img src="https://latex.codecogs.com/png.latex?n"> bins (boxes or doors, whatever) and there‚Äôs a prize in one of them and you don‚Äôt know which one has the prize. You pick one of those bins at random and since I‚Äôm the<em>host</em>and I know where the prize is located, I‚Äôd choose <img src="https://latex.codecogs.com/png.latex?k"> boxes and discard them from the game (obviously not the prize and not your first choice, so <img src="https://latex.codecogs.com/png.latex?1%20%5Cleq%20k%20%5Cleq%20n%20-%202">). Then, I‚Äôd ask you whether you want to<em>switch</em>to another box or want to stick to your first choice. Finally, I reveal your choice and see if it contains the prize or not. &nbsp;It‚Äôs not hard to compute the probability of winning if you do switch. That‚Äôs in fact, <img src="https://latex.codecogs.com/png.latex?P(%5Ctext%7BWinning%20if%20switching%7D)%20=%20%5Cdfrac%7Bn-1%7D%7Bn(n-k-1)%7D%20%3E%20%5Cdfrac%7B1%7D%7Bn%7D=P(%5Ctext%7BWinning%20if%20not%20switching%7D)"> Thus, the<em>best strategy</em>is to always<strong>switch</strong>! Now, I‚Äôd like to confirm this with<strong>data</strong>by doing simulation in Python.<strong>Note:</strong>All codes are available in <a href="https://github.com/ehsanmok/Monty-Hall-Simulation">my github</a>&nbsp;and&nbsp;in <a href="http://nbviewer.jupyter.org/github/ehsanmok/Monty-Hall-Simulation/blob/master/monty_hall_simulation.ipynb">nbviewer</a>. So first, I create a MontyHall class representing my simulation object as follows:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> numpy.random <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> RandomState</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> random <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> sample</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> mpl_toolkits.mplot3d <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Axes3D</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> matplotlib <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> cm</span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> matplotlib.ticker <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> LinearLocator, FormatStrFormatter</span>
<span id="cb1-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb1-8"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>matplotlib inline</span>
<span id="cb1-9"></span>
<span id="cb1-10"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> MontyHall(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">object</span>):</span>
<span id="cb1-11">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb1-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Creates simulation game object</span></span>
<span id="cb1-13"></span>
<span id="cb1-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Parameters:</span></span>
<span id="cb1-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    ----------</span></span>
<span id="cb1-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    n_games:    int         Number of games</span></span>
<span id="cb1-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    n_bins:     int         Number of bins</span></span>
<span id="cb1-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    n_discards: int         Number of discard options, between 1, n_bins-2</span></span>
<span id="cb1-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    switch:     boolean     Switch or not</span></span>
<span id="cb1-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    seed:       int         Seed number</span></span>
<span id="cb1-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb1-22"></span>
<span id="cb1-23">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, n_games, n_bins, n_discards, switch<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, seed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">123</span>):</span>
<span id="cb1-24">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.n_games <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> n_games</span>
<span id="cb1-25">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.n_bins <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> n_bins</span>
<span id="cb1-26">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> n_discards <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> n_bins<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>:</span>
<span id="cb1-27">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.n_discards <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> n_discards</span>
<span id="cb1-28">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb1-29">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">raise</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">ValueError</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n_discards must be between 1 and n_bins-2"</span>)</span>
<span id="cb1-30">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.switch <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> switch</span>
<span id="cb1-31">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.seed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> seed</span>
<span id="cb1-32"></span>
<span id="cb1-33">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> set_prize(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb1-34">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">""" Set prize randomly for each game with fixed RandomState """</span></span>
<span id="cb1-35">        prng <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> RandomState(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.seed)</span>
<span id="cb1-36">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> prng.randint(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.n_bins, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.n_games)</span>
<span id="cb1-37"></span>
<span id="cb1-38">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> player_first_choice(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb1-39">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">""" Player first choice in each game with fixed</span></span>
<span id="cb1-40"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            RandomState to get same numbers in different calls</span></span>
<span id="cb1-41"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        """</span></span>
<span id="cb1-42">        prng <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> RandomState(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.seed)</span>
<span id="cb1-43">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> prng.randint(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.n_bins, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.n_games)</span>
<span id="cb1-44"></span>
<span id="cb1-45">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> player_final_choice(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb1-46">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">""" Player final choice after discarding some options by host"""</span></span>
<span id="cb1-47">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.switch:</span>
<span id="cb1-48">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.player_first_choice()</span>
<span id="cb1-49">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb1-50">            opts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.n_bins))</span>
<span id="cb1-51">            arr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.vstack([<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.player_first_choice(), <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.host_discard()])</span>
<span id="cb1-52">            final <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._col_choice(opts, arr, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb1-53">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> final</span>
<span id="cb1-54"></span>
<span id="cb1-55">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> host_discard(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb1-56">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">""" Host choice for removing n_discards bins"""</span></span>
<span id="cb1-57">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.switch:</span>
<span id="cb1-58">            opts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.n_bins))</span>
<span id="cb1-59">            arr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.vstack([<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.set_prize(), <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.player_first_choice()])</span>
<span id="cb1-60">            disc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._col_choice(opts, arr, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.n_discards)</span>
<span id="cb1-61">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> disc</span>
<span id="cb1-62"></span>
<span id="cb1-63">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _col_choice(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, opts, arr, n_disc):</span>
<span id="cb1-64">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">""" Possible choices per game"""</span></span>
<span id="cb1-65">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb1-66">            res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.apply_along_axis(</span>
<span id="cb1-67">                    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> x:</span>
<span id="cb1-68">                        sample([v <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, v <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(opts)</span>
<span id="cb1-69">                                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(x)], n_disc),</span>
<span id="cb1-70">                    axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb1-71">                    arr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>arr)</span>
<span id="cb1-72">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> res</span>
<span id="cb1-73">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span>:</span>
<span id="cb1-74">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.n_discards, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'must be less than'</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.n_bins <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb1-75"></span>
<span id="cb1-76">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> score(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb1-77">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">""" Calculate the number of wins"""</span></span>
<span id="cb1-78">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.player_final_choice() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.set_prize())</span>
<span id="cb1-79"></span>
<span id="cb1-80">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> proba(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb1-81">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">""" Compute the winning probability"""</span></span>
<span id="cb1-82">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.score() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.n_games</span>
<span id="cb1-83"></span>
<span id="cb1-84">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__str__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb1-85">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.switch:</span>
<span id="cb1-86">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Probability of winning if not switching: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%.4f</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb1-87">                <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.proba()</span>
<span id="cb1-88">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb1-89">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Probability of winning if switching: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%.4f</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb1-90">                <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.proba()</span></code></pre></div></div>
<p>Now, for example, we can confirm the famous Monty Hall result by defining</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> simulation_proba(n_games, n_bins, n_discards, switch):</span>
<span id="cb2-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">""" Compute simulation probability of n_games with n_bins</span></span>
<span id="cb2-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        and n_discards options</span></span>
<span id="cb2-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb2-5">    g <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> MontyHall(n_games<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n_games, n_bins<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n_bins, n_discards<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n_discards, switch<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>switch)</span>
<span id="cb2-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> g.proba()</span></code></pre></div></div>
<p>and then calling&nbsp;<code>print(simulation_proba(100000, 3, 1, switch=True))</code>&nbsp;we‚Äôll get <img src="https://latex.codecogs.com/png.latex?0.6665%20%5Csimeq%20%5Cdfrac%2023"> as the winning probability if you switch, if you were to play the game <img src="https://latex.codecogs.com/png.latex?100,000"> times and record all the results for the case where <img src="https://latex.codecogs.com/png.latex?n%20=%203,%20k%20=%201."> Let‚Äôs see the results for <img src="https://latex.codecogs.com/png.latex?n%20=%204,%20k%20=%201,%202"></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(simulation_proba(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100000</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, switch<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>))</span>
<span id="cb3-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 0.3746</span></span>
<span id="cb3-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(simulation_proba(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100000</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, switch<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>))</span>
<span id="cb3-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 0.2500</span></span>
<span id="cb3-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(simulation_proba(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100000</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, switch<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>))</span>
<span id="cb3-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 0.7500</span></span>
<span id="cb3-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(simulation_proba(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100000</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, switch<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>))</span>
<span id="cb3-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 0.2499</span></span></code></pre></div></div>
<p>Okay! to better see the results, let‚Äôs plot the probabilities against the number of bins.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb4-2"></span>
<span id="cb4-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> simulation_2dplot(n_games, max_bins, n_discards<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, switch<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>):</span>
<span id="cb4-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">""" Simulation 2D plot"""</span></span>
<span id="cb4-5">    X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(n_discards<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, max_bins))</span>
<span id="cb4-6">    Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array([simulation_proba(n_games, b, n_discards, switch) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> b <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> X])</span>
<span id="cb4-7">    plt.plot(X, Y, linestyle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'-'</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'b'</span>, lw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb4-8">    plt.xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Number of Bins'</span>)</span>
<span id="cb4-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> switch:</span>
<span id="cb4-10">        plt.ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Winning Probability after switching'</span>)</span>
<span id="cb4-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb4-12">        plt.ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Winning Probability if not switching'</span>)</span>
<span id="cb4-13">    plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Monty Hall Simulation with </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%d</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> games and </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%d</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> discards'</span></span>
<span id="cb4-14">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> (n_games, n_discards))</span>
<span id="cb4-15">    plt.ylim(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>)</span>
<span id="cb4-16">    plt.savefig(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'simulation_2dplot.png'</span>, dpi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>)</span>
<span id="cb4-17">    plt.show()</span>
<span id="cb4-18"></span>
<span id="cb4-19">simulation_2dplot(n_games<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, max_bins<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span>, n_discards<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, switch<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span></code></pre></div></div>
<p><img src="https://ehsanmkermani.com/posts/2016-05-05-monty-hall-simulation/images/simulation_2dplot2.png" class="img-fluid" alt="simulation_2dplot.png"> or even with <img src="https://latex.codecogs.com/png.latex?20"> discard options! <img src="https://ehsanmkermani.com/posts/2016-05-05-monty-hall-simulation/images/simulation_2dplot3.png" class="img-fluid" alt="simulation_2dplot.png"></p>
<section id="monty-hall-surface" class="level2">
<h2 class="anchored" data-anchor-id="monty-hall-surface"><strong>Monty Hall Surface</strong></h2>
<p>Now, let‚Äôs see what the 3D surface plot looks like.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> matplotlib <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> cm</span>
<span id="cb5-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> matplotlib.ticker <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> LinearLocator, FormatStrFormatter</span>
<span id="cb5-3"></span>
<span id="cb5-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> simulation_3dplot(n_games, max_bins, max_discards, switch):</span>
<span id="cb5-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">""" Simulation 3D plot"""</span></span>
<span id="cb5-6">    X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, max_bins))</span>
<span id="cb5-7">    Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, max_discards))</span>
<span id="cb5-8">    X_grid, Y_grid <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.meshgrid(X, Y)</span>
<span id="cb5-9">    triu_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.triu_indices(n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>max_discards<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb5-10">    X_grid_utri, Y_grid_utri <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> X_grid[triu_idx], Y_grid[triu_idx]</span>
<span id="cb5-11"></span>
<span id="cb5-12">    vect_simulation_proba <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.vectorize(simulation_proba)</span>
<span id="cb5-13">    Z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> vect_simulation_proba(n_games, X_grid_utri, Y_grid_utri, switch)</span>
<span id="cb5-14">    nZ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.zeros((max_discards<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, max_discards<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb5-15">    nZ[triu_idx] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Z</span>
<span id="cb5-16"></span>
<span id="cb5-17">    fig <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>))</span>
<span id="cb5-18">    ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fig.gca(projection<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'3d'</span>)</span>
<span id="cb5-19">    surf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ax.plot_surface(X_grid, Y_grid, nZ, rstride<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, cstride<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>cm.coolwarm, linewidth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, antialiased<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb5-20">    ax.set_zlim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>)</span>
<span id="cb5-21">    ax.set_xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Number of Bins'</span>)</span>
<span id="cb5-22">    ax.set_ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Number of Discards'</span>)</span>
<span id="cb5-23">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> switch:</span>
<span id="cb5-24">        ax.set_zlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Winning probability after switching'</span>)</span>
<span id="cb5-25">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb5-26">        ax.set_zlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Winning probability if not switching'</span>)</span>
<span id="cb5-27">    ax.zaxis.set_major_locator(LinearLocator(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>))</span>
<span id="cb5-28">    ax.zaxis.set_major_formatter(FormatStrFormatter(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'%.02f'</span>))</span>
<span id="cb5-29">    ax.set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Monty Hall Probability Surface for </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%d</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> games'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> n_games)</span>
<span id="cb5-30"></span>
<span id="cb5-31">    fig.colorbar(surf, shrink<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, aspect<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb5-32"></span>
<span id="cb5-33">    fig.savefig(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'3d_simulation.png'</span>, dpi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>)</span>
<span id="cb5-34">    plt.show()</span>
<span id="cb5-35"></span>
<span id="cb5-36">simulation_3dplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>, switch<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span></code></pre></div></div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://ehsanmkermani.com/posts/2016-05-05-monty-hall-simulation/images/3d_simulation2.png" class="img-fluid figure-img"></p>
<figcaption>3d_simulation</figcaption>
</figure>
</div>


</section>

 ]]></description>
  <category>Python</category>
  <category>Statistics</category>
  <guid>https://ehsanmkermani.com/posts/2016-05-05-monty-hall-simulation/</guid>
  <pubDate>Thu, 05 May 2016 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Restaurant Revenue Prediction with BART Machine</title>
  <dc:creator>Ehsan M. Kermani</dc:creator>
  <link>https://ehsanmkermani.com/posts/2015-09-13-restaurant-revenue-prediction-with-bart-machine/</link>
  <description><![CDATA[ 





<p>In this post, I‚Äôd like to show you how to use the newly written package on<strong>Bayesian Additive Regression Trees</strong><em>i.e.</em><a href="https://cran.rproject.org/web/packages/bartMachine/bartMachine.pdf">BART Machine</a> for Restaurant Revenue Prediction with<strong>R</strong>. The datasets are part of the passed Kaggle competition that can be found <a href="https://www.kaggle.com/c/restaurant-revenue-prediction/data">here.</a><strong>What is BART?</strong>BART is the Bayesian sibling of <a href="https://en.wikipedia.org/wiki/Random_forest">Random Forest</a>. For some applications, Bayesian approaches with probabilistic assumptions work better than pure algorithmic ensemble of trees due to underlying<em>prior assumptions</em>. BART utilizes prior assumptions for parameters estimate and splits that occur in classic tree models. There are multiple distinctions between BART and Random Forest. One is the user defined ability to set generalized Bernoulli priors on features to be selected for each split, whereas in Random Forest, this prior is uniform on features. The other ones are having multiple hyperparameters controlling the growth of trees more than Random Forest and the ability to find<em>explicit interactions</em>among features, which can hardly be found in general Machine/Statistical learning algorithms/models.<strong>BART in action</strong>Speaking of competition, <a href="http://www.kaggle.com/c/restaurant-revenue-prediction">TFI</a> has been one of the most unusual Kaggle competitions so far and has confused and hurt many contestants as well as myself because of the following reasons:</p>
<p>Great disparity among the number of training and testing samples. The training set has 137 samples with 37 obfuscated features out of 42 with the<em>revenue</em>as the response variable. The test set has 100,000 samples (poisoned data and robust model indications!).</p>
<p>It was very hard to get consistent cross-validation scores even with repeated CV.</p>
<p>Almost all of the features are weak and some are incompatible in train and test sets.<em>Many</em>of the top seed Kaggle Masters did poorly in this competition which adds to its strangeness and perhaps if you knew less, you could have been more successful in this competition! So, let‚Äôs briefly look at the data first;</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1">data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read.csv</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'train.csv'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sep=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">','</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">stringsAsFactor=</span>F)</span>
<span id="cb1-2">test <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read.csv</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'test.csv'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sep=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">','</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">stringsAsFactor=</span>F)</span>
<span id="cb1-3">revenue <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>revenue</span>
<span id="cb1-4">train <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> data[,<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ncol</span>(data)]</span>
<span id="cb1-5">all <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbind</span>(train, test)</span></code></pre></div></div>
<p>As you go through exploring<em>all</em>dataset, you will figure out many odd cases, like the feature<em>City</em>, the number of unique cities used in training set <code>length(unique(data$City))</code> is 34 whereas the number of unique cities used in test set is 57. You can check the <a href="https://www.kaggle.com/c/restaurant-revenue-prediction/forums">forum</a> to see more odd cases. Of course, these cases could happen in real data science and everyone should now how to handle them. This post, however, does not deal with that kind of behaviors. By plotting the histogram of<em>revenue</em>, one can see its skewness easily, so the natural <code>log(revenue)</code> better demonstrates its (nearly) log normal distribution and perhaps suggests existence of<em>outliers</em>.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb2-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>revenue),</span>
<span id="cb2-3">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">geom=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"histogram"</span>,</span>
<span id="cb2-4">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">binwidth=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>,</span>
<span id="cb2-5">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">main=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Histogram of Revenue"</span>,</span>
<span id="cb2-6">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"revenue"</span>,</span>
<span id="cb2-7">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">I</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>),</span>
<span id="cb2-8">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">I</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>))</span></code></pre></div></div>
<p><a href="https://ehsanmkermani.com/wp-content/uploads/2015/09/log_rev_hist1.png"><img src="https://ehsanmkermani.com/posts/2015-09-13-restaurant-revenue-prediction-with-bart-machine/images/log_rev_hist1.png" class="img-fluid" alt="log_rev_hist"></a> To plot the correlations among (numeric) features and the response, we can use the <code>corrplot</code> package</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(corrplot)</span>
<span id="cb3-2">correlations <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cor</span>(data[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">43</span>])</span>
<span id="cb3-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">corrplot</span>(correlations, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ellipse"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">order=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hclust"</span>)</span></code></pre></div></div>
<p><a href="https://ehsanmkermani.com/wp-content/uploads/2015/09/correlations.png"><img src="https://ehsanmkermani.com/posts/2015-09-13-restaurant-revenue-prediction-with-bart-machine/images/correlations.png" class="img-fluid" alt="correlations"></a> Before going further, I‚Äôd like to emphasize that when the data is small, it‚Äôs very likely to find some seemingly good complicated<em>interactions</em>among features, for example, by looking at the p-values for a simple linear regression and by tweaking couple of significant ones, I found a (good-turn-out-to-be-useless) interaction between <code>logRevenue~I(P6*P20)+P28+I(P28^2)+Age+I(Age^2)</code> , including<em>Age</em>of the restaurant, which at the time, I thought it might be a good feature to add, but the <a href="https://www.kaggle.com/c/restaurant-revenue-prediction/forums/t/14066/winning-solution">deserved winner argued the opposite!</a> Now, let‚Äôs dig into bartMachine. First, I‚Äôm going to throw out the incompatible features including<em>Open.Date, City, City.Group, Type</em>as well as<em>Id</em>to make our training and testing sets unified and initialize the bartMachine as follows;</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">SEED <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">123</span></span>
<span id="cb4-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(SEED)</span>
<span id="cb4-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">options</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">java.parameters=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-Xmx5000m"</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># must be set initially</span></span>
<span id="cb4-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(bartMachine)</span>
<span id="cb4-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_bart_machine_num_cores</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb4-6">y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(revenue)</span>
<span id="cb4-7">X <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> all[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(train), <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)]</span>
<span id="cb4-8">X_test <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> all[(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(train)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(all), <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)]</span>
<span id="cb4-9">bart <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bartMachine</span>(X, y, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">num_trees=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seed=</span>SEED) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># default num_trees might be excessive</span></span></code></pre></div></div>
<p>The results are &gt; bartMachine v1.2.0 for regression &gt; training data n = 137 and p = 37 &gt; built in 0.3 secs on 4 cores, 10 trees, 250 burn-in and 1000 post. samples &gt; sigsq est for y beforehand: 0.159 &gt; avg sigsq estimate after burn-in: 0.19178 &gt; in-sample statistics: &gt; L1 = 41.5 &gt; L2 = 22.15 &gt; rmse = 0.4 &gt; Pseudo-Rsq = 0.2953 &gt; p-val for shapiro-wilk test of normality of residuals: 0.08099 &gt; p-val for zero-mean noise: 0.97545</p>
<p>We can also see the effect of changing the <code>num_trees</code> parameter by</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rmse_by_num_trees</span>(bart,</span>
<span id="cb5-2">                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tree_list=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)),</span>
<span id="cb5-3">                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">num_replicates=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span></code></pre></div></div>
<p><a href="https://ehsanmkermani.com/wp-content/uploads/2015/09/rmse_num_trees_bart.png"><img src="https://ehsanmkermani.com/posts/2015-09-13-restaurant-revenue-prediction-with-bart-machine/images/rmse_num_trees_bart.png" class="img-fluid" alt="rmse_num_trees_bart"></a> So perhaps <code>num_trees=20</code> works better with less out-of-sample error. As,<em>bartMachine</em>is essentially doing MCMC and heavily using Gibbs sampler, checking convergence seems necessary (see the above paper for more details);</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">bart <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bartMachine</span>(X, y, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">num_trees=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seed=</span>SEED)</span>
<span id="cb6-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_convergence_diagnostics</span>(bart)</span></code></pre></div></div>
<p><a href="https://ehsanmkermani.com/wp-content/uploads/2015/09/plot_conv_bart.png"><img src="https://ehsanmkermani.com/posts/2015-09-13-restaurant-revenue-prediction-with-bart-machine/images/plot_conv_bart.png" class="img-fluid" alt="plot_conv_bart"></a> We can also check mean-centeredness assumption and heteroskedasticity of the data by the QQ-plot</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">check_bart_error_assumptions</span>(bart)</span></code></pre></div></div>
<p><a href="https://ehsanmkermani.com/wp-content/uploads/2015/09/check_assumption_bart.png"><img src="https://ehsanmkermani.com/posts/2015-09-13-restaurant-revenue-prediction-with-bart-machine/images/check_assumption_bart.png" class="img-fluid" alt="check_assumption_bart"></a> One of the main features of bartMachine is showing variable importance via permutation tests</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">var_selection_by_permute</span>(bart, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">num_reps_for_avg=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)</span></code></pre></div></div>
<p><a href="https://ehsanmkermani.com/wp-content/uploads/2015/09/var_imp_bart.png"><img src="https://ehsanmkermani.com/posts/2015-09-13-restaurant-revenue-prediction-with-bart-machine/images/var_imp_bart.png" class="img-fluid" alt="var_imp_bart"></a> Moreover, bartMachine is capable of finding explicit interactions among feature</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">interaction_investigate</span>(bart, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">num_replicates_for_avg=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span></code></pre></div></div>
<p><a href="https://ehsanmkermani.com/wp-content/uploads/2015/09/interaction_bart.png"><img src="https://ehsanmkermani.com/posts/2015-09-13-restaurant-revenue-prediction-with-bart-machine/images/interaction_bart.png" class="img-fluid" alt="interaction_bart"></a> However, since we want a simple model to start and score well in the poisoned test set, focusing too much on interactions can hurt a lot, as happened to me by inevitable overfitting. Now, I‚Äôm going to pick<em>P20, P17, P6</em>and retrain my model and perform a CV and finally submit it.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1">nX <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> X[, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"P6"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"P17"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"P28"</span>)]</span>
<span id="cb10-2">nX_test <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> X_test[, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"P6"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"P17"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"P28"</span>)]</span>
<span id="cb10-3">nbart <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bartMachine</span>(nX, y, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">num_trees=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seed=</span>SEED)</span>
<span id="cb10-4">nbart_cv <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bartMachineCV</span>(nX, y, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">num_tree_cvs=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>),</span>
<span id="cb10-5">                          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">k_folds=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,</span>
<span id="cb10-6">                          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">verbose=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># bartMachine CV win: k: 3 nu, q: 3, 0.9 m: 20</span></span>
<span id="cb10-7"></span>
<span id="cb10-8">log_pred <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(nbart_cv, nX_test)</span>
<span id="cb10-9">pred <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(log_pred)</span>
<span id="cb10-10">submit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Id=</span>test<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Id, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Prediction =</span> pred)</span>
<span id="cb10-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write.csv</span>(submit, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bartMachine_P6P17P28.csv"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">row.names=</span>F)</span></code></pre></div></div>
<p>The result of this submission, is 1731437.14026 in public and 1839841.77388 (ranks around<strong>700</strong>out of 2257 teams) in private leaderboards.</p>
<section id="rank-below-100-out-of-2257" class="level2">
<h2 class="anchored" data-anchor-id="rank-below-100-out-of-2257">Rank below 100 out of 2257:</h2>
<p>To improve our model and make it more robust, we should remove outliers by deciding what threshold to use perhaps with some trial-and-error first, though there‚Äôre many methods that can be helpful, which is not within the scope of this post. Looking at the <code>log(revenue)</code> distribution should suggest where you should put the threshold. Doing so, it can hugely boost your private leaderboard ranking to position around<strong>80</strong>with score 1786605.94364 which is a fairly good incentive to explore bartMachine more. You can find the codes including the<em>improved model</em>and plots in <a href="https://github.com/ehsanmok/bartMachine-tutorial">my github</a>. Enjoy! P.S. During the competition, the BAYZ,M.D team managed to make a<em>perfect overfit</em>on the public leaderboard with interesting and creative methods. You can read more about that <a href="https://www.kaggle.com/c/restaurant-revenue-prediction/forums/t/13950/our-perfect-submission">here</a>.</p>


</section>

 ]]></description>
  <category>Machine Learning</category>
  <category>R</category>
  <category>Statistics</category>
  <guid>https://ehsanmkermani.com/posts/2015-09-13-restaurant-revenue-prediction-with-bart-machine/</guid>
  <pubDate>Sun, 13 Sep 2015 00:00:00 GMT</pubDate>
</item>
</channel>
</rss>
